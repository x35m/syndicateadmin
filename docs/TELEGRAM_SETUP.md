# Telegram Integration Setup

Этот файл описывает, как включить импорт публикаций из публичных Telegram-каналов.

## 1. Получите Telegram API credentials

1. Перейдите на [https://my.telegram.org](https://my.telegram.org)
2. Войдите по номеру телефона
3. Откройте «API development tools»
4. Создайте приложение и сохраните `api_id` и `api_hash`

## 2. Подготовьте session string

Telegram API требует авторизованную сессию. В репозитории есть вспомогательный скрипт:

```bash
npm run telegram:auth
```

Скрипт запросит:

- номер телефона в международном формате;
- одноразовый код из Telegram;
- пароль 2FA (если включён).

На выходе вы получите строку `TELEGRAM_SESSION`. Сохраните её — она заменяет файл сессии, нельзя публиковать в репозитории.

## 3. Настройте окружение

Добавьте переменные в `.env.local` (или через Railway variables):

```env
TELEGRAM_API_ID=123456
TELEGRAM_API_HASH=abcdef0123456789abcdef0123456789
# Необязательно: можно хранить session в env, но рекомендуем вводить через админку
TELEGRAM_SESSION=1A2B3C...
TELEGRAM_FETCH_LIMIT=50          # сколько сообщений брать за один проход
TELEGRAM_LOOKBACK_HOURS=48       # окно поиска, если канал ещё не запускался
```

> **Важно:** если вы сохраняете session в БД через админку (`/admin/settings`), переменная `TELEGRAM_SESSION` не обязательна.

## 4. Заполните настройки в админке

1. Откройте `/admin/settings`
2. В блоке «Интеграция Telegram» укажите:
   - API ID и API Hash (можно оставить пустыми, если заданы в `.env`)
   - Session string, полученную на шаге 2
   - Количество сообщений за проход (например, 50)
3. Сохраните настройки — сессия кэшируется на сервере автоматически

## 5. Добавьте каналы

1. Перейдите в `/admin/telegram`
2. Добавьте публичный канал по username (без `@`)
3. Включите/выключите канал или выполните ручное обновление (кнопка «Обновить»)
4. Cron-задача будет автоматически забирать новые публикации и складывать их в раздел «Материалы»

## 6. Повторная авторизация

Если session истёк или была отозвана:

1. Снова выполните `npm run telegram:auth`
2. Обновите значение в админке или `.env`
3. Сохраните настройки — клиент перезапустится автоматически

## 7. Troubleshooting

| Проблема | Решение |
| --- | --- |
| `Telegram session недействительна` | Перегенерируйте session string через `npm run telegram:auth` и обновите настройки |
| `CHANNEL_PRIVATE` или `USERNAME_NOT_OCCUPIED` | Канал приватный/удалён или указан неверный username |
| FloodWaitError | Telegram ограничил частоту запросов. Уменьшите количество каналов или частоту запусков |
| Ничего не импортируется | Убедитесь, что канал активен, и в настройках указан корректный session |

## 8. Рекомендации по безопасности

- Не коммитьте session string и `.env` в репозиторий
- Ограничьте доступ к админке через авторизацию
- При утечке session просто сгенерируйте новую — старая станет недействительной

Готово! После выполнения шагов cron начнёт импортировать Telegram-каналы вместе с RSS. Проверяйте логи (`/admin/logs`) при первых запусках.

