"use strict";exports.id=4484,exports.ids=[4484],exports.modules={5376:(t,e,i)=>{i.d(e,{D8:()=>s,EQ:()=>r,ER:()=>a});let s=1,a={import:{enabled:!1,intervalMinutes:30,scope:"all",feedIds:[],lastRunAt:null},processing:{enabled:!1,intervalMinutes:15,batchSize:5,lastRunAt:null},publishing:{enabled:!1,intervalMinutes:60,scope:"all",categoryIds:[],batchSize:10,lastRunAt:null}};function n(t){return"selected"===t?"selected":"all"}function r(t){return t?{import:function(t){let e=Math.max(s,Math.trunc(t?.intervalMinutes??30)),i=n(t?.scope),a=Array.isArray(t?.feedIds)?Array.from(new Set(t.feedIds.map(t=>Number(t)).filter(t=>!Number.isNaN(t)&&t>0))):[];return{enabled:!!t?.enabled,intervalMinutes:e,scope:i,feedIds:a,lastRunAt:t?.lastRunAt??null}}(t.import),processing:function(t){let e=Math.max(s,Math.trunc(t?.intervalMinutes??15)),i=Math.max(1,Math.trunc(t?.batchSize??5));return{enabled:!!t?.enabled,intervalMinutes:e,batchSize:i,lastRunAt:t?.lastRunAt??null}}(t.processing),publishing:function(t){let e=Math.max(s,Math.trunc(t?.intervalMinutes??60)),i=n(t?.scope),a=Array.isArray(t?.categoryIds)?Array.from(new Set(t.categoryIds.map(t=>Number(t)).filter(t=>!Number.isNaN(t)&&t>0))):[],r=Math.max(1,Math.trunc(t?.batchSize??10));return{enabled:!!t?.enabled,intervalMinutes:e,scope:i,categoryIds:a,batchSize:r,lastRunAt:t?.lastRunAt??null}}(t.publishing)}:JSON.parse(JSON.stringify(a))}},4484:(t,e,i)=>{i.r(e),i.d(e,{initAutomationScheduler:()=>g,refreshAutomationScheduler:()=>f});var s=i(9487),a=i(7328),n=i(7435),r=i(5376);let l="true"===process.env.AUTOMATION_DISABLED,o=process.env.AUTOMATION_API_BASE||process.env.INTERNAL_API_BASE||process.env.NEXT_PUBLIC_APP_URL||`http://127.0.0.1:${process.env.PORT||3e3}`;async function c(t,e){let i=new URL(t,o),s=await fetch(i.toString(),{...e,cache:"no-store",headers:{"Content-Type":"application/json",...e.headers??{}}}),a=await s.text(),n=null;try{n=a?JSON.parse(a):null}catch{n=a}if(!s.ok||n&&!1===n.success)throw Error(n?.error||s.statusText||"Internal API call failed");return n}class u{async init(){if(l){console.warn("[automation] Scheduler disabled via AUTOMATION_DISABLED=true");return}await this.reloadConfig(),this.scheduleAll()}async reloadConfig(){try{let t=await s.db.getAutomationConfig();this.config=(0,r.EQ)(t)}catch(t){console.error("[automation] Failed to load automation config:",t),this.config=JSON.parse(JSON.stringify(r.ER))}}async refresh(){await this.reloadConfig(),this.scheduleAll()}scheduleAll(){this.clearTimers(),this.scheduleImport(),this.scheduleProcessing(),this.schedulePublishing()}clearTimers(){for(let t of Object.keys(this.timers)){let e=this.timers[t];e&&(clearInterval(e),this.timers[t]=void 0)}}scheduleImport(){if(!this.config.import.enabled)return;let t=6e4*Math.max(this.config.import.intervalMinutes,r.D8);this.timers.import=setInterval(()=>{this.executeWithLock("import",()=>this.runImport())},t)}scheduleProcessing(){if(!this.config.processing.enabled)return;let t=6e4*Math.max(this.config.processing.intervalMinutes,r.D8);this.timers.processing=setInterval(()=>{this.executeWithLock("processing",()=>this.runProcessing())},t)}schedulePublishing(){if(!this.config.publishing.enabled)return;let t=6e4*Math.max(this.config.publishing.intervalMinutes,r.D8);this.timers.publishing=setInterval(()=>{this.executeWithLock("publishing",()=>this.runPublishing())},t)}async executeWithLock(t,e){if(!l&&!this.locks[t]){this.locks[t]=!0;try{await e(),await this.markLastRun(t)}catch(e){await (0,n.r)(`automation/${t}`,e)}finally{this.locks[t]=!1}}}async markLastRun(t){let e=new Date().toISOString(),i=(0,r.EQ)(await s.db.getAutomationConfig());i[t].lastRunAt=e,await s.db.setAutomationConfig(i),this.config=i}async runImport(){try{if("selected"===this.config.import.scope){let t=this.config.import.feedIds;if(0===t.length)return;let e=(await s.db.getFeedsByIds(t)).filter(t=>"active"===t.status).map(t=>t.id);if(0===e.length)return;await (0,a.fetchAndSaveMaterials)({feedIds:e})}else await (0,a.fetchAndSaveMaterials)()}catch(t){throw t}}async runProcessing(){let t=Math.max(1,this.config.processing.batchSize),e=await s.db.getMaterialIdsByStatus("new",t);if(0!==e.length)for(let t of e)try{await c("/api/materials/generate-summary",{method:"POST",body:JSON.stringify({materialId:t})})}catch(e){await (0,n.r)("automation/processing-item",e,{materialId:t})}}async runPublishing(){let t=Math.max(1,this.config.publishing.batchSize),e=[];if(0===(e="selected"===this.config.publishing.scope?this.config.publishing.categoryIds:await s.db.getVisibleCategoryIds()).length)return;let i=await s.db.getMaterialIdsForPublishing(e,t);if(0!==i.length)for(let t of i)try{await c("/api/materials",{method:"PATCH",body:JSON.stringify({id:t,status:"published"})})}catch(e){await (0,n.r)("automation/publishing-item",e,{materialId:t})}}constructor(){this.config=JSON.parse(JSON.stringify(r.ER)),this.timers={},this.locks={import:!1,processing:!1,publishing:!1}}}let h=null,d=null;async function g(){l||(h||(d=(h=new u).init()),await d)}async function f(){if(!l){if(!h){await g();return}await h.refresh()}}}};