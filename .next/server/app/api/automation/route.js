"use strict";(()=>{var e={};e.id=762,e.ids=[762,4484],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},9261:e=>{e.exports=require("postcss")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},2365:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>A,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>y,staticGenerationAsyncStorage:()=>b});var s={};i.r(s),i.d(s,{GET:()=>d,POST:()=>g,dynamic:()=>p});var r=i(9303),a=i(8716),n=i(670),o=i(7070),l=i(9487),u=i(7435),c=i(4484),h=i(5376);let p="force-dynamic";async function d(){try{let e=await l.db.getAutomationConfig(),t=(0,h.EQ)(e);return o.NextResponse.json({success:!0,data:t})}catch(e){return console.error("Error fetching automation config:",e),await (0,u.r)("api/automation",e,{method:"GET"}),o.NextResponse.json({success:!1,error:"Не удалось получить настройки автоматизации"},{status:500})}}async function g(e){try{let t=await e.json(),i=(0,h.EQ)(t??h.ER),s=i.import.enabled&&"selected"===i.import.scope&&0===i.import.feedIds.length?"Выберите хотя бы один активный фид для автоимпорта":i.processing.enabled&&i.processing.batchSize<=0?"Размер пакета для автообработки должен быть больше нуля":i.publishing.enabled&&"selected"===i.publishing.scope&&0===i.publishing.categoryIds.length?"Выберите хотя бы одну категорию для автопубликации":i.publishing.enabled&&i.publishing.batchSize<=0?"Размер пакета для автопубликации должен быть больше нуля":null;if(s)return o.NextResponse.json({success:!1,error:s},{status:400});return await l.db.setAutomationConfig(i),await (0,c.refreshAutomationScheduler)(),o.NextResponse.json({success:!0,data:i})}catch(e){return console.error("Error updating automation config:",e),await (0,u.r)("api/automation",e,{method:"POST"}),o.NextResponse.json({success:!1,error:"Не удалось сохранить настройки автоматизации"},{status:500})}}let m=new r.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/automation/route",pathname:"/api/automation",filename:"route",bundlePath:"app/api/automation/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/automation/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:b,serverHooks:y}=m,A="/api/automation/route";function x(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:b})}},5376:(e,t,i)=>{i.d(t,{D8:()=>s,EQ:()=>n,ER:()=>r});let s=1,r={import:{enabled:!1,intervalMinutes:30,scope:"all",feedIds:[],lastRunAt:null},processing:{enabled:!1,intervalMinutes:15,batchSize:5,lastRunAt:null},publishing:{enabled:!1,intervalMinutes:60,scope:"all",categoryIds:[],batchSize:10,lastRunAt:null}};function a(e){return"selected"===e?"selected":"all"}function n(e){return e?{import:function(e){let t=Math.max(s,Math.trunc(e?.intervalMinutes??30)),i=a(e?.scope),r=Array.isArray(e?.feedIds)?Array.from(new Set(e.feedIds.map(e=>Number(e)).filter(e=>!Number.isNaN(e)&&e>0))):[];return{enabled:!!e?.enabled,intervalMinutes:t,scope:i,feedIds:r,lastRunAt:e?.lastRunAt??null}}(e.import),processing:function(e){let t=Math.max(s,Math.trunc(e?.intervalMinutes??15)),i=Math.max(1,Math.trunc(e?.batchSize??5));return{enabled:!!e?.enabled,intervalMinutes:t,batchSize:i,lastRunAt:e?.lastRunAt??null}}(e.processing),publishing:function(e){let t=Math.max(s,Math.trunc(e?.intervalMinutes??60)),i=a(e?.scope),r=Array.isArray(e?.categoryIds)?Array.from(new Set(e.categoryIds.map(e=>Number(e)).filter(e=>!Number.isNaN(e)&&e>0))):[],n=Math.max(1,Math.trunc(e?.batchSize??10));return{enabled:!!e?.enabled,intervalMinutes:t,scope:i,categoryIds:r,batchSize:n,lastRunAt:e?.lastRunAt??null}}(e.publishing)}:JSON.parse(JSON.stringify(r))}},4484:(e,t,i)=>{i.r(t),i.d(t,{initAutomationScheduler:()=>d,refreshAutomationScheduler:()=>g});var s=i(9487),r=i(7328),a=i(7435),n=i(5376);let o="true"===process.env.AUTOMATION_DISABLED,l=process.env.AUTOMATION_API_BASE||process.env.INTERNAL_API_BASE||process.env.NEXT_PUBLIC_APP_URL||`http://127.0.0.1:${process.env.PORT||3e3}`;async function u(e,t){let i=new URL(e,l),s=await fetch(i.toString(),{...t,cache:"no-store",headers:{"Content-Type":"application/json",...t.headers??{}}}),r=await s.text(),a=null;try{a=r?JSON.parse(r):null}catch{a=r}if(!s.ok||a&&!1===a.success)throw Error(a?.error||s.statusText||"Internal API call failed");return a}class c{async init(){if(o){console.warn("[automation] Scheduler disabled via AUTOMATION_DISABLED=true");return}await this.reloadConfig(),this.scheduleAll()}async reloadConfig(){try{let e=await s.db.getAutomationConfig();this.config=(0,n.EQ)(e)}catch(e){console.error("[automation] Failed to load automation config:",e),this.config=JSON.parse(JSON.stringify(n.ER))}}async refresh(){await this.reloadConfig(),this.scheduleAll()}scheduleAll(){this.clearTimers(),this.scheduleImport(),this.scheduleProcessing(),this.schedulePublishing()}clearTimers(){for(let e of Object.keys(this.timers)){let t=this.timers[e];t&&(clearInterval(t),this.timers[e]=void 0)}}scheduleImport(){if(!this.config.import.enabled)return;let e=6e4*Math.max(this.config.import.intervalMinutes,n.D8);this.timers.import=setInterval(()=>{this.executeWithLock("import",()=>this.runImport())},e)}scheduleProcessing(){if(!this.config.processing.enabled)return;let e=6e4*Math.max(this.config.processing.intervalMinutes,n.D8);this.timers.processing=setInterval(()=>{this.executeWithLock("processing",()=>this.runProcessing())},e)}schedulePublishing(){if(!this.config.publishing.enabled)return;let e=6e4*Math.max(this.config.publishing.intervalMinutes,n.D8);this.timers.publishing=setInterval(()=>{this.executeWithLock("publishing",()=>this.runPublishing())},e)}async executeWithLock(e,t){if(!o&&!this.locks[e]){this.locks[e]=!0;try{await t(),await this.markLastRun(e)}catch(t){await (0,a.r)(`automation/${e}`,t)}finally{this.locks[e]=!1}}}async markLastRun(e){let t=new Date().toISOString(),i=(0,n.EQ)(await s.db.getAutomationConfig());i[e].lastRunAt=t,await s.db.setAutomationConfig(i),this.config=i}async runImport(){try{if("selected"===this.config.import.scope){let e=this.config.import.feedIds;if(0===e.length)return;let t=(await s.db.getFeedsByIds(e)).filter(e=>"active"===e.status).map(e=>e.id);if(0===t.length)return;await (0,r.fetchAndSaveMaterials)({feedIds:t})}else await (0,r.fetchAndSaveMaterials)()}catch(e){throw e}}async runProcessing(){let e=Math.max(1,this.config.processing.batchSize),t=await s.db.getMaterialIdsByStatus("new",e);if(0!==t.length)for(let e of t)try{await u("/api/materials/generate-summary",{method:"POST",body:JSON.stringify({materialId:e})})}catch(t){await (0,a.r)("automation/processing-item",t,{materialId:e})}}async runPublishing(){let e=Math.max(1,this.config.publishing.batchSize),t=[];if(0===(t="selected"===this.config.publishing.scope?this.config.publishing.categoryIds:await s.db.getVisibleCategoryIds()).length)return;let i=await s.db.getMaterialIdsForPublishing(t,e);if(0!==i.length)for(let e of i)try{await u("/api/materials",{method:"PATCH",body:JSON.stringify({id:e,status:"published"})})}catch(t){await (0,a.r)("automation/publishing-item",t,{materialId:e})}}constructor(){this.config=JSON.parse(JSON.stringify(n.ER)),this.timers={},this.locks={import:!1,processing:!1,publishing:!1}}}let h=null,p=null;async function d(){o||(h||(p=(h=new c).init()),await p)}async function g(){if(!o){if(!h){await d();return}await h.refresh()}}}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),s=t.X(0,[8948,5972,2027,3258,7435,424],()=>i(2365));module.exports=s})();