"use strict";(()=>{var e={};e.id=145,e.ids=[145],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},7514:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>P,requestAsyncStorage:()=>I,routeModule:()=>j,serverHooks:()=>S,staticGenerationAsyncStorage:()=>N});var n={};r.r(n),r.d(n,{POST:()=>O});var o=r(9303),a=r(8716),s=r(670),i=r(7070),l=r(9487),c=r(5392),u=r(7408),p=r(2908);let y=`Ты - аналитик новостного контента. Проанализируй статью и предоставь структурированный результат.

ЗАДАЧИ:

1. META_DESCRIPTION (150-160 символов):
   - Краткое описание сути статьи для SEO
   - Нейтральный тон, максимально информативно
   - Для поисковых систем и социальных сетей

2. SUMMARY (3-5 предложений):
   - Выдели основные моменты и ключевые идеи
   - Профессиональный аналитический стиль
   - Полностью нейтральное изложение без эмоциональной окраски
   - Простой человеческий язык для комфортного восприятия
   - ВАЖНО: Перефразируй своими словами, НЕ копируй предложения из оригинала
   - SEO уникальность 90%+

3. SENTIMENT (тональность материала):
   - positive (позитивная)
   - neutral (нейтральная)
   - negative (негативная)

4. CONTENT_TYPE (тип контента):
   - purely_factual (новостная заметка, только факты)
   - mostly_factual (преимущественно факты с элементами анализа)
   - balanced (факты и мнения примерно поровну)
   - mostly_opinion (аналитика с мнениями)
   - purely_opinion (авторская колонка, редакционная статья)

5. TAXONOMY (классификация):
   - Определи подходящие категории, а также страны и города, связанные с материалом

Ответ должен быть на русском языке в формате JSON с полями: meta_description, summary, sentiment, content_type, taxonomy.`,d={category:"Выбери одну или несколько категорий, которые наилучшим образом описывают материал. Если подходящей категории нет, предложи новую аккуратную формулировку.",country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function m(e,t,r){let n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!n.ok){let e=await n.text();throw Error(`Gemini API error: ${n.status} - ${e}`)}let o=await n.json();return o.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let g=["claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function h(e,t,r,n){let o=new c.ZP({apiKey:e}),a=t||g[0],s=new Set,i=[a,...g].filter(e=>!s.has(e)&&(s.add(e),!0)),u=null;for(let e of i)try{let t=await o.messages.create({model:e,max_tokens:4096,system:r||void 0,messages:[{role:"user",content:n}]}),s=("text"===t.content[0].type?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==a)try{await l.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return s}catch(a){let t=a?.error?.message||a?.message||"Unknown error",r=a?.error?.type||a?.type||"unknown",n=a?.status??a?.response?.status,o="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===n||o.includes("not found")||o.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),u=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(u?.message||"Claude API error: нет доступных моделей для выполнения запроса")}let f=e=>(e??"").normalize("NFKC").trim().toLowerCase(),w=e=>"string"==typeof e?e.trim():"",x=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),n=t.lastIndexOf("}");return -1===r||-1===n||n<=r?null:t.slice(r,n+1)},_=(e,t)=>{let r=e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"],n=t.length>0?t.map(e=>e.name).join(", "):"(пока нет категорий)";return["Страны и города: "+r.join(" | "),"Категории: "+n,"Если подходящего значения нет, предложи новое аккуратное название."].join("\n")};async function O(e){try{let t,r;let{materialId:n}=await e.json();if(!n)return i.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let o=await l.db.getSettings(),a=o.ai_provider||"gemini",s=o.gemini_api_key,c=o.claude_api_key,g=o.gemini_model||"gemini-2.5-flash",O=o.claude_model||"claude-3-haiku-20240307",j=o.analysis_prompt||y,I=o.taxonomy_system_prompt,N=o.taxonomy_format_prompt,S={category:o.taxonomy_prompt_category??d.category,country:o.taxonomy_prompt_country??d.country,city:o.taxonomy_prompt_city??d.city},b="claude"===a?c:s;if(!b)return i.NextResponse.json({success:!1,error:`${"claude"===a?"Claude":"Gemini"} API ключ не настроен. Перейдите в Настройки.`},{status:400});let P=await l.db.getMaterialById(n);if(!P)return i.NextResponse.json({success:!1,error:"Material not found"},{status:404});let v=P.fullContent||P.content;if(!v||0===v.trim().length)return i.NextResponse.json({success:!1,error:"Материал не содержит текста для анализа"},{status:400});v.length>15e3&&(console.log(`Content too long (${v.length}), truncating to 15000`),v=v.substring(0,15e3)+"...");let $=await l.db.getTaxonomy(),C=[j,I||"Ты — редактор аналитического портала. Определи подходящие категории, а также страну и города статьи так, чтобы они помогали редакции быстро рубрицировать материалы.",`Правила для категорий: ${S.category}`,`Правила для стран: ${S.country}`,`Правила для городов: ${S.city}`,"Вот доступные справочники для ориентира:",_($.countries,$.categories)].filter(Boolean).join("\n\n"),E=["Проанализируй статью и предоставь результат.","СТАТЬЯ:",v,"Верни ответ строго в формате JSON:",`{
  "meta_description": "150-160 символов для SEO, без ссылок на статью",
  "summary": "3-5 предложений с ключевыми фактами",
  "sentiment": "positive | neutral | negative",
  "content_type": "purely_factual | mostly_factual | balanced | mostly_opinion | purely_opinion",
  "taxonomy": {
    "categories": ["Название категории"],
    "country": "Название страны или null",
    "city": "Название города или null"
  }
}`];N&&E.push("Дополнительные требования к формату:",N),E.push("Только чистый JSON без markdown, без дополнительного текста и комментариев.");let T=E.join("\n\n"),k=[C,T].filter(Boolean).join("\n\n");console.log(`Generating analysis for material ${n} using ${a}. Content length: ${v.length}`);try{t="claude"===a?await h(b,O,C,T):await m(b,g,k)}catch(t){console.error(`Error calling ${a} API:`,t);let e=t instanceof Error?t.message:"Unknown error";return i.NextResponse.json({success:!1,error:`Ошибка при обращении к ${"claude"===a?"Claude":"Gemini"} API: ${e}`},{status:500})}console.log(`${a} response (truncated):`,t.slice(0,500)+(t.length>500?"...":""));let M=x(t);if(!M)return console.error(`${a} response is not valid JSON. Full text:`,t),i.NextResponse.json({success:!1,error:`Нейросеть вернула ответ в неожиданном формате. Уточните промпт для JSON.`},{status:500});try{r=JSON.parse(M)}catch(t){let e=null;try{r=u.Z.parse(M)}catch(n){e=n;try{let e=(0,p.K)(M);r=JSON.parse(e)}catch(r){return console.error(`Failed to parse JSON from ${a}:`,r,"JSON5 error:",e,"Original error:",t,"Payload:",M),i.NextResponse.json({success:!1,error:"Не удалось разобрать JSON от нейросети. Проверьте формат ответа."},{status:500})}}}let A=w(r.summary),R=w(r.meta_description),J=r.sentiment,F=r.content_type;if(!A)return console.error("Summary is missing in parsed response:",r),i.NextResponse.json({success:!1,error:"Нейросеть не вернула саммари. Уточните промпт или повторите попытку."},{status:500});let q=r.taxonomy??{},D=Object.prototype.hasOwnProperty.call(q,"categories"),G=Object.prototype.hasOwnProperty.call(q,"country"),U=Object.prototype.hasOwnProperty.call(q,"city"),B=null!==q.country?w(q.country):"",K=null!==q.city?w(q.city):"",Y=new Map,L=new Map;$.countries.forEach(e=>{Y.set(f(e.name),e),(e.cities??[]).forEach(e=>{let t=f(e.name);L.has(t)||L.set(t,[]),L.get(t)?.push(e)})});let X=async e=>{let t=f(e);if(0===t.length)return null;let r=Y.get(t);if(r)return r;let n={...await l.db.createTaxonomyItem("country",e),cities:[]};return Y.set(t,n),$.countries.push(n),n},Z=async(e,t)=>{let r=f(e);if(0===r.length)return null;let n=L.get(r)??[];if(n.length>0){let e=n.find(e=>!t||e.countryId===t)??n[0];return t&&e.countryId!==t&&!Q.includes(e.countryId)&&(Q.push(e.countryId),W=!0),e}if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let o=await l.db.createTaxonomyItem("city",e,{countryId:t});L.has(r)||L.set(r,[]),L.get(r).push(o);let a=$.countries.find(e=>e.id===t);if(a)a.cities=[...a.cities??[],o];else{let e=$.countries.find(e=>e.id===o.countryId);e&&(e.cities=[...e.cities??[],o])}return o},z={},H=[],Q=[],V=[],W=G,ee=new Map;$.categories.forEach(e=>{ee.set(f(e.name),e)});let et=async e=>{let t=f(e);if(0===t.length)return null;let r=ee.get(t);if(r)return r;let n=await l.db.createTaxonomyItem("category",e);return ee.set(t,n),$.categories.push(n),n};if(D)for(let e of Array.isArray(q.categories)?q.categories:[]){let t=w(e);if(t)try{let e=await et(t);e&&!H.includes(e.id)&&H.push(e.id)}catch(e){console.error("Failed to ensure category:",t,e)}}if(G&&B)try{let e=await X(B);e&&Q.push(e.id)}catch(e){console.error("Failed to ensure country:",B,e)}if(U&&K)try{let e=await Z(K,Q[0]??null);e&&(V.includes(e.id)||V.push(e.id),Q.includes(e.countryId)||Q.push(e.countryId),W=!0)}catch(e){console.error("Failed to ensure city:",K,e)}if(D&&(z.categoryIds=H),W&&(z.countryIds=Q),U&&(z.cityIds=V),await l.db.updateMaterialSummary(n,{summary:A,metaDescription:R||void 0,sentiment:J||void 0,contentType:F||void 0,setProcessed:!0}),Object.prototype.hasOwnProperty.call(z,"categoryIds")||Object.prototype.hasOwnProperty.call(z,"countryIds")||Object.prototype.hasOwnProperty.call(z,"cityIds"))try{await l.db.updateMaterialTaxonomy(n,z)}catch(e){console.error("Failed to update taxonomy for material:",n,z,e)}let er=await l.db.getMaterialById(n);return i.NextResponse.json({success:!0,data:{summary:A,metaDescription:R||void 0,sentiment:J||void 0,contentType:F||void 0,material:er}})}catch(e){return console.error("Error generating summary and taxonomy:",e),i.NextResponse.json({success:!1,error:"Failed to generate summary"},{status:500})}}let j=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/materials/generate-summary/route",pathname:"/api/materials/generate-summary",filename:"route",bundlePath:"app/api/materials/generate-summary/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/generate-summary/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:I,staticGenerationAsyncStorage:N,serverHooks:S}=j,b="/api/materials/generate-summary/route";function P(){return(0,s.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:N})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972,345,487],()=>r(7514));module.exports=n})();