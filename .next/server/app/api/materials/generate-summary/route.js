"use strict";(()=>{var e={};e.id=145,e.ids=[145],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},3587:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>j,requestAsyncStorage:()=>f,routeModule:()=>h,serverHooks:()=>I,staticGenerationAsyncStorage:()=>x});var n={};r.r(n),r.d(n,{POST:()=>g});var a=r(9303),o=r(8716),s=r(670),i=r(7070),l=r(9487);let c={category:"Определи одну или несколько категорий, основываясь на главной тематике статьи.",theme:"Подбери тематические направления, отражающие сюжет и контекст материала.",tag:"Сформируй теги для поиска и фильтрации, используй ключевые термины и факты.",alliance:"Определи международные или региональные союзы, блоки и объединения, напрямую связанные с сюжетом материала.",country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."},u=e=>(e??"").normalize("NFKC").trim().toLowerCase(),m=e=>"string"==typeof e?e.trim():"",y=e=>{if(!Array.isArray(e))return[];let t=new Set,r=[];for(let n of e){let e=m(n);if(e.length>0){let n=u(e);t.has(n)||(t.add(n),r.push(e))}}return r},p=e=>{if(!e)return null;let t=e.indexOf("{"),r=e.lastIndexOf("}");return -1===t||-1===r||r<=t?null:e.slice(t,r+1)},d=(e,t,r,n)=>{let a=e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"],o=t.length>0?t.map(e=>e.name).join(", "):"(пока нет тем)",s=r.length>0?r.map(e=>e.name).join(", "):"(пока нет тегов)",i=n.length>0?n.map(e=>e.name).join(", "):"(пока нет союзов)";return["Страны и города: "+a.join(" | "),"Темы: "+o,"Теги: "+s,"Политические союзы и блоки: "+i,"Если подходящего значения нет, предложи новое аккуратное название."].join("\n")};async function g(e){try{let t;let{materialId:r}=await e.json();if(!r)return i.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let n=await l.db.getSettings(),a=n.gemini_api_key,o=n.summary_prompt,s=n.taxonomy_system_prompt,g=n.taxonomy_format_prompt,h={category:n.taxonomy_prompt_category??c.category,theme:n.taxonomy_prompt_theme??c.theme,tag:n.taxonomy_prompt_tag??c.tag,alliance:n.taxonomy_prompt_alliance??c.alliance,country:n.taxonomy_prompt_country??c.country,city:n.taxonomy_prompt_city??c.city};if(!a)return i.NextResponse.json({success:!1,error:"Gemini API ключ не настроен. Перейдите в Настройки."},{status:400});let f=await l.db.getMaterialById(r);if(!f)return i.NextResponse.json({success:!1,error:"Material not found"},{status:404});let x=f.fullContent||f.content;if(!x||0===x.trim().length)return i.NextResponse.json({success:!1,error:"Материал не содержит текста для анализа"},{status:400});x.length>15e3&&(console.log(`Content too long (${x.length}), truncating to 15000`),x=x.substring(0,15e3)+"...");let I=await l.db.getTaxonomy(),w=["Задача: создай краткое саммари и предложи таксономию для статьи.",o||"Создай краткое саммари следующей статьи. Выдели основные моменты и ключевые идеи. Ответ должен быть на русском языке, лаконичным и информативным (3-5 предложений).",s||"Ты — редактор аналитического портала. Определи страну, город, темы и теги статьи так, чтобы они помогали редакции быстро рубрицировать материалы.",g||'Верни ответ строго в формате JSON:\n{\n  "summary": "краткое резюме на русском",\n  "taxonomy": {\n    "country": "Название страны или null",\n    "city": "Название города или null",\n    "themes": ["Список тем"],\n    "tags": ["Список тегов"],\n    "alliances": ["Список союзов и блоков"]\n  }\n}\nНе добавляй пояснений. Если не удалось определить значение, используй null или пустой массив.',`Правила для категорий: ${h.category}`,`Правила для тем: ${h.theme}`,`Правила для тегов: ${h.tag}`,`Правила для политических союзов: ${h.alliance}`,`Правила для стран: ${h.country}`,`Правила для городов: ${h.city}`,"Вот доступные справочники для ориентира:",d(I.countries,I.themes,I.tags,I.alliances),"Статья:",x].filter(Boolean).join("\n\n");console.log(`Generating summary & taxonomy for material ${r}. Content length: ${x.length}`);let j={contents:[{role:"user",parts:[{text:w}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}};console.log("Gemini request (truncated):",JSON.stringify(j).substring(0,400)+"...");let O=await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":a},body:JSON.stringify(j)});if(!O.ok){let e=await O.text();console.error("Gemini API error:",O.status,e.slice(0,500));let t="Ошибка при обращении к Gemini API",r=t;try{let n=JSON.parse(e);r=(t=n.error?.message||t).includes("internal error")?"Временная ошибка Gemini API. Попробуйте через несколько секунд.":t.includes("API key")?"Проблема с API ключом. Проверьте настройки.":t.includes("quota")||t.includes("limit")?"Превышен лимит запросов. Подождите немного и повторите попытку.":t.includes("SAFETY")?"Контент заблокирован фильтром безопасности Gemini.":t}catch(e){console.error("Failed to parse Gemini error payload:",e)}return i.NextResponse.json({success:!1,error:r,details:t},{status:O.status})}let b=await O.json(),P=b.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??"";console.log("Gemini response (truncated):",P.slice(0,500)+(P.length>500?"...":""));let N=p(P);if(!N)return console.error("Gemini response is not valid JSON. Full text:",P),i.NextResponse.json({success:!1,error:"Нейросеть вернула ответ в неожиданном формате. Уточните промпт для JSON."},{status:500});try{t=JSON.parse(N)}catch(e){return console.error("Failed to parse JSON from Gemini:",e,N),i.NextResponse.json({success:!1,error:"Не удалось разобрать JSON от нейросети. Проверьте формат ответа."},{status:500})}let _=m(t.summary);if(!_)return console.error("Summary is missing in parsed response:",t),i.NextResponse.json({success:!1,error:"Нейросеть не вернула саммари. Уточните промпт или повторите попытку."},{status:500});let A=t.taxonomy??{},S=Object.prototype.hasOwnProperty.call(A,"country"),F=Object.prototype.hasOwnProperty.call(A,"city"),M=null!==A.country?m(A.country):"",v=null!==A.city?m(A.city):"",R=y(A.themes),T=y(A.tags),G=y(A.alliances),$=new Map,C=new Map,k=new Map,J=new Map,q=new Map;I.countries.forEach(e=>{$.set(u(e.name),e),(e.cities??[]).forEach(e=>{let t=u(e.name);C.has(t)||C.set(t,[]),C.get(t)?.push(e)})}),I.themes.forEach(e=>{k.set(u(e.name),e)}),I.tags.forEach(e=>{J.set(u(e.name),e)}),I.alliances.forEach(e=>{q.set(u(e.name),e)});let E=async e=>{let t=u(e);if(0===t.length)return null;let r=$.get(t);if(r)return r;let n={...await l.db.createTaxonomyItem("country",e),cities:[]};return $.set(t,n),I.countries.push(n),n},B=async(e,t)=>{let r=u(e);if(0===r.length)return null;let n=C.get(r)??[];if(n.length>0){let e=n.find(e=>!t||e.countryId===t)??n[0];return t&&e.countryId!==t&&H.countryId!==e.countryId&&(H.countryId=e.countryId),e}if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let a=await l.db.createTaxonomyItem("city",e,{countryId:t});C.has(r)||C.set(r,[]),C.get(r).push(a);let o=I.countries.find(e=>e.id===t);if(o)o.cities=[...o.cities??[],a];else{let e=I.countries.find(e=>e.id===a.countryId);e&&(e.cities=[...e.cities??[],a])}return a},D=async e=>{let t=u(e);if(0===t.length)return null;let r=k.get(t);if(r)return r;let n=await l.db.createTaxonomyItem("theme",e);return k.set(t,n),I.themes.push(n),n},U=async e=>{let t=u(e);if(0===t.length)return null;let r=J.get(t);if(r)return r;let n=await l.db.createTaxonomyItem("tag",e);return J.set(t,n),I.tags.push(n),n},z=async e=>{let t=u(e);if(0===t.length)return null;let r=q.get(t);if(r)return r;let n=await l.db.createTaxonomyItem("alliance",e);return q.set(t,n),I.alliances.push(n),n},H={};if(S){if(M)try{let e=await E(M);H.countryId=e?.id??null}catch(e){console.error("Failed to ensure country:",M,e),H.countryId=null}else H.countryId=null}if(F){if(v)try{let e=await B(v,H.countryId);e?(H.cityId=e.id,(void 0===H.countryId||null===H.countryId)&&(H.countryId=e.countryId)):H.cityId=null}catch(e){console.error("Failed to ensure city:",v,e),H.cityId=null}else H.cityId=null}if(Array.isArray(A.themes)){let e=[];for(let t of R)try{let r=await D(t);r&&e.push(r.id)}catch(e){console.error("Failed to ensure theme:",t,e)}H.themeIds=e}if(Array.isArray(A.tags)){let e=[];for(let t of T)try{let r=await U(t);r&&e.push(r.id)}catch(e){console.error("Failed to ensure tag:",t,e)}H.tagIds=e}if(Array.isArray(A.alliances)){let e=[];for(let t of G)try{let r=await z(t);r&&e.push(r.id)}catch(e){console.error("Failed to ensure alliance:",t,e)}H.allianceIds=e}if(await l.db.updateMaterialSummary(r,_),Object.prototype.hasOwnProperty.call(H,"countryId")||Object.prototype.hasOwnProperty.call(H,"cityId")||Object.prototype.hasOwnProperty.call(H,"themeIds")||Object.prototype.hasOwnProperty.call(H,"tagIds")||Object.prototype.hasOwnProperty.call(H,"allianceIds"))try{await l.db.updateMaterialTaxonomy(r,H)}catch(e){console.error("Failed to update taxonomy for material:",r,H,e)}let K=await l.db.getMaterialById(r);return i.NextResponse.json({success:!0,data:{summary:_,material:K}})}catch(e){return console.error("Error generating summary and taxonomy:",e),i.NextResponse.json({success:!1,error:"Failed to generate summary"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/materials/generate-summary/route",pathname:"/api/materials/generate-summary",filename:"route",bundlePath:"app/api/materials/generate-summary/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/generate-summary/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:x,serverHooks:I}=h,w="/api/materials/generate-summary/route";function j(){return(0,s.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:x})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972,487],()=>r(3587));module.exports=n})();