"use strict";(()=>{var e={};e.id=145,e.ids=[145],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},7514:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>S,requestAsyncStorage:()=>_,routeModule:()=>w,serverHooks:()=>j,staticGenerationAsyncStorage:()=>N});var n={};r.r(n),r.d(n,{POST:()=>x});var o=r(9303),a=r(8716),i=r(670),s=r(7070),c=r(9487),l=r(5506),u=r(1456);let m=`Ты - аналитик новостного контента. Проанализируй статью и предоставь структурированный результат.

ЗАДАЧИ:

1. META_DESCRIPTION (150-160 символов):
   - Краткое описание сути статьи для SEO
   - Нейтральный тон, максимально информативно
   - Для поисковых систем и социальных сетей

2. SUMMARY (3-5 предложений):
   - Выдели основные моменты и ключевые идеи
   - Профессиональный аналитический стиль
   - Полностью нейтральное изложение без эмоциональной окраски
   - Простой человеческий язык для комфортного восприятия
   - ВАЖНО: Перефразируй своими словами, НЕ копируй предложения из оригинала
   - SEO уникальность 90%+

3. SENTIMENT (тональность материала):
   - positive (позитивная)
   - neutral (нейтральная)
   - negative (негативная)

4. CONTENT_TYPE (тип контента):
   - purely_factual (новостная заметка, только факты)
   - mostly_factual (преимущественно факты с элементами анализа)
   - balanced (факты и мнения примерно поровну)
   - mostly_opinion (аналитика с мнениями)
   - purely_opinion (авторская колонка, редакционная статья)

5. TAXONOMY (классификация):
   - Определи подходящие категории, а также страны и города, связанные с материалом

Ответ должен быть на русском языке в формате JSON с полями: meta_description, summary, sentiment, content_type, taxonomy.`,p={category:"Выбери одну или несколько категорий, которые наилучшим образом описывают материал. Если подходящей категории нет, предложи новую аккуратную формулировку.",country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function d(e,t,r){let n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!n.ok){let e=await n.text();throw Error(`Gemini API error: ${n.status} - ${e}`)}let o=await n.json();return o.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let y=e=>(e??"").normalize("NFKC").trim().toLowerCase(),g=e=>"string"==typeof e?e.trim():"",f=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),n=t.lastIndexOf("}");return -1===r||-1===n||n<=r?null:t.slice(r,n+1)},h=(e,t)=>{let r=e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"],n=t.length>0?t.map(e=>e.name).join(", "):"(пока нет категорий)";return["Страны и города: "+r.join(" | "),"Категории: "+n,"Если подходящего значения нет, предложи новое аккуратное название."].join("\n")};async function x(e){try{let t,r;let{materialId:n}=await e.json();if(!n)return s.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let o=await c.db.getSettings(),a=o.ai_provider||"gemini",i=o.gemini_api_key,x=o.claude_api_key,w=o.gemini_model||"gemini-2.5-flash",_=o.claude_model||u.y[0],N=o.analysis_prompt||m,j=o.taxonomy_system_prompt,$=o.taxonomy_format_prompt,S={category:o.taxonomy_prompt_category??p.category,country:o.taxonomy_prompt_country??p.country,city:o.taxonomy_prompt_city??p.city},v="claude"===a?x:i;if(!v)return s.NextResponse.json({success:!1,error:`${"claude"===a?"Claude":"Gemini"} API ключ не настроен. Перейдите в Настройки.`},{status:400});let O=await c.db.getMaterialById(n);if(!O)return s.NextResponse.json({success:!1,error:"Material not found"},{status:404});let C=O.fullContent||O.content;if(!C||0===C.trim().length)return s.NextResponse.json({success:!1,error:"Материал не содержит текста для анализа"},{status:400});C.length>15e3&&(console.log(`Content too long (${C.length}), truncating to 15000`),C=C.substring(0,15e3)+"...");let[I,b]=await Promise.all([c.db.getTaxonomy(),c.db.getCategoryExamples(15)]),T=[N,j||"Ты — редактор аналитического портала. Определи подходящие категории, а также страну и города статьи так, чтобы они помогали редакции быстро рубрицировать материалы.",`Правила для категорий: ${S.category}`,`Правила для стран: ${S.country}`,`Правила для городов: ${S.city}`,"Вот доступные справочники для ориентира:",h(I.countries,I.categories)].filter(Boolean).join("\n\n"),E=["Проанализируй статью и предоставь результат.","СТАТЬЯ:",C,"Верни ответ строго в формате JSON:",`{
  "meta_description": "150-160 символов для SEO, без ссылок на статью",
  "summary": "3-5 предложений с ключевыми фактами",
  "sentiment": "positive | neutral | negative",
  "content_type": "purely_factual | mostly_factual | balanced | mostly_opinion | purely_opinion",
  "taxonomy": {
    "categories": ["Название категории"],
    "country": "Название страны или null",
    "city": "Название города или null"
  }
}`];$&&E.push("Дополнительные требования к формату:",$),E.push("Только чистый JSON без markdown, без дополнительного текста и комментариев.");let k=E.join("\n\n"),A=[T,k].filter(Boolean).join("\n\n");console.log(`Generating analysis for material ${n} using ${a}. Content length: ${C.length}`);try{t="claude"===a?await (0,u.A)(v,_,T,k):await d(v,w,A)}catch(t){console.error(`Error calling ${a} API:`,t);let e=t instanceof Error?t.message:"Unknown error";return s.NextResponse.json({success:!1,error:`Ошибка при обращении к ${"claude"===a?"Claude":"Gemini"} API: ${e}`},{status:500})}console.log(`${a} response (truncated):`,t.slice(0,500)+(t.length>500?"...":""));let P=f(t);if(!P)return console.error(`${a} response is not valid JSON. Full text:`,t),s.NextResponse.json({success:!1,error:`Нейросеть вернула ответ в неожиданном формате. Уточните промпт для JSON.`},{status:500});try{r=(0,l.Vu)(P)}catch(e){return console.error(`Failed to parse JSON from ${a}:`,e,"Payload:",P),s.NextResponse.json({success:!1,error:"Не удалось разобрать JSON от нейросети. Проверьте формат ответа."},{status:500})}let J=g(r.summary),M=g(r.meta_description),R=r.sentiment,F=r.content_type;if(!J)return console.error("Summary is missing in parsed response:",r),s.NextResponse.json({success:!1,error:"Нейросеть не вернула саммари. Уточните промпт или повторите попытку."},{status:500});let B=await (0,l.D2)({materialId:n,articleText:C,materialTitle:O.title,categories:I.categories,examples:b,claudeApiKey:x,claudeModel:_}),D=r.taxonomy??{},q=Array.isArray(D.categories)?D.categories:[],K=D.country?g(D.country):"",G=D.city?g(D.city):"",L={},U=[],z=[],Y=[],V=!1,X=new Map;I.categories.forEach(e=>{X.set(y(e.name),e)});let Z=async e=>{let t=y(e);if(0===t.length)return null;let r=X.get(t);if(r)return r;let n=await c.db.createTaxonomyItem("category",e);return X.set(t,n),I.categories.push(n),n},H=new Map,Q=new Map;I.countries.forEach(e=>{H.set(y(e.name),e),(e.cities??[]).forEach(e=>{let t=y(e.name);Q.has(t)||Q.set(t,[]),Q.get(t)?.push(e)})});let W=async e=>{let t=y(e);if(0===t.length)return null;let r=H.get(t);if(r)return r;let n={...await c.db.createTaxonomyItem("country",e),cities:[]};return H.set(t,n),I.countries.push(n),n},ee=async(e,t)=>{let r=y(e);if(0===r.length)return null;let n=Q.get(r)??[];if(n.length>0){let e=n.find(e=>!t||e.countryId===t)??n[0];return t&&e.countryId!==t&&!z.includes(e.countryId)&&(z.push(e.countryId),V=!0),e}if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let o=await c.db.createTaxonomyItem("city",e,{countryId:t});Q.has(r)||Q.set(r,[]),Q.get(r).push(o);let a=I.countries.find(e=>e.id===t);if(a)a.cities=[...a.cities??[],o];else{let e=I.countries.find(e=>e.id===o.countryId);e&&(e.cities=[...e.cities??[],o])}return o},et=[...B?.category?[B.category]:[],...q].map(e=>g(e)).filter(e=>e.length>0);if(et.length>0){for(let e of et)try{let t=await Z(e);t&&!U.includes(t.id)&&U.push(t.id)}catch(t){console.error("Failed to ensure category:",e,t)}L.categoryIds=U}if(K)try{let e=await W(K);e&&(z.push(e.id),V=!0)}catch(e){console.error("Failed to ensure country:",K,e)}if(G)try{let e=await ee(G,z[0]??null);e&&(Y.includes(e.id)||Y.push(e.id),z.includes(e.countryId)||(z.push(e.countryId),V=!0))}catch(e){console.error("Failed to ensure city:",G,e)}if(V&&z.length>0&&(L.countryIds=z),Y.length>0&&(L.cityIds=Y),await c.db.updateMaterialSummary(n,{summary:J,metaDescription:M||void 0,sentiment:R||void 0,contentType:F||void 0,setProcessed:!0}),Object.keys(L).length>0)try{await c.db.updateMaterialTaxonomy(n,L)}catch(e){console.error("Failed to update taxonomy for material:",n,L,e)}let er=await c.db.getMaterialById(n);return s.NextResponse.json({success:!0,data:{summary:J,metaDescription:M||void 0,sentiment:R||void 0,contentType:F||void 0,material:er,classification:B?{category:B.category,confidence:B.confidence,supercategory:B.supercategory??null,reasoning:B.reasoning}:null}})}catch(e){return console.error("Error generating summary and taxonomy:",e),s.NextResponse.json({success:!1,error:"Failed to generate summary"},{status:500})}}let w=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/materials/generate-summary/route",pathname:"/api/materials/generate-summary",filename:"route",bundlePath:"app/api/materials/generate-summary/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/generate-summary/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:_,staticGenerationAsyncStorage:N,serverHooks:j}=w,$="/api/materials/generate-summary/route";function S(){return(0,i.patchFetch)({serverHooks:j,staticGenerationAsyncStorage:N})}},1456:(e,t,r)=>{r.d(t,{A:()=>i,y:()=>a});var n=r(5392),o=r(9487);let a=["claude-sonnet-4-20250514","claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function i(e,t,r,i,s){let c=new n.ZP({apiKey:e}),l=t||a[0],u=new Set,m=[l,...a].filter(e=>!u.has(e)&&(u.add(e),!0)),p=null;for(let e of m)try{let t=await c.messages.create({model:e,max_tokens:s?.maxTokens??4096,temperature:s?.temperature,system:r||void 0,messages:[{role:"user",content:i}]}),n=(t.content[0]?.type==="text"?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==l)try{await o.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return n}catch(a){let t=a?.error?.message||a?.message||"Unknown error",r=a?.error?.type||a?.type||"unknown",n=a?.status??a?.response?.status,o="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===n||o.includes("not found")||o.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),p=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(p?.message||"Claude API error: нет доступных моделей для выполнения запроса")}},5506:(e,t,r)=>{r.d(t,{D2:()=>h,Vu:()=>c});var n=r(9487),o=r(7408),a=r(2908),i=r(1456);let s=["Внутренняя Украина","Международное","Общее"],c=e=>{try{return JSON.parse(e)}catch(r){let t=null;try{return o.Z.parse(e)}catch(n){t=n;try{let t=(0,a.K)(e);return JSON.parse(t)}catch(e){throw Error(`Failed to parse JSON. First error: ${r.message}. JSON5 error: ${t instanceof Error?t.message:t}. Repair error: ${e instanceof Error?e.message:e}`)}}}},l=(e,t=.5)=>{let r="number"==typeof e?e:Number(e);return Number.isFinite(r)?r<0?0:r>1?1:r:t},u=e=>(e??"").normalize("NFKC").trim().toLowerCase(),m=e=>"string"==typeof e?e.trim():"",p=e=>0===e.length?"Нет сохранённых категорий. Если создаёшь новую категорию, убедись, что она отличается от существующих и не дублирует темы других рубрик.":e.slice(0,12).map(e=>`Категория "${e.name}":
✅ ОТНОСИТСЯ: Материал, где эта тема является основной, и большинство ключевых фактов напрямую описывают именно её.
❌ НЕ ОТНОСИТСЯ: Если категория упомянута лишь вскользь или как фон, а основная тема относится к другой рубрике.
❌ НЕ ОТНОСИТСЯ: Если материал относится к другой специализации (например, военные действия, экономика, культура).`).join("\n\n"),d=e=>0===e.length?"Нет сохранённых примеров. Используй здравый смысл и чётко сопоставляй содержание статье с определённой категорией.":e.map(e=>{let t=m(e.summary)||m(e.content)?.slice(0,220)||"нет краткого описания";return`Заголовок: ${e.title}
Категория: ${e.category}
Краткое описание: ${t}`}).join("\n\n"),y=async e=>{let{apiKey:t,model:r,articleText:n,materialTitle:o}=e,a=[o?`Заголовок: ${o}`:null,"Текст статьи:",n,"Определи надкатегорию (только из списка).","Верни JSON формата:",`{
  "supercategory": "Внутренняя Украина | Международное | Общее",
  "reasoning": "почему выбран этот вариант",
  "confidence": 0.82
}`,"Только чистый JSON."].filter(Boolean).join("\n\n"),p=c((await (0,i.A)(t,r,'Ты — аналитик новостного портала. Твоя задача — определить надкатегорию материала для дальнейшей точной классификации.\nВозможные надкатегории:\n- "Внутренняя Украина" — события внутри страны, управление, экономика, общество.\n- "Международное" — внешняя политика, международные отношения, глобальные события, влияющие на Украину.\n- "Общее" — материалы общего характера, которые не попадают в первые два типа (например, технологии, культура глобально).\nВсегда возвращай JSON с ключами: supercategory, reasoning, confidence (0..1).',a,{maxTokens:512,temperature:.2})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim()),d=m(p.supercategory);return{supercategory:s.find(e=>u(e)===u(d))??null,reasoning:m(p.reasoning),confidence:l(p.confidence,.6)}},g=async e=>{let{apiKey:t,model:r,articleText:n,categories:o,examples:a,supercategory:s,materialTitle:u}=e,y=p(o),g=d(a),f=["Ты — опытный редактор по классификации материалов.","Список доступных категорий (используй точное написание):",(o.length>0?o.map(e=>e.name).sort((e,t)=>e.localeCompare(t,"ru")):["(Категории не заданы — при необходимости предложи новую формулировку)"]).map(e=>`- ${e}`).join("\n"),"Как отличать категории: ",y,"Примеры из архива (ориентируйся на стиль и тематику):",g,"Если нет точного соответствия, предложи новую категорию, но поясни, чем она отличается."].filter(Boolean).join("\n\n"),h=[u?`Заголовок: ${u}`:null,s?`Определённая надкатегория: ${s}. Убедись, что финальная категория совместима с этой надкатегорией.`:"Надкатегорию определить не удалось — выбери наиболее подходящую категорию.","Проанализируй статью и определи категорию. Используй пошаговый анализ.","СТАТЬЯ:",n,"ПОШАГОВЫЙ АНАЛИЗ:","Шаг 1: О чем статья одним предложением?","Шаг 2: Есть ли украинский контекст? (да/нет и почему)","Шаг 3: Какие ключевые слова присутствуют?","Шаг 4: К какой категории относится?","Шаг 5: Почему именно эта категория, а не другие похожие?","Верни JSON:",`{
  "step1_summary": "...",
  "step2_ukrainian_context": "да/нет, потому что...",
  "step3_keywords": ["слово1", "слово2"],
  "step4_category": "Название категории",
  "step5_reasoning": "Объяснение выбора и почему не другие категории",
  "confidence": 0.95
}`,"Только чистый JSON без markdown."].filter(Boolean).join("\n\n"),x=c((await (0,i.A)(t,r,f,h,{maxTokens:1024,temperature:.3})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim());return{category:m(x.step4_category)||null,confidence:l(x.confidence,.6),reasoning:x}},f=async e=>{let{apiKey:t,model:r,articleText:n,proposedCategory:o,supercategory:a,materialTitle:s}=e,u=[s?`Заголовок: ${s}`:null,`Предложенная категория: ${o||"не указана"}`,a?`Надкатегория: ${a}`:null,"ПРОЧИТАЙ СТАТЬЮ:",n,"Верни JSON:",`{
  "category": "Название категории или предыдущая, если согласен",
  "confidence": 0.8,
  "comment": "пояснение оценки"
}`,"Только чистый JSON."].filter(Boolean).join("\n\n"),p=c((await (0,i.A)(t,r,"Ты — редактор, который перепроверяет корректность выбранной категории.\nЕсли категория не подходит, предложи альтернативу и объясни расхождение.",u,{maxTokens:512,temperature:.2})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim());return{category:m(p.category)||o||null,confidence:l(p.confidence,.5),comment:m(p.comment)}},h=async e=>{let{materialId:t,articleText:r,materialTitle:o,categories:a,examples:i,claudeApiKey:s,claudeModel:c}=e;if(!s)return null;try{let e,l;let m=await y({apiKey:s,model:c,articleText:r,materialTitle:o}),p=await g({apiKey:s,model:c,articleText:r,categories:a,examples:i,supercategory:m.supercategory,materialTitle:o}),d=p.category,h=p.confidence,x=null;if(p.confidence<.75){let t=await f({apiKey:s,model:c,articleText:r,proposedCategory:d,supercategory:m.supercategory,materialTitle:o});x=t.category,e=t.confidence,l=t.comment,t.category&&u(t.category)!==u(d||"")?(d=t.category,h=Math.max(t.confidence,.9*h)):t.confidence>h&&(h=t.confidence)}return await n.db.createCategorizationLog({materialId:t,supercategory:m.supercategory??void 0,predictedCategory:p.category??void 0,validationCategory:x??void 0,confidence:p.confidence,validationConfidence:e,reasoning:{supercategory_reasoning:m.reasoning,classification:p.reasoning,validation_comment:l},metadata:{final_category:d,final_confidence:h}}),{category:d,confidence:h,reasoning:p.reasoning,supercategory:m.supercategory??null,validationCategory:x,validationConfidence:e,validationComment:l}}catch(e){return console.error("Advanced category classification failed:",e),await n.db.createCategorizationLog({materialId:t,predictedCategory:void 0,confidence:0,reasoning:{error:e instanceof Error?e.message:String(e)}}),null}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972,345,487],()=>r(7514));module.exports=n})();