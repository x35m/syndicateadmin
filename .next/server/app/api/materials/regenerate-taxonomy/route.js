"use strict";(()=>{var e={};e.id=730,e.ids=[730],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},768:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>P,requestAsyncStorage:()=>O,routeModule:()=>I,serverHooks:()=>k,staticGenerationAsyncStorage:()=>b});var o={};r.r(o),r.d(o,{POST:()=>j});var n=r(9303),a=r(8716),i=r(670),s=r(7070),l=r(9487),c=r(5392),u=r(7408);async function p(e,t,r){let o=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!o.ok){let e=await o.text();throw Error(`Gemini API error: ${o.status} - ${e}`)}let n=await o.json();return n.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let d=["claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function y(e,t,r){let o=new c.ZP({apiKey:e}),n=t||d[0],a=new Set,i=[n,...d].filter(e=>!a.has(e)&&(a.add(e),!0)),s=null;for(let e of i)try{let t=await o.messages.create({model:e,max_tokens:4096,messages:[{role:"user",content:r}]}),a=("text"===t.content[0].type?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==n)try{await l.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return a}catch(a){let t=a?.error?.message||a?.message||"Unknown error",r=a?.error?.type||a?.type||"unknown",o=a?.status??a?.response?.status,n="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===o||n.includes("not found")||n.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),s=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(s?.message||"Claude API error: нет доступных моделей для выполнения запроса")}let m=e=>(e??"").normalize("NFKC").trim().toLowerCase(),g=e=>"string"==typeof e?e.trim():"",f=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),o=t.lastIndexOf("}");return -1===r||-1===o||o<=r?null:t.slice(r,o+1)},h=e=>["Страны и города: "+(e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"]).join(" | "),"Если подходящего значения нет, предложи новое аккуратное название."].join("\n"),x=`Верни только JSON объект со следующей структурой:
{
  "country": "название страны" или null,
  "city": "название города" или null
}`,w={country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function j(e){try{let t;let{materialId:r}=await e.json();if(!r)return s.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let o=await l.db.getMaterialById(r);if(!o)return s.NextResponse.json({success:!1,error:"Material not found"},{status:404});let n=await l.db.getSettings(),a=n.ai_provider||"gemini",i=n.gemini_api_key,c=n.claude_api_key,d=n.gemini_model||"gemini-2.5-flash",j=n.claude_model||"claude-3-haiku-20240307",I="claude"===a?c:i;if(!I)return s.NextResponse.json({success:!1,error:`API key for ${a} is not configured`},{status:400});let O=await l.db.getTaxonomy(),b=h(O.countries),k=n.taxonomy_prompt_country||w.country,_=n.taxonomy_prompt_city||w.city,P=n.taxonomy_format_prompt||x,S=o.fullContent||o.content||"",$=S.length>15e3?S.slice(0,15e3)+"...":S,C=["Проанализируй статью и определи подходящие значения таксономии.","","КОНТЕКСТ ДОСТУПНЫХ ЗНАЧЕНИЙ:",b,"","ПРАВИЛА ДЛЯ КАЖДОГО ТИПА:",`Страна: ${k}`,`Город: ${_}`,"","СТАТЬЯ:",`Заголовок: ${o.title}`,`Содержание: ${$}`,"",P,"","ВАЖНО: Верни только чистый JSON, без markdown разметки и дополнительного текста."].join("\n"),N=await ("claude"===a?y(I,j,C):p(I,d,C)),v=f(N);if(!v)throw Error("Failed to extract JSON from AI response");try{t=JSON.parse(v)}catch(e){try{t=u.Z.parse(v)}catch(t){throw console.error("Failed to parse taxonomy JSON:",t,"Original error:",e,v),Error("Failed to parse taxonomy JSON from AI response")}}let A=g(t.country),F=g(t.city),M=Object.prototype.hasOwnProperty.call(t,"country"),R=Object.prototype.hasOwnProperty.call(t,"city"),T={},E=new Map;for(let e of O.countries)E.set(m(e.name),{...e,cities:e.cities??[]});let J=[],q=[],U=M,B=async e=>{let t=m(e);if(0===t.length)return null;let r=E.get(t);if(r)return r;try{let r=await l.db.createTaxonomyItem("country",e);if(r){let e={...r,cities:[]};return E.set(t,e),O.countries.push(e),e}}catch(t){console.error("Failed to create country:",e,t)}return null},D=new Map;for(let e of O.countries)for(let t of e.cities??[]){let e=m(t.name);D.has(e)||D.set(e,[]),D.get(e).push(t)}let G=async(e,t)=>{let r=m(e);if(0===r.length)return null;let o=D.get(r)??[];if(o.length>0){let e=o.find(e=>!t||e.countryId===t)??o[0];return t&&e.countryId!==t&&!J.includes(e.countryId)&&(J.push(e.countryId),U=!0),e}if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let n=await l.db.createTaxonomyItem("city",e,{countryId:t});D.has(r)||D.set(r,[]),D.get(r).push(n);let a=O.countries.find(e=>e.id===t);return a&&(a.cities=[...a.cities??[],n]),n};if(M&&A){let e=await B(A);e&&J.push(e.id)}if(R&&F){let e=null;if(A){let t=J[0]??null;e=await G(F,t)}else{let t=m(F);for(let r of O.countries){let o=(r.cities??[]).find(e=>m(e.name)===t);if(o){e=o,J.includes(r.id)||J.push(r.id);break}}e||console.warn(`City "${F}" cannot be resolved without country reference. Skipping.`)}e&&(q.includes(e.id)||q.push(e.id),J.includes(e.countryId)||J.push(e.countryId),U=!0)}if(U&&(T.countryIds=J),R&&(T.cityIds=q),Object.prototype.hasOwnProperty.call(T,"countryIds")||Object.prototype.hasOwnProperty.call(T,"cityIds"))try{await l.db.updateMaterialTaxonomy(r,T)}catch(e){return console.error("Failed to update taxonomy for material:",r,T,e),s.NextResponse.json({success:!1,error:"Failed to update taxonomy"},{status:500})}let K=await l.db.getMaterialById(r);return s.NextResponse.json({success:!0,data:{material:K,taxonomy:T}})}catch(e){return console.error("Error regenerating taxonomy:",e),s.NextResponse.json({success:!1,error:"Failed to regenerate taxonomy"},{status:500})}}let I=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/materials/regenerate-taxonomy/route",pathname:"/api/materials/regenerate-taxonomy",filename:"route",bundlePath:"app/api/materials/regenerate-taxonomy/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/regenerate-taxonomy/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:O,staticGenerationAsyncStorage:b,serverHooks:k}=I,_="/api/materials/regenerate-taxonomy/route";function P(){return(0,i.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:b})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[948,972,327,487],()=>r(768));module.exports=o})();