"use strict";(()=>{var e={};e.id=730,e.ids=[730],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},768:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>k,patchFetch:()=>S,requestAsyncStorage:()=>b,routeModule:()=>I,serverHooks:()=>P,staticGenerationAsyncStorage:()=>_});var o={};r.r(o),r.d(o,{POST:()=>O});var n=r(9303),a=r(8716),i=r(670),s=r(7070),l=r(9487),c=r(5392),u=r(7408),p=r(2908);async function d(e,t,r){let o=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!o.ok){let e=await o.text();throw Error(`Gemini API error: ${o.status} - ${e}`)}let n=await o.json();return n.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let y=["claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function m(e,t,r,o){let n=new c.ZP({apiKey:e}),a=t||y[0],i=new Set,s=[a,...y].filter(e=>!i.has(e)&&(i.add(e),!0)),u=null;for(let e of s)try{let t=await n.messages.create({model:e,max_tokens:4096,system:r||void 0,messages:[{role:"user",content:o}]}),i=("text"===t.content[0].type?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==a)try{await l.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return i}catch(a){let t=a?.error?.message||a?.message||"Unknown error",r=a?.error?.type||a?.type||"unknown",o=a?.status??a?.response?.status,n="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===o||n.includes("not found")||n.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),u=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(u?.message||"Claude API error: нет доступных моделей для выполнения запроса")}let g=e=>(e??"").normalize("NFKC").trim().toLowerCase(),f=e=>"string"==typeof e?e.trim():"",h=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),o=t.lastIndexOf("}");return -1===r||-1===o||o<=r?null:t.slice(r,o+1)},x=(e,t)=>{let r=e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"],o=t.length>0?t.map(e=>e.name).join(", "):"(пока нет категорий)";return["Страны и города: "+r.join(" | "),"Категории: "+o,"Если подходящего значения нет, предложи новое аккуратное название."].join("\n")},w=`Верни только JSON объект со следующей структурой:
{
  "categories": ["название категории"],
  "country": "название страны" или null,
  "city": "название города" или null
}`,j={category:"Выбери одну или несколько категорий, которые наилучшим образом описывают материал. Если подходящей категории нет, предложи новую аккуратную формулировку.",country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function O(e){try{let t;let{materialId:r}=await e.json();if(!r)return s.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let o=await l.db.getMaterialById(r);if(!o)return s.NextResponse.json({success:!1,error:"Material not found"},{status:404});let n=await l.db.getSettings(),a=n.ai_provider||"gemini",i=n.gemini_api_key,c=n.claude_api_key,y=n.gemini_model||"gemini-2.5-flash",O=n.claude_model||"claude-3-haiku-20240307",I="claude"===a?c:i;if(!I)return s.NextResponse.json({success:!1,error:`API key for ${a} is not configured`},{status:400});let b=await l.db.getTaxonomy(),_=x(b.countries,b.categories),P=n.taxonomy_system_prompt||"Ты — редактор аналитического портала. Определи подходящие категории, а также страну и города, чтобы редакция могла быстро рубрицировать материалы.",k=n.taxonomy_prompt_category||j.category,S=n.taxonomy_prompt_country||j.country,$=n.taxonomy_prompt_city||j.city,N=n.taxonomy_format_prompt||w,C=o.fullContent||o.content||"",v=C.length>15e3?C.slice(0,15e3)+"...":C,A=[P,"ПРАВИЛА ДЛЯ КАЖДОГО ТИПА:",`Категория: ${k}`,`Страна: ${S}`,`Город: ${$}`,"КОНТЕКСТ ДОСТУПНЫХ ЗНАЧЕНИЙ:",_].filter(Boolean).join("\n\n"),F=["Определи подходящие категории, а также страну и города, связанные со статьёй.","","СТАТЬЯ:",`Заголовок: ${o.title}`,`Содержание: ${v}`,"","ФОРМАТ ОТВЕТА:",N,"","Только чистый JSON без markdown и дополнительного текста."].join("\n"),M=[A,F].filter(Boolean).join("\n\n"),T=await ("claude"===a?m(I,O,A,F):d(I,y,M)),J=h(T);if(!J)throw Error("Failed to extract JSON from AI response");try{t=JSON.parse(J)}catch(r){let e=null;try{t=u.Z.parse(J)}catch(o){e=o;try{let e=(0,p.K)(J);t=JSON.parse(e)}catch(t){throw console.error("Failed to parse taxonomy JSON:",t,"JSON5 error:",e,"Original error:",r,"Payload:",J),Error("Failed to parse taxonomy JSON from AI response")}}}let R=Array.isArray(t.categories)?t.categories:[],E=f(t.country),q=f(t.city),B=Object.prototype.hasOwnProperty.call(t,"categories"),K=Object.prototype.hasOwnProperty.call(t,"country"),U=Object.prototype.hasOwnProperty.call(t,"city"),D={},G=new Map;for(let e of b.categories)G.set(g(e.name),e);let L=async e=>{let t=g(e);if(0===t.length)return null;let r=G.get(t);if(r)return r;try{let r=await l.db.createTaxonomyItem("category",e);return G.set(t,r),b.categories.push(r),r}catch(t){return console.error("Failed to create category:",e,t),null}},Z=[],z=new Map;for(let e of b.countries)z.set(g(e.name),{...e,cities:e.cities??[]});let H=[],X=[],Q=K;if(B)for(let e of R){let t=f(e);if(!t)continue;let r=await L(t);r&&!Z.includes(r.id)&&Z.push(r.id)}let V=async e=>{let t=g(e);if(0===t.length)return null;let r=z.get(t);if(r)return r;try{let r=await l.db.createTaxonomyItem("country",e);if(r){let e={...r,cities:[]};return z.set(t,e),b.countries.push(e),e}}catch(t){console.error("Failed to create country:",e,t)}return null},W=new Map;for(let e of b.countries)for(let t of e.cities??[]){let e=g(t.name);W.has(e)||W.set(e,[]),W.get(e).push(t)}let Y=async(e,t)=>{let r=g(e);if(0===r.length)return null;let o=W.get(r)??[];if(o.length>0){let e=o.find(e=>!t||e.countryId===t)??o[0];return t&&e.countryId!==t&&!H.includes(e.countryId)&&(H.push(e.countryId),Q=!0),e}if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let n=await l.db.createTaxonomyItem("city",e,{countryId:t});W.has(r)||W.set(r,[]),W.get(r).push(n);let a=b.countries.find(e=>e.id===t);return a&&(a.cities=[...a.cities??[],n]),n};if(K&&E){let e=await V(E);e&&H.push(e.id)}if(U&&q){let e=null;if(E){let t=H[0]??null;e=await Y(q,t)}else{let t=g(q);for(let r of b.countries){let o=(r.cities??[]).find(e=>g(e.name)===t);if(o){e=o,H.includes(r.id)||H.push(r.id);break}}e||console.warn(`City "${q}" cannot be resolved without country reference. Skipping.`)}e&&(X.includes(e.id)||X.push(e.id),H.includes(e.countryId)||H.push(e.countryId),Q=!0)}if(B&&(D.categoryIds=Z),Q&&(D.countryIds=H),U&&(D.cityIds=X),Object.prototype.hasOwnProperty.call(D,"categoryIds")||Object.prototype.hasOwnProperty.call(D,"countryIds")||Object.prototype.hasOwnProperty.call(D,"cityIds"))try{await l.db.updateMaterialTaxonomy(r,D)}catch(e){return console.error("Failed to update taxonomy for material:",r,D,e),s.NextResponse.json({success:!1,error:"Failed to update taxonomy"},{status:500})}let ee=await l.db.getMaterialById(r);return s.NextResponse.json({success:!0,data:{material:ee,taxonomy:D}})}catch(e){return console.error("Error regenerating taxonomy:",e),s.NextResponse.json({success:!1,error:"Failed to regenerate taxonomy"},{status:500})}}let I=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/materials/regenerate-taxonomy/route",pathname:"/api/materials/regenerate-taxonomy",filename:"route",bundlePath:"app/api/materials/regenerate-taxonomy/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/regenerate-taxonomy/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:b,staticGenerationAsyncStorage:_,serverHooks:P}=I,k="/api/materials/regenerate-taxonomy/route";function S(){return(0,i.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:_})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[948,972,345,487],()=>r(768));module.exports=o})();