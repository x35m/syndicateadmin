"use strict";(()=>{var e={};e.id=730,e.ids=[730],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},768:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>_,requestAsyncStorage:()=>b,routeModule:()=>I,serverHooks:()=>P,staticGenerationAsyncStorage:()=>k});var o={};r.r(o),r.d(o,{POST:()=>O});var n=r(9303),a=r(8716),i=r(670),s=r(7070),l=r(9487),c=r(5392),u=r(7408),p=r(2908);async function d(e,t,r){let o=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!o.ok){let e=await o.text();throw Error(`Gemini API error: ${o.status} - ${e}`)}let n=await o.json();return n.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let y=["claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function m(e,t,r){let o=new c.ZP({apiKey:e}),n=t||y[0],a=new Set,i=[n,...y].filter(e=>!a.has(e)&&(a.add(e),!0)),s=null;for(let e of i)try{let t=await o.messages.create({model:e,max_tokens:4096,messages:[{role:"user",content:r}]}),a=("text"===t.content[0].type?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==n)try{await l.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return a}catch(a){let t=a?.error?.message||a?.message||"Unknown error",r=a?.error?.type||a?.type||"unknown",o=a?.status??a?.response?.status,n="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===o||n.includes("not found")||n.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),s=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(s?.message||"Claude API error: нет доступных моделей для выполнения запроса")}let g=e=>(e??"").normalize("NFKC").trim().toLowerCase(),f=e=>"string"==typeof e?e.trim():"",h=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),o=t.lastIndexOf("}");return -1===r||-1===o||o<=r?null:t.slice(r,o+1)},x=e=>["Страны и города: "+(e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"]).join(" | "),"Если подходящего значения нет, предложи новое аккуратное название."].join("\n"),w=`Верни только JSON объект со следующей структурой:
{
  "country": "название страны" или null,
  "city": "название города" или null
}`,j={country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function O(e){try{let t;let{materialId:r}=await e.json();if(!r)return s.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let o=await l.db.getMaterialById(r);if(!o)return s.NextResponse.json({success:!1,error:"Material not found"},{status:404});let n=await l.db.getSettings(),a=n.ai_provider||"gemini",i=n.gemini_api_key,c=n.claude_api_key,y=n.gemini_model||"gemini-2.5-flash",O=n.claude_model||"claude-3-haiku-20240307",I="claude"===a?c:i;if(!I)return s.NextResponse.json({success:!1,error:`API key for ${a} is not configured`},{status:400});let b=await l.db.getTaxonomy(),k=x(b.countries),P=n.taxonomy_prompt_country||j.country,S=n.taxonomy_prompt_city||j.city,_=n.taxonomy_format_prompt||w,N=o.fullContent||o.content||"",$=N.length>15e3?N.slice(0,15e3)+"...":N,C=["Проанализируй статью и определи подходящие значения таксономии.","","КОНТЕКСТ ДОСТУПНЫХ ЗНАЧЕНИЙ:",k,"","ПРАВИЛА ДЛЯ КАЖДОГО ТИПА:",`Страна: ${P}`,`Город: ${S}`,"","СТАТЬЯ:",`Заголовок: ${o.title}`,`Содержание: ${$}`,"",_,"","ВАЖНО: Верни только чистый JSON, без markdown разметки и дополнительного текста."].join("\n"),v=await ("claude"===a?m(I,O,C):d(I,y,C)),A=h(v);if(!A)throw Error("Failed to extract JSON from AI response");try{t=JSON.parse(A)}catch(r){let e=null;try{t=u.Z.parse(A)}catch(o){e=o;try{let e=(0,p.K)(A);t=JSON.parse(e)}catch(t){throw console.error("Failed to parse taxonomy JSON:",t,"JSON5 error:",e,"Original error:",r,"Payload:",A),Error("Failed to parse taxonomy JSON from AI response")}}}let F=f(t.country),M=f(t.city),J=Object.prototype.hasOwnProperty.call(t,"country"),R=Object.prototype.hasOwnProperty.call(t,"city"),T={},E=new Map;for(let e of b.countries)E.set(g(e.name),{...e,cities:e.cities??[]});let q=[],K=[],U=J,B=async e=>{let t=g(e);if(0===t.length)return null;let r=E.get(t);if(r)return r;try{let r=await l.db.createTaxonomyItem("country",e);if(r){let e={...r,cities:[]};return E.set(t,e),b.countries.push(e),e}}catch(t){console.error("Failed to create country:",e,t)}return null},D=new Map;for(let e of b.countries)for(let t of e.cities??[]){let e=g(t.name);D.has(e)||D.set(e,[]),D.get(e).push(t)}let G=async(e,t)=>{let r=g(e);if(0===r.length)return null;let o=D.get(r)??[];if(o.length>0){let e=o.find(e=>!t||e.countryId===t)??o[0];return t&&e.countryId!==t&&!q.includes(e.countryId)&&(q.push(e.countryId),U=!0),e}if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let n=await l.db.createTaxonomyItem("city",e,{countryId:t});D.has(r)||D.set(r,[]),D.get(r).push(n);let a=b.countries.find(e=>e.id===t);return a&&(a.cities=[...a.cities??[],n]),n};if(J&&F){let e=await B(F);e&&q.push(e.id)}if(R&&M){let e=null;if(F){let t=q[0]??null;e=await G(M,t)}else{let t=g(M);for(let r of b.countries){let o=(r.cities??[]).find(e=>g(e.name)===t);if(o){e=o,q.includes(r.id)||q.push(r.id);break}}e||console.warn(`City "${M}" cannot be resolved without country reference. Skipping.`)}e&&(K.includes(e.id)||K.push(e.id),q.includes(e.countryId)||q.push(e.countryId),U=!0)}if(U&&(T.countryIds=q),R&&(T.cityIds=K),Object.prototype.hasOwnProperty.call(T,"countryIds")||Object.prototype.hasOwnProperty.call(T,"cityIds"))try{await l.db.updateMaterialTaxonomy(r,T)}catch(e){return console.error("Failed to update taxonomy for material:",r,T,e),s.NextResponse.json({success:!1,error:"Failed to update taxonomy"},{status:500})}let L=await l.db.getMaterialById(r);return s.NextResponse.json({success:!0,data:{material:L,taxonomy:T}})}catch(e){return console.error("Error regenerating taxonomy:",e),s.NextResponse.json({success:!1,error:"Failed to regenerate taxonomy"},{status:500})}}let I=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/materials/regenerate-taxonomy/route",pathname:"/api/materials/regenerate-taxonomy",filename:"route",bundlePath:"app/api/materials/regenerate-taxonomy/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/regenerate-taxonomy/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:b,staticGenerationAsyncStorage:k,serverHooks:P}=I,S="/api/materials/regenerate-taxonomy/route";function _(){return(0,i.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:k})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[948,972,345,487],()=>r(768));module.exports=o})();