(()=>{var e={};e.id=6339,e.ids=[6339],e.modules={399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{"use strict";e.exports=require("pg")},9261:e=>{"use strict";e.exports=require("postcss")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},7310:e=>{"use strict";e.exports=require("url")},9796:e=>{"use strict";e.exports=require("zlib")},4263:()=>{},8256:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>f,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{POST:()=>p});var a=r(9303),i=r(8716),o=r(670),n=r(7070),l=r(9487),c=r(8546),u=r(7435);async function p(e){try{let{feedId:t}=await e.json();if(!t)return n.NextResponse.json({success:!1,error:"Feed ID is required"},{status:400});console.log(`[Local Feeds Import] Importing from feed ID: ${t}`);let r=await l.db.getFeedById(parseInt(t));if(!r)return n.NextResponse.json({success:!1,error:"Feed not found"},{status:404});if("active"!==r.status)return n.NextResponse.json({success:!1,error:"Импорт из неактивного фида отключен"},{status:400});let s=await c.g.parseFeed(r.url),a=await c.g.convertToMaterials(r.title||s.title,r.url,s.items);if(0===a.length)return n.NextResponse.json({success:!0,message:"No materials found in this feed",data:{fetched:0,new:0,updated:0,errors:0}});let i=await l.db.saveMaterials(a);return await l.db.updateFeedFetchTime(r.id),console.log(`[Local Feeds Import] Imported ${a.length} materials (${i.new} new, ${i.updated} updated)`),n.NextResponse.json({success:!0,message:"Materials imported successfully",data:{fetched:a.length,new:i.new,updated:i.updated,errors:i.errors}})}catch(e){return console.error("Error importing from local feed:",e),await (0,u.r)("api/local-feeds/import",e),n.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to import materials"},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/local-feeds/import/route",pathname:"/api/local-feeds/import",filename:"route",bundlePath:"app/api/local-feeds/import/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/local-feeds/import/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:h}=d,S="/api/local-feeds/import/route";function f(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},8546:(e,t,r)=>{"use strict";r.d(t,{g:()=>i});var s=r(2027);class a{async parseFeed(e){console.log(`[RSS Parser] Fetching feed: ${e}`);try{return await this.fetchDirect(e)}catch(t){if(console.warn("[RSS Parser] Direct fetch failed:",t),t instanceof Error&&t.message.includes("403"))return console.log("[RSS Parser] Trying via RSS proxy..."),await this.fetchViaProxy(e);throw t}}async fetchDirect(e){let t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"application/rss+xml, application/xml, application/atom+xml, text/xml, */*","Accept-Language":"uk-UA,uk;q=0.9,en;q=0.8,ru;q=0.7","Cache-Control":"no-cache",Referer:new URL(e).origin}});if(!t.ok)throw console.error(`[RSS Parser] HTTP ${t.status}: ${t.statusText}`),Error(`Не вдалося завантажити фід: HTTP ${t.status} - ${t.statusText}`);let r=await t.text();if(!r||0===r.trim().length)throw Error("Фід порожній або не містить даних");return console.log(`[RSS Parser] Received ${r.length} bytes of XML`),this.parseXML(r)}async fetchViaProxy(e){let t=[{name:"RSS2JSON",url:`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(e)}`,type:"json"},{name:"AllOrigins",url:`https://api.allorigins.win/raw?url=${encodeURIComponent(e)}`,type:"xml"},{name:"ThingProxy",url:`https://thingproxy.freeboard.io/fetch/${encodeURIComponent(e)}`,type:"xml"}],r=null;for(let e of t)try{console.log(`[RSS Parser] Trying ${e.name} proxy: ${e.url}`);let t=await fetch(e.url,{headers:{Accept:"application/json, application/xml, text/xml, */*"}});if(!t.ok){console.warn(`[RSS Parser] ${e.name} returned HTTP ${t.status}`),r=Error(`${e.name}: HTTP ${t.status}`);continue}if("json"===e.type){let s=await t.json();if("ok"!==s.status){console.warn("[RSS Parser] RSS2JSON error:",s.message),r=Error(`RSS2JSON: ${s.message||"Unknown error"}`);continue}return console.log(`[RSS Parser] ✅ ${e.name} success! Converting JSON to RSS format...`),this.convertRSS2JSONToFeed(s)}{let s=await t.text();if(!s||0===s.trim().length){console.warn(`[RSS Parser] ${e.name} returned empty response`),r=Error(`${e.name}: Empty response`);continue}return console.log(`[RSS Parser] ✅ ${e.name} success! Received ${s.length} bytes`),this.parseXML(s)}}catch(t){console.warn(`[RSS Parser] ${e.name} failed:`,t),r=t instanceof Error?t:Error(String(t));continue}throw console.error("[RSS Parser] All proxies failed"),Error(`Не вдалося завантажити фід навіть через проксі.

Остання помилка: ${r?.message||"Unknown"}

Можливі причини:
• Сайт блокує всі автоматичні запити
• Потрібна авторизація або Cookie
• Сайт недоступний

Спробуйте інший RSS фід або зверніться до адміністратора сайту.`)}convertRSS2JSONToFeed(e){let t={title:e.feed?.title||"RSS Feed",description:e.feed?.description||"",items:[]};return e.items&&Array.isArray(e.items)&&(t.items=e.items.map(t=>({title:t.title||"Без назви",link:t.link||t.guid||"",description:t.description||"",content:t.content||t.description||"",pubDate:t.pubDate||new Date().toISOString(),author:t.author||e.feed?.title||"",guid:t.guid||t.link||"",enclosure:t.enclosure?.link?{url:t.enclosure.link,type:t.enclosure.type||"image/jpeg"}:t.thumbnail?{url:t.thumbnail,type:"image/jpeg"}:void 0})),console.log(`[RSS Parser] Converted ${t.items.length} items from RSS2JSON`)),t}parseXML(e){let t=e.includes("<feed")&&e.includes('xmlns="http://www.w3.org/2005/Atom"');return(console.log(`[RSS Parser] Detected feed type: ${t?"Atom":"RSS"}`),console.log(`[RSS Parser] XML sample: ${e.substring(0,500)}...`),t)?this.parseAtom(e):this.parseRSS(e)}parseRSS(e){let t;let r={title:this.extractTag(e,"title")||"RSS Feed",description:this.extractTag(e,"description")||"",items:[]},s=/<item[^>]*>([\s\S]*?)<\/item>/gi;for(;null!==(t=s.exec(e));){let e=t[1],s={title:this.extractTag(e,"title")||"Без названия",link:this.extractTag(e,"link")||"",description:this.extractTag(e,"description")||"",content:this.extractTag(e,"content:encoded")||this.extractTag(e,"content")||"",pubDate:this.extractTag(e,"pubDate")||this.extractTag(e,"dc:date")||new Date().toISOString(),author:this.extractTag(e,"author")||this.extractTag(e,"dc:creator")||"",guid:this.extractTag(e,"guid")||""},a=e.match(/<enclosure[^>]*url=["']([^"']*)["'][^>]*type=["']([^"']*)["'][^>]*\/?>/);a&&(s.enclosure={url:a[1],type:a[2]}),r.items.push(s)}return console.log(`[RSS Parser] Parsed ${r.items.length} items from RSS feed`),0===r.items.length&&(console.warn("[RSS Parser] WARNING: No items found in RSS feed"),console.warn("[RSS Parser] Feed title:",r.title),console.warn("[RSS Parser] Feed description:",r.description)),r}parseAtom(e){let t;let r={title:this.extractTag(e,"title")||"Atom Feed",description:this.extractTag(e,"subtitle")||"",items:[]},s=/<entry[^>]*>([\s\S]*?)<\/entry>/gi;for(;null!==(t=s.exec(e));){let e=t[1],s=e.match(/<link[^>]*href=["']([^"']*)["']/),a={title:this.extractTag(e,"title")||"Без названия",link:s?s[1]:"",description:this.extractTag(e,"summary")||"",content:this.extractTag(e,"content")||"",pubDate:this.extractTag(e,"published")||this.extractTag(e,"updated")||new Date().toISOString(),author:this.extractTag(e,"author")||"",guid:this.extractTag(e,"id")||""};r.items.push(a)}return console.log(`[RSS Parser] Parsed ${r.items.length} items from Atom feed`),r}extractTag(e,t){let r=RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i"),s=e.match(r);return s&&s[1]?this.decodeHTML(s[1].replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g,"$1").trim()):null}decodeHTML(e){return e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(t))}async convertToMaterials(e,t,r){let a=[];for(let i of r){let r=i.content||i.description||"",o=r,n=this.extractFirstImage(r);if(!n&&i.enclosure&&i.enclosure.type.startsWith("image/")&&(n=i.enclosure.url),(!o||this.stripHtml(o).length<400)&&i.link&&i.link)try{let e=await (0,s.Kl)(i.link);if(e?.content){let t=e.content.trim();t.length>(o?.length??0)&&(o=t)}!n&&e?.image&&(n=e.image)}catch(e){console.warn(`[RSS Parser] Failed to extract article for ${i.link}:`,e)}o&&0!==o.trim().length||(o=r),n&&o&&!o.includes(n)&&(o=`<img src="${n}" alt="${i.title}" style="max-width: 100%; height: auto;" />`+o);let l=this.stripHtml(o||r);a.push({id:i.guid||i.link||`${t}-${Date.now()}-${Math.random()}`,title:i.title,content:l.substring(0,500),fullContent:o,thumbnail:n,author:i.author||e,createdAt:this.parseDate(i.pubDate),fetchedAt:new Date().toISOString(),link:i.link||i.guid,source:e||t,status:"new",processed:!1,published:!1})}return a}extractFirstImage(e){let t=e.match(/<img[^>]+src=["']([^"']+)["']/i);return t?t[1]:void 0}stripHtml(e){return e.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim()}parseDate(e){try{let t=new Date(e);if(isNaN(t.getTime()))return new Date().toISOString();return t.toISOString()}catch{return new Date().toISOString()}}}let i=new a}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,2027,7435],()=>r(8256));module.exports=s})();