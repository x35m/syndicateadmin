(()=>{var e={};e.id=250,e.ids=[250],e.modules={399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{"use strict";e.exports=require("pg")},9261:e=>{"use strict";e.exports=require("postcss")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},7310:e=>{"use strict";e.exports=require("url")},9796:e=>{"use strict";e.exports=require("zlib")},4263:()=>{},4845:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>w,requestAsyncStorage:()=>S,routeModule:()=>m,serverHooks:()=>x,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{DELETE:()=>h,GET:()=>d,PATCH:()=>g,POST:()=>p});var a=r(9303),o=r(8716),i=r(670),n=r(7070),l=r(9487),c=r(8546),u=r(7435);async function d(){try{let e=await l.db.getAllFeeds();return n.NextResponse.json({success:!0,data:e})}catch(e){return console.error("Error fetching local feeds:",e),await (0,u.r)("api/local-feeds",e,{method:"GET"}),n.NextResponse.json({success:!1,error:"Failed to fetch local feeds"},{status:500})}}async function p(e){try{let t;let{feedUrl:r}=await e.json();if(!r)return n.NextResponse.json({success:!1,error:"Feed URL is required"},{status:400});console.log(`[Local Feeds] Adding new feed: ${r}`);try{t=await c.g.parseFeed(r)}catch(t){console.error("[Local Feeds] Failed to parse feed:",t),await (0,u.r)("api/local-feeds",t,{method:"POST",feedUrl:r});let e="Не удалось загрузить или распарсить RSS фид.";return t instanceof Error&&(e=t.message),n.NextResponse.json({success:!1,error:e},{status:400})}if(!t.items||0===t.items.length)return console.warn("[Local Feeds] Feed has no items:",t),n.NextResponse.json({success:!1,error:"RSS фід успішно завантажений, але не містить жодних матеріалів. Це може бути порожній фід."},{status:400});let s=await l.db.addFeed(r,t.title,t.description);console.log("[Local Feeds] Feed added successfully:",s);let a=await c.g.convertToMaterials(t.title,r,t.items),o=await l.db.saveMaterials(a);return await l.db.updateFeedFetchTime(s.id),console.log(`[Local Feeds] Imported ${a.length} materials (${o.new} new, ${o.updated} updated)`),n.NextResponse.json({success:!0,message:"Feed added and materials imported successfully",data:{feed:s,stats:{fetched:a.length,new:o.new,updated:o.updated}}})}catch(e){return console.error("Error adding local feed:",e),await (0,u.r)("api/local-feeds",e,{method:"POST"}),n.NextResponse.json({success:!1,error:"Failed to add local feed"},{status:500})}}async function g(e){try{let{id:t,title:r}=await e.json();if(!t||!r)return n.NextResponse.json({success:!1,error:"Feed ID and title are required"},{status:400});return await l.db.updateFeedTitle(parseInt(t),r),n.NextResponse.json({success:!0,message:"Feed title updated successfully"})}catch(e){return console.error("Error updating feed title:",e),await (0,u.r)("api/local-feeds",e,{method:"PATCH"}),n.NextResponse.json({success:!1,error:"Failed to update feed title"},{status:500})}}async function h(e){try{let{searchParams:t}=new URL(e.url),r=t.get("id");if(!r)return n.NextResponse.json({success:!1,error:"Feed ID is required"},{status:400});return await l.db.deleteFeed(parseInt(r)),n.NextResponse.json({success:!0,message:"Feed deleted successfully"})}catch(e){return console.error("Error deleting local feed:",e),await (0,u.r)("api/local-feeds",e,{method:"DELETE"}),n.NextResponse.json({success:!1,error:"Failed to delete local feed"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/local-feeds/route",pathname:"/api/local-feeds",filename:"route",bundlePath:"app/api/local-feeds/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/local-feeds/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:S,staticGenerationAsyncStorage:f,serverHooks:x}=m,R="/api/local-feeds/route";function w(){return(0,i.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:f})}},8546:(e,t,r)=>{"use strict";r.d(t,{g:()=>o});var s=r(2027);class a{async parseFeed(e){console.log(`[RSS Parser] Fetching feed: ${e}`);try{return await this.fetchDirect(e)}catch(t){if(console.warn("[RSS Parser] Direct fetch failed:",t),t instanceof Error&&t.message.includes("403"))return console.log("[RSS Parser] Trying via RSS proxy..."),await this.fetchViaProxy(e);throw t}}async fetchDirect(e){let t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"application/rss+xml, application/xml, application/atom+xml, text/xml, */*","Accept-Language":"uk-UA,uk;q=0.9,en;q=0.8,ru;q=0.7","Cache-Control":"no-cache",Referer:new URL(e).origin}});if(!t.ok)throw console.error(`[RSS Parser] HTTP ${t.status}: ${t.statusText}`),Error(`Не вдалося завантажити фід: HTTP ${t.status} - ${t.statusText}`);let r=await t.text();if(!r||0===r.trim().length)throw Error("Фід порожній або не містить даних");return console.log(`[RSS Parser] Received ${r.length} bytes of XML`),this.parseXML(r)}async fetchViaProxy(e){let t=[{name:"RSS2JSON",url:`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(e)}`,type:"json"},{name:"AllOrigins",url:`https://api.allorigins.win/raw?url=${encodeURIComponent(e)}`,type:"xml"},{name:"ThingProxy",url:`https://thingproxy.freeboard.io/fetch/${encodeURIComponent(e)}`,type:"xml"}],r=null;for(let e of t)try{console.log(`[RSS Parser] Trying ${e.name} proxy: ${e.url}`);let t=await fetch(e.url,{headers:{Accept:"application/json, application/xml, text/xml, */*"}});if(!t.ok){console.warn(`[RSS Parser] ${e.name} returned HTTP ${t.status}`),r=Error(`${e.name}: HTTP ${t.status}`);continue}if("json"===e.type){let s=await t.json();if("ok"!==s.status){console.warn("[RSS Parser] RSS2JSON error:",s.message),r=Error(`RSS2JSON: ${s.message||"Unknown error"}`);continue}return console.log(`[RSS Parser] ✅ ${e.name} success! Converting JSON to RSS format...`),this.convertRSS2JSONToFeed(s)}{let s=await t.text();if(!s||0===s.trim().length){console.warn(`[RSS Parser] ${e.name} returned empty response`),r=Error(`${e.name}: Empty response`);continue}return console.log(`[RSS Parser] ✅ ${e.name} success! Received ${s.length} bytes`),this.parseXML(s)}}catch(t){console.warn(`[RSS Parser] ${e.name} failed:`,t),r=t instanceof Error?t:Error(String(t));continue}throw console.error("[RSS Parser] All proxies failed"),Error(`Не вдалося завантажити фід навіть через проксі.

Остання помилка: ${r?.message||"Unknown"}

Можливі причини:
• Сайт блокує всі автоматичні запити
• Потрібна авторизація або Cookie
• Сайт недоступний

Спробуйте інший RSS фід або зверніться до адміністратора сайту.`)}convertRSS2JSONToFeed(e){let t={title:e.feed?.title||"RSS Feed",description:e.feed?.description||"",items:[]};return e.items&&Array.isArray(e.items)&&(t.items=e.items.map(t=>({title:t.title||"Без назви",link:t.link||t.guid||"",description:t.description||"",content:t.content||t.description||"",pubDate:t.pubDate||new Date().toISOString(),author:t.author||e.feed?.title||"",guid:t.guid||t.link||"",enclosure:t.enclosure?.link?{url:t.enclosure.link,type:t.enclosure.type||"image/jpeg"}:t.thumbnail?{url:t.thumbnail,type:"image/jpeg"}:void 0})),console.log(`[RSS Parser] Converted ${t.items.length} items from RSS2JSON`)),t}parseXML(e){let t=e.includes("<feed")&&e.includes('xmlns="http://www.w3.org/2005/Atom"');return(console.log(`[RSS Parser] Detected feed type: ${t?"Atom":"RSS"}`),console.log(`[RSS Parser] XML sample: ${e.substring(0,500)}...`),t)?this.parseAtom(e):this.parseRSS(e)}parseRSS(e){let t;let r={title:this.extractTag(e,"title")||"RSS Feed",description:this.extractTag(e,"description")||"",items:[]},s=/<item[^>]*>([\s\S]*?)<\/item>/gi;for(;null!==(t=s.exec(e));){let e=t[1],s={title:this.extractTag(e,"title")||"Без названия",link:this.extractTag(e,"link")||"",description:this.extractTag(e,"description")||"",content:this.extractTag(e,"content:encoded")||this.extractTag(e,"content")||"",pubDate:this.extractTag(e,"pubDate")||this.extractTag(e,"dc:date")||new Date().toISOString(),author:this.extractTag(e,"author")||this.extractTag(e,"dc:creator")||"",guid:this.extractTag(e,"guid")||""},a=e.match(/<enclosure[^>]*url=["']([^"']*)["'][^>]*type=["']([^"']*)["'][^>]*\/?>/);a&&(s.enclosure={url:a[1],type:a[2]}),r.items.push(s)}return console.log(`[RSS Parser] Parsed ${r.items.length} items from RSS feed`),0===r.items.length&&(console.warn("[RSS Parser] WARNING: No items found in RSS feed"),console.warn("[RSS Parser] Feed title:",r.title),console.warn("[RSS Parser] Feed description:",r.description)),r}parseAtom(e){let t;let r={title:this.extractTag(e,"title")||"Atom Feed",description:this.extractTag(e,"subtitle")||"",items:[]},s=/<entry[^>]*>([\s\S]*?)<\/entry>/gi;for(;null!==(t=s.exec(e));){let e=t[1],s=e.match(/<link[^>]*href=["']([^"']*)["']/),a={title:this.extractTag(e,"title")||"Без названия",link:s?s[1]:"",description:this.extractTag(e,"summary")||"",content:this.extractTag(e,"content")||"",pubDate:this.extractTag(e,"published")||this.extractTag(e,"updated")||new Date().toISOString(),author:this.extractTag(e,"author")||"",guid:this.extractTag(e,"id")||""};r.items.push(a)}return console.log(`[RSS Parser] Parsed ${r.items.length} items from Atom feed`),r}extractTag(e,t){let r=RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i"),s=e.match(r);return s&&s[1]?this.decodeHTML(s[1].replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g,"$1").trim()):null}decodeHTML(e){return e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(t))}async convertToMaterials(e,t,r){let a=[];for(let o of r){let r=o.content||o.description||"",i=r,n=this.extractFirstImage(r);if(!n&&o.enclosure&&o.enclosure.type.startsWith("image/")&&(n=o.enclosure.url),(!i||this.stripHtml(i).length<400)&&o.link&&o.link)try{let e=await (0,s.Kl)(o.link);if(e?.content){let t=e.content.trim();t.length>(i?.length??0)&&(i=t)}!n&&e?.image&&(n=e.image)}catch(e){console.warn(`[RSS Parser] Failed to extract article for ${o.link}:`,e)}i&&0!==i.trim().length||(i=r),n&&i&&!i.includes(n)&&(i=`<img src="${n}" alt="${o.title}" style="max-width: 100%; height: auto;" />`+i);let l=this.stripHtml(i||r);a.push({id:o.guid||o.link||`${t}-${Date.now()}-${Math.random()}`,title:o.title,content:l.substring(0,500),fullContent:i,thumbnail:n,author:o.author||e,createdAt:this.parseDate(o.pubDate),fetchedAt:new Date().toISOString(),link:o.link||o.guid,source:e||t,status:"new",processed:!1,published:!1})}return a}extractFirstImage(e){let t=e.match(/<img[^>]+src=["']([^"']+)["']/i);return t?t[1]:void 0}stripHtml(e){return e.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim()}parseDate(e){try{let t=new Date(e);if(isNaN(t.getTime()))return new Date().toISOString();return t.toISOString()}catch{return new Date().toISOString()}}}let o=new a}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,972,27,435],()=>r(4845));module.exports=s})();