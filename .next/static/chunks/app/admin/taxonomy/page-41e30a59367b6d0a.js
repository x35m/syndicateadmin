(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{8363:function(e,s,a){Promise.resolve().then(a.bind(a,4880))},4880:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return S}});var l=a(7437),t=a(2265),n=a(6219),i=a(495),r=a(6013),c=a(6466),o=a(837),d=a(6910),m=a(3102),h=a(7135),x=a(2738),u=a(6975),j=a(5273),f=a(3146),p=a(7776),g=a(2237),y=a(5388),w=a(36),v=a(153),N=a(3925);let C={categories:[],themes:[],tags:[],alliances:[],countries:[]},b={categories:{label:"Категории",type:"category"},themes:{label:"Темы",type:"theme"},tags:{label:"Теги",type:"tag"},alliances:{label:"Политические союзы и блоки",type:"alliance"},countries:{label:"Страны",type:"country"},cities:{label:"Города",type:"city"}},k={category:"Промпт категорий",theme:"Промпт тем",tag:"Промпт тегов",alliance:"Промпт политических союзов и блоков",country:"Промпт стран",city:"Промпт городов"};function S(){var e,s;let[a,S]=(0,t.useState)("categories"),[A,z]=(0,t.useState)(C),[Z,O]=(0,t.useState)(!0),[E,X]=(0,t.useState)(null),[I,_]=(0,t.useState)(!1),[L,T]=(0,t.useState)(null),[F,M]=(0,t.useState)({category:"",theme:"",tag:"",alliance:"",country:"",city:""}),[P,U]=(0,t.useState)(!1),[$,D]=(0,t.useState)(!1),[R,Y]=(0,t.useState)({categories:"",themes:"",tags:"",alliances:"",countries:"",cities:""}),[J,V]=(0,t.useState)({categories:new Set,themes:new Set,tags:new Set,alliances:new Set,countries:new Set,cities:new Set}),W=(0,t.useMemo)(()=>A.countries.flatMap(e=>e.cities.map(s=>({...s,countryName:e.name}))),[A.countries]),q=async()=>{try{var e,s,a,l,t;O(!0);let n=await fetch("/api/taxonomy"),i=await n.json();if(!i.success){p.Am.error(i.error||"Не удалось получить данные таксономии");return}z({categories:null!==(e=i.categories)&&void 0!==e?e:[],themes:null!==(s=i.themes)&&void 0!==s?s:[],tags:null!==(a=i.tags)&&void 0!==a?a:[],alliances:null!==(l=i.alliances)&&void 0!==l?l:[],countries:null!==(t=i.countries)&&void 0!==t?t:[]})}catch(e){console.error("Error fetching taxonomy:",e),p.Am.error("Не удалось получить данные таксономии")}finally{O(!1)}},B=async()=>{try{U(!0);let e=await fetch("/api/taxonomy/prompts"),s=await e.json();s.success&&s.data&&M(s.data)}catch(e){console.error("Error fetching taxonomy prompts:",e),p.Am.error("Не удалось загрузить системные промпты")}finally{U(!1)}};(0,t.useEffect)(()=>{q(),B()},[]);let K=(e,s)=>{V(a=>{let l=new Set(a[e]);return l.has(s)?l.delete(s):l.add(s),{...a,[e]:l}})},H=(e,s)=>{V(a=>{let l=new Set(a[e]);return s.every(e=>l.has(e))?s.forEach(e=>l.delete(e)):s.forEach(e=>l.add(e)),{...a,[e]:l}})},Q=e=>{V(s=>({...s,[e]:new Set}))},G=e=>{let s=b[e].type;X({mode:"create",type:s,name:"",countryId:"city"===s?null:void 0})},ee=(e,s,a,l)=>{let t=b[e].type;X({mode:"edit",type:t,id:s,name:a,countryId:"city"===t?null!=l?l:null:void 0})},es=async()=>{if(!E)return;let{mode:e,type:s,name:a,id:l,countryId:t}=E,n=a.trim();if(!n){p.Am.warning("Название не может быть пустым");return}if("city"===s&&!t){p.Am.warning("Выберите страну для города");return}try{if(_(!0),"create"===e){let e=await fetch("/api/taxonomy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:s,name:n,countryId:"city"===s?t:void 0})}),a=await e.json();if(!a.success){p.Am.error(a.error||"Не удалось создать элемент");return}p.Am.success("Элемент создан")}else if(void 0!==l){let e=await fetch("/api/taxonomy",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:s,id:l,name:n,countryId:"city"===s?t:void 0})}),a=await e.json();if(!e.ok||!a.success){p.Am.error(a.error||"Не удалось обновить элемент");return}p.Am.success("Элемент обновлён")}await q(),X(null)}catch(e){console.error("Error saving taxonomy item:",e),p.Am.error("Не удалось сохранить элемент")}finally{_(!1)}},ea=async(e,s)=>{try{let a=await fetch("/api/taxonomy?type=".concat(e,"&id=").concat(s),{method:"DELETE"}),l=await a.json();if(!a.ok||!l.success)return p.Am.error(l.error||"Не удалось удалить элемент"),!1;return!0}catch(e){return console.error("Error deleting taxonomy item:",e),p.Am.error("Не удалось удалить элемент"),!1}},el=async e=>{let s=Array.from(J[e]);if(0===s.length||!window.confirm("countries"===e?"Удалить выбранные страны? Все связанные города будут удалены.":"cities"===e?"Удалить выбранные города?":"Удалить выбранные элементы?"))return;let a=b[e].type;for(let e of s)if(!await ea(a,e))break;await q(),Q(e),p.Am.success("Удаление выполнено")},et=e=>{var s;let a=b[e].type;T({type:a,value:null!==(s=F[a])&&void 0!==s?s:""})},en=async()=>{if(!L)return;let{type:e,value:s}=L,a=s.trim();if(!a){p.Am.warning("Промпт не может быть пустым");return}try{D(!0);let s=await fetch("/api/taxonomy/prompts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:e,prompt:a})}),l=await s.json();if(!s.ok||!l.success){p.Am.error(l.error||"Не удалось сохранить промпт");return}M(s=>({...s,[e]:a})),p.Am.success("Промпт обновлён"),T(null)}catch(e){console.error("Error saving taxonomy prompt:",e),p.Am.error("Не удалось сохранить промпт")}finally{D(!1)}},ei=e=>{let s=R[e].toLowerCase(),a=A[e];return s?a.filter(e=>e.name.toLowerCase().includes(s)):a},er=(0,t.useMemo)(()=>{let e=R.countries.toLowerCase();return e?A.countries.filter(s=>s.name.toLowerCase().includes(e)):A.countries},[A.countries,R.countries]),ec=(0,t.useMemo)(()=>{let e=R.cities.toLowerCase();return e?W.filter(s=>s.name.toLowerCase().includes(e)||s.countryName.toLowerCase().includes(e)):W},[W,R.cities]),eo=J[a].size,ed=e=>{let s=ei(e),a=s.map(e=>e.id),t=J[e],n=b[e].type;return(0,l.jsxs)(r.Zb,{children:[(0,l.jsxs)(r.Ol,{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)(r.ll,{children:b[e].label}),(0,l.jsx)("p",{className:"text-sm text-muted-foreground mt-2",children:"Используйте таблицу для просмотра, редактирования и массового удаления."})]}),(0,l.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(m.I,{placeholder:"Поиск...",value:R[e],onChange:s=>Y(a=>({...a,[e]:s.target.value})),className:"h-9 w-full sm:w-48"}),(0,l.jsxs)(i.z,{variant:"outline",size:"sm",onClick:()=>et(e),disabled:P,children:[(0,l.jsx)(g.Z,{className:"mr-2 h-4 w-4"}),"Системный промпт"]})]}),(0,l.jsxs)(i.z,{size:"sm",onClick:()=>G(e),children:[(0,l.jsx)(y.Z,{className:"mr-2 h-4 w-4"}),"Добавить"]})]})]}),(0,l.jsx)(r.aY,{children:Z?(0,l.jsx)("div",{className:"space-y-2",children:Array.from({length:6}).map((e,s)=>(0,l.jsx)(x.O,{className:"h-10 w-full"},s))}):0===s.length?(0,l.jsx)("div",{className:"py-10 text-center text-sm text-muted-foreground",children:"Элементы не найдены."}):(0,l.jsxs)(u.iA,{children:[(0,l.jsx)(u.xD,{children:(0,l.jsxs)(u.SC,{children:[(0,l.jsx)(u.ss,{className:"w-12",children:(0,l.jsx)(c.X,{checked:s.length>0&&a.every(e=>t.has(e)),onCheckedChange:()=>H(e,a)})}),(0,l.jsx)(u.ss,{children:"Название"}),(0,l.jsx)(u.ss,{className:"w-16 text-right",children:"Действия"})]})}),(0,l.jsx)(u.RM,{children:s.map(s=>(0,l.jsxs)(u.SC,{children:[(0,l.jsx)(u.pj,{children:(0,l.jsx)(c.X,{checked:t.has(s.id),onCheckedChange:()=>K(e,s.id)})}),(0,l.jsx)(u.pj,{className:"font-medium",children:s.name}),(0,l.jsx)(u.pj,{className:"text-right",children:(0,l.jsxs)(d.h_,{children:[(0,l.jsx)(d.$F,{asChild:!0,children:(0,l.jsx)(i.z,{variant:"ghost",size:"icon",className:"h-8 w-8",children:(0,l.jsx)(w.Z,{className:"h-4 w-4"})})}),(0,l.jsxs)(d.AW,{align:"end",children:[(0,l.jsxs)(d.Xi,{onClick:()=>ee(e,s.id,s.name),children:[(0,l.jsx)(v.Z,{className:"mr-2 h-4 w-4"}),"Редактировать"]}),(0,l.jsxs)(d.Xi,{onClick:async()=>{window.confirm("Удалить элемент?")&&await ea(n,s.id)&&(p.Am.success("Элемент удалён"),await q())},className:"text-destructive focus:text-destructive",children:[(0,l.jsx)(N.Z,{className:"mr-2 h-4 w-4"}),"Удалить"]})]})]})})]},s.id))})]})})]})};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.P,{}),(0,l.jsx)("div",{className:"min-h-screen bg-background p-8",children:(0,l.jsxs)("div",{className:"container space-y-6",children:[(0,l.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,l.jsx)("h1",{className:"text-3xl font-bold",children:"Справочники"}),(0,l.jsx)("p",{className:"text-muted-foreground max-w-2xl",children:"Управляйте таксономиями материалов, настраивайте системные промпты для нейросети и выполняйте массовые операции над элементами."})]}),(0,l.jsxs)(j.mQ,{value:a,onValueChange:e=>S(e),children:[(0,l.jsx)(j.dr,{className:"flex-wrap",children:Object.keys(b).map(e=>(0,l.jsx)(j.SP,{value:e,children:b[e].label},e))}),(0,l.jsx)(j.nU,{value:"categories",children:ed("categories")}),(0,l.jsx)(j.nU,{value:"themes",children:ed("themes")}),(0,l.jsx)(j.nU,{value:"tags",children:ed("tags")}),(0,l.jsx)(j.nU,{value:"alliances",children:ed("alliances")}),(0,l.jsx)(j.nU,{value:"countries",children:(()=>{let e="countries",s=J[e],a=er.map(e=>e.id);return(0,l.jsxs)(r.Zb,{children:[(0,l.jsxs)(r.Ol,{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)(r.ll,{children:"Страны"}),(0,l.jsx)("p",{className:"text-sm text-muted-foreground mt-2",children:"Управляйте списком стран и связанных городов."})]}),(0,l.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(m.I,{placeholder:"Поиск страны...",value:R.countries,onChange:e=>Y(s=>({...s,countries:e.target.value})),className:"h-9 w-full sm:w-56"}),(0,l.jsxs)(i.z,{variant:"outline",size:"sm",onClick:()=>et("countries"),disabled:P,children:[(0,l.jsx)(g.Z,{className:"mr-2 h-4 w-4"}),"Системный промпт"]})]}),(0,l.jsxs)(i.z,{size:"sm",onClick:()=>G("countries"),children:[(0,l.jsx)(y.Z,{className:"mr-2 h-4 w-4"}),"Добавить страну"]})]})]}),(0,l.jsx)(r.aY,{children:Z?(0,l.jsx)("div",{className:"space-y-2",children:Array.from({length:6}).map((e,s)=>(0,l.jsx)(x.O,{className:"h-10 w-full"},s))}):0===er.length?(0,l.jsx)("div",{className:"py-10 text-center text-sm text-muted-foreground",children:"Страны не найдены."}):(0,l.jsxs)(u.iA,{children:[(0,l.jsx)(u.xD,{children:(0,l.jsxs)(u.SC,{children:[(0,l.jsx)(u.ss,{className:"w-12",children:(0,l.jsx)(c.X,{checked:er.length>0&&a.every(e=>s.has(e)),onCheckedChange:()=>H(e,a)})}),(0,l.jsx)(u.ss,{children:"Название"}),(0,l.jsx)(u.ss,{className:"w-24 text-right",children:"Городов"}),(0,l.jsx)(u.ss,{className:"w-16 text-right",children:"Действия"})]})}),(0,l.jsx)(u.RM,{children:er.map(a=>(0,l.jsxs)(u.SC,{children:[(0,l.jsx)(u.pj,{children:(0,l.jsx)(c.X,{checked:s.has(a.id),onCheckedChange:()=>K(e,a.id)})}),(0,l.jsx)(u.pj,{className:"font-medium",children:a.name}),(0,l.jsx)(u.pj,{className:"text-right",children:a.cities.length}),(0,l.jsx)(u.pj,{className:"text-right",children:(0,l.jsxs)(d.h_,{children:[(0,l.jsx)(d.$F,{asChild:!0,children:(0,l.jsx)(i.z,{variant:"ghost",size:"icon",className:"h-8 w-8",children:(0,l.jsx)(w.Z,{className:"h-4 w-4"})})}),(0,l.jsxs)(d.AW,{align:"end",children:[(0,l.jsxs)(d.Xi,{onClick:()=>ee("countries",a.id,a.name),children:[(0,l.jsx)(v.Z,{className:"mr-2 h-4 w-4"}),"Редактировать"]}),(0,l.jsxs)(d.Xi,{onClick:async()=>{window.confirm("Удалить страну и все связанные города?")&&await ea("country",a.id)&&(p.Am.success("Страна удалена"),await q())},className:"text-destructive focus:text-destructive",children:[(0,l.jsx)(N.Z,{className:"mr-2 h-4 w-4"}),"Удалить"]})]})]})})]},a.id))})]})})]})})()}),(0,l.jsx)(j.nU,{value:"cities",children:(()=>{let e="cities",s=J[e],a=ec.map(e=>e.id);return(0,l.jsxs)(r.Zb,{children:[(0,l.jsxs)(r.Ol,{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)(r.ll,{children:"Города"}),(0,l.jsx)("p",{className:"text-sm text-muted-foreground mt-2",children:"Управляйте списком городов и их принадлежностью к странам."})]}),(0,l.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(m.I,{placeholder:"Поиск города или страны...",value:R.cities,onChange:e=>Y(s=>({...s,cities:e.target.value})),className:"h-9 w-full sm:w-64"}),(0,l.jsxs)(i.z,{variant:"outline",size:"sm",onClick:()=>et("cities"),disabled:P,children:[(0,l.jsx)(g.Z,{className:"mr-2 h-4 w-4"}),"Системный промпт"]})]}),(0,l.jsxs)(i.z,{size:"sm",onClick:()=>G("cities"),children:[(0,l.jsx)(y.Z,{className:"mr-2 h-4 w-4"}),"Добавить город"]})]})]}),(0,l.jsx)(r.aY,{children:Z?(0,l.jsx)("div",{className:"space-y-2",children:Array.from({length:6}).map((e,s)=>(0,l.jsx)(x.O,{className:"h-10 w-full"},s))}):0===ec.length?(0,l.jsx)("div",{className:"py-10 text-center text-sm text-muted-foreground",children:"Города не найдены."}):(0,l.jsxs)(u.iA,{children:[(0,l.jsx)(u.xD,{children:(0,l.jsxs)(u.SC,{children:[(0,l.jsx)(u.ss,{className:"w-12",children:(0,l.jsx)(c.X,{checked:ec.length>0&&a.every(e=>s.has(e)),onCheckedChange:()=>H(e,a)})}),(0,l.jsx)(u.ss,{children:"Город"}),(0,l.jsx)(u.ss,{children:"Страна"}),(0,l.jsx)(u.ss,{className:"w-16 text-right",children:"Действия"})]})}),(0,l.jsx)(u.RM,{children:ec.map(a=>(0,l.jsxs)(u.SC,{children:[(0,l.jsx)(u.pj,{children:(0,l.jsx)(c.X,{checked:s.has(a.id),onCheckedChange:()=>K(e,a.id)})}),(0,l.jsx)(u.pj,{className:"font-medium",children:a.name}),(0,l.jsx)(u.pj,{children:a.countryName}),(0,l.jsx)(u.pj,{className:"text-right",children:(0,l.jsxs)(d.h_,{children:[(0,l.jsx)(d.$F,{asChild:!0,children:(0,l.jsx)(i.z,{variant:"ghost",size:"icon",className:"h-8 w-8",children:(0,l.jsx)(w.Z,{className:"h-4 w-4"})})}),(0,l.jsxs)(d.AW,{align:"end",children:[(0,l.jsxs)(d.Xi,{onClick:()=>ee("cities",a.id,a.name,a.countryId),children:[(0,l.jsx)(v.Z,{className:"mr-2 h-4 w-4"}),"Редактировать"]}),(0,l.jsxs)(d.Xi,{onClick:async()=>{window.confirm("Удалить город?")&&await ea("city",a.id)&&(p.Am.success("Город удалён"),await q())},className:"text-destructive focus:text-destructive",children:[(0,l.jsx)(N.Z,{className:"mr-2 h-4 w-4"}),"Удалить"]})]})]})})]},a.id))})]})})]})})()})]})]})}),(0,l.jsx)(o.Vq,{open:null!==E,onOpenChange:e=>!e&&X(null),children:(0,l.jsxs)(o.cZ,{className:"sm:max-w-lg",children:[(0,l.jsxs)(o.fK,{children:[(0,l.jsx)(o.$N,{children:(null==E?void 0:E.mode)==="create"?"Создать элемент":"Редактировать элемент"}),(0,l.jsx)(o.Be,{children:E?"Тип: ".concat(b[null!==(e=Object.keys(b).find(e=>b[e].type===E.type))&&void 0!==e?e:"categories"].label):""})]}),E&&(0,l.jsxs)("div",{className:"space-y-4 py-2",children:[(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(h._,{htmlFor:"taxonomy-name",children:"Название"}),(0,l.jsx)(m.I,{id:"taxonomy-name",value:E.name,onChange:e=>X(s=>s?{...s,name:e.target.value}:s),autoFocus:!0})]}),"city"===E.type&&(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(h._,{htmlFor:"taxonomy-country",children:"Страна"}),(0,l.jsxs)("select",{id:"taxonomy-country",className:"w-full rounded-md border bg-background px-3 py-2 text-sm",value:null!==(s=E.countryId)&&void 0!==s?s:"",onChange:e=>X(s=>s?{...s,countryId:e.target.value?Number(e.target.value):null}:s),children:[(0,l.jsx)("option",{value:"",children:"Выберите страну"}),A.countries.map(e=>(0,l.jsx)("option",{value:e.id,children:e.name},e.id))]})]})]}),(0,l.jsxs)(o.cN,{children:[(0,l.jsx)(i.z,{variant:"outline",onClick:()=>X(null),disabled:I,children:"Отмена"}),(0,l.jsx)(i.z,{onClick:es,disabled:I,children:I?"Сохранение...":"Сохранить"})]})]})}),(0,l.jsx)(o.Vq,{open:null!==L,onOpenChange:e=>!e&&T(null),children:(0,l.jsxs)(o.cZ,{className:"sm:max-w-xl",children:[(0,l.jsxs)(o.fK,{children:[(0,l.jsx)(o.$N,{children:L?k[L.type]:"Системный промпт"}),(0,l.jsx)(o.Be,{children:"Опишите правила для нейросети при назначении значений этого справочника."})]}),L&&(0,l.jsx)(f.g,{rows:8,value:L.value,onChange:e=>T(s=>s?{...s,value:e.target.value}:s),className:"resize-none"}),(0,l.jsxs)(o.cN,{children:[(0,l.jsx)(i.z,{variant:"outline",onClick:()=>T(null),disabled:$,children:"Отмена"}),(0,l.jsx)(i.z,{onClick:en,disabled:$,children:$?"Сохранение...":"Сохранить"})]})]})}),eo>0&&(0,l.jsx)("div",{className:"fixed bottom-6 left-1/2 z-40 -translate-x-1/2",children:(0,l.jsx)(r.Zb,{className:"border-primary shadow-xl",children:(0,l.jsxs)(r.aY,{className:"flex items-center gap-4 py-3 px-6",children:[(0,l.jsxs)("span",{className:"text-sm",children:["Выбрано:"," ",(0,l.jsx)("span",{className:"font-semibold text-primary",children:eo})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsxs)(i.z,{variant:"destructive",size:"sm",onClick:()=>el(a),children:[(0,l.jsx)(N.Z,{className:"mr-2 h-4 w-4"}),"Удалить"]}),(0,l.jsx)(i.z,{variant:"ghost",size:"sm",onClick:()=>Q(a),children:"Сбросить"})]})]})})})]})}},3146:function(e,s,a){"use strict";a.d(s,{g:function(){return i}});var l=a(7437),t=a(2265),n=a(7440);let i=t.forwardRef((e,s)=>{let{className:a,...t}=e;return(0,l.jsx)("textarea",{className:(0,n.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),ref:s,...t})});i.displayName="Textarea"}},function(e){e.O(0,[876,776,138,522,402,220,89,971,23,744],function(){return e(e.s=8363)}),_N_E=e.O()}]);