exports.id=424,exports.ids=[424],exports.modules={4263:()=>{},7328:(e,t,r)=>{"use strict";r.r(t),r.d(t,{fetchAndSaveMaterials:()=>d,initCronJob:()=>u,runInitialFetch:()=>g});var n=r(3258),a=r.n(n),i=r(9487),o=r(8546),s=r(825),l=r(7435);let c=!1;async function d(e){if(c){console.log("Previous fetch still running, skipping...");return}c=!0,console.log(`[${new Date().toISOString()}] Starting RSS synchronization...`);try{let t=0,r=0,n=0,a=0,c=(e?.feedIds&&e.feedIds.length>0?await i.db.getFeedsByIds(e.feedIds):await i.db.getActiveFeeds()).filter(e=>"active"===e.status);if(0===c.length)return console.log(`[${new Date().toISOString()}] No RSS feeds selected or active. Add feeds via admin panel.`),{fetched:0,new:0,updated:0,errors:0};for(let e of(console.log(`[${new Date().toISOString()}] Syncing ${c.length} RSS feeds...`),c))try{console.log(`[${new Date().toISOString()}] Fetching ${e.title||e.url}...`);let l=await o.g.parseFeed(e.url),c=await o.g.convertToMaterials(e.title||l.title,e.url,l.items),d=await i.db.saveMaterials(c);for(let o of(await i.db.updateFeedFetchTime(e.id),t+=c.length,r+=d.new,n+=d.updated,a+=d.errors,(0,s.WL)({feed:e.title||e.url,new:d.new,updated:d.updated,total:c.length}),d.newMaterials))(0,s.Bk)(o);console.log(`[${new Date().toISOString()}] ${e.title}: ${c.length} fetched, ${d.new} new, ${d.updated} updated`)}catch(t){console.error(`[${new Date().toISOString()}] Error syncing feed ${e.title}:`,t),await (0,l.r)("cron/fetch-feed",t,{feedId:e.id,feedTitle:e.title,feedUrl:e.url}),a++}return(0,s.t6)({new:r,updated:n,errors:a}),console.log(`[${new Date().toISOString()}] ‚úÖ Sync completed:`),console.log(`  üì• New materials: ${r}`),console.log(`  üîÑ Updated materials: ${n}`),console.log(`  ‚ùå Errors: ${a}`),console.log(`  üìä Total processed: ${t}`),{fetched:t,new:r,updated:n,errors:a}}catch(e){throw console.error("Error in fetchAndSaveMaterials:",e),await (0,l.r)("cron/fetch-and-save",e),e}finally{c=!1}}function u(){let e=a().schedule("*/5 * * * *",async()=>{try{await d()}catch(e){console.error("Cron job error:",e),await (0,l.r)("cron/job",e)}});return console.log("Cron job initialized: running every 5 minutes"),e}async function g(){try{await i.db.init(),await d()}catch(e){console.error("Initial fetch error:",e),await (0,l.r)("cron/initial-fetch",e)}}},8546:(e,t,r)=>{"use strict";r.d(t,{g:()=>i});var n=r(2027);class a{async parseFeed(e){console.log(`[RSS Parser] Fetching feed: ${e}`);try{return await this.fetchDirect(e)}catch(t){if(console.warn("[RSS Parser] Direct fetch failed:",t),t instanceof Error&&t.message.includes("403"))return console.log("[RSS Parser] Trying via RSS proxy..."),await this.fetchViaProxy(e);throw t}}async fetchDirect(e){let t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"application/rss+xml, application/xml, application/atom+xml, text/xml, */*","Accept-Language":"uk-UA,uk;q=0.9,en;q=0.8,ru;q=0.7","Cache-Control":"no-cache",Referer:new URL(e).origin}});if(!t.ok)throw console.error(`[RSS Parser] HTTP ${t.status}: ${t.statusText}`),Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ—ñ–¥: HTTP ${t.status} - ${t.statusText}`);let r=await t.text();if(!r||0===r.trim().length)throw Error("–§—ñ–¥ –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω–∏—Ö");return console.log(`[RSS Parser] Received ${r.length} bytes of XML`),this.parseXML(r)}async fetchViaProxy(e){let t=[{name:"RSS2JSON",url:`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(e)}`,type:"json"},{name:"AllOrigins",url:`https://api.allorigins.win/raw?url=${encodeURIComponent(e)}`,type:"xml"},{name:"ThingProxy",url:`https://thingproxy.freeboard.io/fetch/${encodeURIComponent(e)}`,type:"xml"}],r=null;for(let e of t)try{console.log(`[RSS Parser] Trying ${e.name} proxy: ${e.url}`);let t=await fetch(e.url,{headers:{Accept:"application/json, application/xml, text/xml, */*"}});if(!t.ok){console.warn(`[RSS Parser] ${e.name} returned HTTP ${t.status}`),r=Error(`${e.name}: HTTP ${t.status}`);continue}if("json"===e.type){let n=await t.json();if("ok"!==n.status){console.warn("[RSS Parser] RSS2JSON error:",n.message),r=Error(`RSS2JSON: ${n.message||"Unknown error"}`);continue}return console.log(`[RSS Parser] ‚úÖ ${e.name} success! Converting JSON to RSS format...`),this.convertRSS2JSONToFeed(n)}{let n=await t.text();if(!n||0===n.trim().length){console.warn(`[RSS Parser] ${e.name} returned empty response`),r=Error(`${e.name}: Empty response`);continue}return console.log(`[RSS Parser] ‚úÖ ${e.name} success! Received ${n.length} bytes`),this.parseXML(n)}}catch(t){console.warn(`[RSS Parser] ${e.name} failed:`,t),r=t instanceof Error?t:Error(String(t));continue}throw console.error("[RSS Parser] All proxies failed"),Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ—ñ–¥ –Ω–∞–≤—ñ—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å—ñ.

–û—Å—Ç–∞–Ω–Ω—è –ø–æ–º–∏–ª–∫–∞: ${r?.message||"Unknown"}

–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:
‚Ä¢ –°–∞–π—Ç –±–ª–æ–∫—É—î –≤—Å—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ –∑–∞–ø–∏—Ç–∏
‚Ä¢ –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∞–±–æ Cookie
‚Ä¢ –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π

–°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π RSS —Ñ—ñ–¥ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–∞–π—Ç—É.`)}convertRSS2JSONToFeed(e){let t={title:e.feed?.title||"RSS Feed",description:e.feed?.description||"",items:[]};return e.items&&Array.isArray(e.items)&&(t.items=e.items.map(t=>({title:t.title||"–ë–µ–∑ –Ω–∞–∑–≤–∏",link:t.link||t.guid||"",description:t.description||"",content:t.content||t.description||"",pubDate:t.pubDate||new Date().toISOString(),author:t.author||e.feed?.title||"",guid:t.guid||t.link||"",enclosure:t.enclosure?.link?{url:t.enclosure.link,type:t.enclosure.type||"image/jpeg"}:t.thumbnail?{url:t.thumbnail,type:"image/jpeg"}:void 0})),console.log(`[RSS Parser] Converted ${t.items.length} items from RSS2JSON`)),t}parseXML(e){let t=e.includes("<feed")&&e.includes('xmlns="http://www.w3.org/2005/Atom"');return(console.log(`[RSS Parser] Detected feed type: ${t?"Atom":"RSS"}`),console.log(`[RSS Parser] XML sample: ${e.substring(0,500)}...`),t)?this.parseAtom(e):this.parseRSS(e)}parseRSS(e){let t;let r={title:this.extractTag(e,"title")||"RSS Feed",description:this.extractTag(e,"description")||"",items:[]},n=/<item[^>]*>([\s\S]*?)<\/item>/gi;for(;null!==(t=n.exec(e));){let e=t[1],n={title:this.extractTag(e,"title")||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",link:this.extractTag(e,"link")||"",description:this.extractTag(e,"description")||"",content:this.extractTag(e,"content:encoded")||this.extractTag(e,"content")||"",pubDate:this.extractTag(e,"pubDate")||this.extractTag(e,"dc:date")||new Date().toISOString(),author:this.extractTag(e,"author")||this.extractTag(e,"dc:creator")||"",guid:this.extractTag(e,"guid")||""},a=e.match(/<enclosure[^>]*url=["']([^"']*)["'][^>]*type=["']([^"']*)["'][^>]*\/?>/);a&&(n.enclosure={url:a[1],type:a[2]}),r.items.push(n)}return console.log(`[RSS Parser] Parsed ${r.items.length} items from RSS feed`),0===r.items.length&&(console.warn("[RSS Parser] WARNING: No items found in RSS feed"),console.warn("[RSS Parser] Feed title:",r.title),console.warn("[RSS Parser] Feed description:",r.description)),r}parseAtom(e){let t;let r={title:this.extractTag(e,"title")||"Atom Feed",description:this.extractTag(e,"subtitle")||"",items:[]},n=/<entry[^>]*>([\s\S]*?)<\/entry>/gi;for(;null!==(t=n.exec(e));){let e=t[1],n=e.match(/<link[^>]*href=["']([^"']*)["']/),a={title:this.extractTag(e,"title")||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",link:n?n[1]:"",description:this.extractTag(e,"summary")||"",content:this.extractTag(e,"content")||"",pubDate:this.extractTag(e,"published")||this.extractTag(e,"updated")||new Date().toISOString(),author:this.extractTag(e,"author")||"",guid:this.extractTag(e,"id")||""};r.items.push(a)}return console.log(`[RSS Parser] Parsed ${r.items.length} items from Atom feed`),r}extractTag(e,t){let r=RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i"),n=e.match(r);return n&&n[1]?this.decodeHTML(n[1].replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g,"$1").trim()):null}decodeHTML(e){return e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(t))}async convertToMaterials(e,t,r){let a=[];for(let i of r){let r=i.content||i.description||"",o=r,s=this.extractFirstImage(r);if(!s&&i.enclosure&&i.enclosure.type.startsWith("image/")&&(s=i.enclosure.url),(!o||this.stripHtml(o).length<400)&&i.link&&i.link)try{let e=await (0,n.Kl)(i.link);if(e?.content){let t=e.content.trim();t.length>(o?.length??0)&&(o=t)}!s&&e?.image&&(s=e.image)}catch(e){console.warn(`[RSS Parser] Failed to extract article for ${i.link}:`,e)}o&&0!==o.trim().length||(o=r),s&&o&&!o.includes(s)&&(o=`<img src="${s}" alt="${i.title}" style="max-width: 100%; height: auto;" />`+o);let l=this.stripHtml(o||r);a.push({id:i.guid||i.link||`${t}-${Date.now()}-${Math.random()}`,title:i.title,content:l.substring(0,500),fullContent:o,thumbnail:s,author:i.author||e,createdAt:this.parseDate(i.pubDate),fetchedAt:new Date().toISOString(),link:i.link||i.guid,source:e||t,status:"new",processed:!1,published:!1})}return a}extractFirstImage(e){let t=e.match(/<img[^>]+src=["']([^"']+)["']/i);return t?t[1]:void 0}stripHtml(e){return e.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim()}parseDate(e){try{let t=new Date(e);if(isNaN(t.getTime()))return new Date().toISOString();return t.toISOString()}catch{return new Date().toISOString()}}}let i=new a},825:(e,t,r)=>{"use strict";r.d(t,{Bk:()=>o,HE:()=>a,WL:()=>s,t6:()=>l,xI:()=>i});let n=new Set;function a(e){n.add(e)}function i(e){n.delete(e)}function o(e){let t=`data: ${JSON.stringify({type:"new-material",data:e})}

`,r=new TextEncoder().encode(t);n.forEach(e=>{try{e.enqueue(r)}catch(t){n.delete(e)}})}function s(e){let t=`data: ${JSON.stringify({type:"sync-progress",data:e})}

`,r=new TextEncoder().encode(t);n.forEach(e=>{try{e.enqueue(r)}catch(t){n.delete(e)}})}function l(e){let t=`data: ${JSON.stringify({type:"sync-complete",data:e})}

`,r=new TextEncoder().encode(t);n.forEach(e=>{try{e.enqueue(r)}catch(t){n.delete(e)}})}}};