(()=>{var e={};e.id=475,e.ids=[475,424],e.modules={399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{"use strict";e.exports=require("pg")},9261:e=>{"use strict";e.exports=require("postcss")},2081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},1017:e=>{"use strict";e.exports=require("path")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},7310:e=>{"use strict";e.exports=require("url")},9796:e=>{"use strict";e.exports=require("zlib")},4263:()=>{},9762:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>S,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p});var n={};r.r(n),r.d(n,{POST:()=>l});var s=r(9303),i=r(8716),o=r(670),a=r(7070),c=r(7328);async function l(){try{let e=await (0,c.fetchAndSaveMaterials)();return a.NextResponse.json({success:!0,message:"Sync completed successfully",data:e})}catch(e){return console.error("Sync API Error:",e),a.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to sync materials"},{status:500})}}let u=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/sync/route",pathname:"/api/sync",filename:"route",bundlePath:"app/api/sync/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/sync/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:g}=u,h="/api/sync/route";function S(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}},7328:(e,t,r)=>{"use strict";r.r(t),r.d(t,{fetchAndSaveMaterials:()=>l,initCronJob:()=>u,runInitialFetch:()=>d});var n=r(3258),s=r.n(n),i=r(9487),o=r(8546),a=r(825);let c=!1;async function l(){if(c){console.log("Previous fetch still running, skipping...");return}c=!0,console.log(`[${new Date().toISOString()}] Starting RSS synchronization...`);try{let e=0,t=0,r=0,n=0,s=await i.db.getAllFeeds();if(0===s.length)return console.log(`[${new Date().toISOString()}] No RSS feeds configured. Add feeds via admin panel.`),{fetched:0,new:0,updated:0,errors:0};for(let c of(console.log(`[${new Date().toISOString()}] Syncing ${s.length} RSS feeds...`),s))try{console.log(`[${new Date().toISOString()}] Fetching ${c.title||c.url}...`);let s=await o.g.parseFeed(c.url),l=await o.g.convertToMaterials(c.title||s.title,c.url,s.items),u=await i.db.saveMaterials(l);for(let s of(await i.db.updateFeedFetchTime(c.id),e+=l.length,t+=u.new,r+=u.updated,n+=u.errors,(0,a.WL)({feed:c.title||c.url,new:u.new,updated:u.updated,total:l.length}),u.newMaterials))(0,a.Bk)(s);console.log(`[${new Date().toISOString()}] ${c.title}: ${l.length} fetched, ${u.new} new, ${u.updated} updated`)}catch(e){console.error(`[${new Date().toISOString()}] Error syncing feed ${c.title}:`,e),n++}return(0,a.t6)({new:t,updated:r,errors:n}),console.log(`[${new Date().toISOString()}] ‚úÖ Sync completed:`),console.log(`  üì• New materials: ${t}`),console.log(`  üîÑ Updated materials: ${r}`),console.log(`  ‚ùå Errors: ${n}`),console.log(`  üìä Total processed: ${e}`),{fetched:e,new:t,updated:r,errors:n}}catch(e){throw console.error("Error in fetchAndSaveMaterials:",e),e}finally{c=!1}}function u(){let e=s().schedule("*/5 * * * *",async()=>{try{await l()}catch(e){console.error("Cron job error:",e)}});return console.log("Cron job initialized: running every 5 minutes"),e}async function d(){try{await i.db.init(),await l()}catch(e){console.error("Initial fetch error:",e)}}},8546:(e,t,r)=>{"use strict";r.d(t,{g:()=>i});var n=r(2027);class s{async parseFeed(e){console.log(`[RSS Parser] Fetching feed: ${e}`);try{return await this.fetchDirect(e)}catch(t){if(console.warn("[RSS Parser] Direct fetch failed:",t),t instanceof Error&&t.message.includes("403"))return console.log("[RSS Parser] Trying via RSS proxy..."),await this.fetchViaProxy(e);throw t}}async fetchDirect(e){let t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"application/rss+xml, application/xml, application/atom+xml, text/xml, */*","Accept-Language":"uk-UA,uk;q=0.9,en;q=0.8,ru;q=0.7","Cache-Control":"no-cache",Referer:new URL(e).origin}});if(!t.ok)throw console.error(`[RSS Parser] HTTP ${t.status}: ${t.statusText}`),Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ—ñ–¥: HTTP ${t.status} - ${t.statusText}`);let r=await t.text();if(!r||0===r.trim().length)throw Error("–§—ñ–¥ –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω–∏—Ö");return console.log(`[RSS Parser] Received ${r.length} bytes of XML`),this.parseXML(r)}async fetchViaProxy(e){let t=[{name:"RSS2JSON",url:`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(e)}`,type:"json"},{name:"AllOrigins",url:`https://api.allorigins.win/raw?url=${encodeURIComponent(e)}`,type:"xml"},{name:"ThingProxy",url:`https://thingproxy.freeboard.io/fetch/${encodeURIComponent(e)}`,type:"xml"}],r=null;for(let e of t)try{console.log(`[RSS Parser] Trying ${e.name} proxy: ${e.url}`);let t=await fetch(e.url,{headers:{Accept:"application/json, application/xml, text/xml, */*"}});if(!t.ok){console.warn(`[RSS Parser] ${e.name} returned HTTP ${t.status}`),r=Error(`${e.name}: HTTP ${t.status}`);continue}if("json"===e.type){let n=await t.json();if("ok"!==n.status){console.warn("[RSS Parser] RSS2JSON error:",n.message),r=Error(`RSS2JSON: ${n.message||"Unknown error"}`);continue}return console.log(`[RSS Parser] ‚úÖ ${e.name} success! Converting JSON to RSS format...`),this.convertRSS2JSONToFeed(n)}{let n=await t.text();if(!n||0===n.trim().length){console.warn(`[RSS Parser] ${e.name} returned empty response`),r=Error(`${e.name}: Empty response`);continue}return console.log(`[RSS Parser] ‚úÖ ${e.name} success! Received ${n.length} bytes`),this.parseXML(n)}}catch(t){console.warn(`[RSS Parser] ${e.name} failed:`,t),r=t instanceof Error?t:Error(String(t));continue}throw console.error("[RSS Parser] All proxies failed"),Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ—ñ–¥ –Ω–∞–≤—ñ—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å—ñ.

–û—Å—Ç–∞–Ω–Ω—è –ø–æ–º–∏–ª–∫–∞: ${r?.message||"Unknown"}

–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:
‚Ä¢ –°–∞–π—Ç –±–ª–æ–∫—É—î –≤—Å—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ –∑–∞–ø–∏—Ç–∏
‚Ä¢ –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∞–±–æ Cookie
‚Ä¢ –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π

–°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π RSS —Ñ—ñ–¥ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–∞–π—Ç—É.`)}convertRSS2JSONToFeed(e){let t={title:e.feed?.title||"RSS Feed",description:e.feed?.description||"",items:[]};return e.items&&Array.isArray(e.items)&&(t.items=e.items.map(t=>({title:t.title||"–ë–µ–∑ –Ω–∞–∑–≤–∏",link:t.link||t.guid||"",description:t.description||"",content:t.content||t.description||"",pubDate:t.pubDate||new Date().toISOString(),author:t.author||e.feed?.title||"",guid:t.guid||t.link||"",enclosure:t.enclosure?.link?{url:t.enclosure.link,type:t.enclosure.type||"image/jpeg"}:t.thumbnail?{url:t.thumbnail,type:"image/jpeg"}:void 0})),console.log(`[RSS Parser] Converted ${t.items.length} items from RSS2JSON`)),t}parseXML(e){let t=e.includes("<feed")&&e.includes('xmlns="http://www.w3.org/2005/Atom"');return(console.log(`[RSS Parser] Detected feed type: ${t?"Atom":"RSS"}`),console.log(`[RSS Parser] XML sample: ${e.substring(0,500)}...`),t)?this.parseAtom(e):this.parseRSS(e)}parseRSS(e){let t;let r={title:this.extractTag(e,"title")||"RSS Feed",description:this.extractTag(e,"description")||"",items:[]},n=/<item[^>]*>([\s\S]*?)<\/item>/gi;for(;null!==(t=n.exec(e));){let e=t[1],n={title:this.extractTag(e,"title")||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",link:this.extractTag(e,"link")||"",description:this.extractTag(e,"description")||"",content:this.extractTag(e,"content:encoded")||this.extractTag(e,"content")||"",pubDate:this.extractTag(e,"pubDate")||this.extractTag(e,"dc:date")||new Date().toISOString(),author:this.extractTag(e,"author")||this.extractTag(e,"dc:creator")||"",guid:this.extractTag(e,"guid")||""},s=e.match(/<enclosure[^>]*url=["']([^"']*)["'][^>]*type=["']([^"']*)["'][^>]*\/?>/);s&&(n.enclosure={url:s[1],type:s[2]}),r.items.push(n)}return console.log(`[RSS Parser] Parsed ${r.items.length} items from RSS feed`),0===r.items.length&&(console.warn("[RSS Parser] WARNING: No items found in RSS feed"),console.warn("[RSS Parser] Feed title:",r.title),console.warn("[RSS Parser] Feed description:",r.description)),r}parseAtom(e){let t;let r={title:this.extractTag(e,"title")||"Atom Feed",description:this.extractTag(e,"subtitle")||"",items:[]},n=/<entry[^>]*>([\s\S]*?)<\/entry>/gi;for(;null!==(t=n.exec(e));){let e=t[1],n=e.match(/<link[^>]*href=["']([^"']*)["']/),s={title:this.extractTag(e,"title")||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",link:n?n[1]:"",description:this.extractTag(e,"summary")||"",content:this.extractTag(e,"content")||"",pubDate:this.extractTag(e,"published")||this.extractTag(e,"updated")||new Date().toISOString(),author:this.extractTag(e,"author")||"",guid:this.extractTag(e,"id")||""};r.items.push(s)}return console.log(`[RSS Parser] Parsed ${r.items.length} items from Atom feed`),r}extractTag(e,t){let r=RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i"),n=e.match(r);return n&&n[1]?this.decodeHTML(n[1].replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g,"$1").trim()):null}decodeHTML(e){return e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(t))}async convertToMaterials(e,t,r){let s=[];for(let i of r){let r=i.content||i.description||"",o=r,a=this.extractFirstImage(r);if(!a&&i.enclosure&&i.enclosure.type.startsWith("image/")&&(a=i.enclosure.url),(!o||this.stripHtml(o).length<400)&&i.link&&i.link)try{let e=await (0,n.Kl)(i.link);if(e?.content){let t=e.content.trim();t.length>(o?.length??0)&&(o=t)}!a&&e?.image&&(a=e.image)}catch(e){console.warn(`[RSS Parser] Failed to extract article for ${i.link}:`,e)}o&&0!==o.trim().length||(o=r),a&&o&&!o.includes(a)&&(o=`<img src="${a}" alt="${i.title}" style="max-width: 100%; height: auto;" />`+o);let c=this.stripHtml(o||r);s.push({id:i.guid||i.link||`${t}-${Date.now()}-${Math.random()}`,title:i.title,content:c.substring(0,500),fullContent:o,thumbnail:a,author:i.author||e,createdAt:this.parseDate(i.pubDate),fetchedAt:new Date().toISOString(),link:i.link||i.guid,source:e||t,status:"new",processed:!1,published:!1})}return s}extractFirstImage(e){let t=e.match(/<img[^>]+src=["']([^"']+)["']/i);return t?t[1]:void 0}stripHtml(e){return e.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim()}parseDate(e){try{let t=new Date(e);if(isNaN(t.getTime()))return new Date().toISOString();return t.toISOString()}catch{return new Date().toISOString()}}}let i=new s},825:(e,t,r)=>{"use strict";r.d(t,{Bk:()=>o,HE:()=>s,WL:()=>a,t6:()=>c,xI:()=>i});let n=new Set;function s(e){n.add(e)}function i(e){n.delete(e)}function o(e){let t=`data: ${JSON.stringify({type:"new-material",data:e})}

`,r=new TextEncoder().encode(t);n.forEach(e=>{try{e.enqueue(r)}catch(t){n.delete(e)}})}function a(e){let t=`data: ${JSON.stringify({type:"sync-progress",data:e})}

`,r=new TextEncoder().encode(t);n.forEach(e=>{try{e.enqueue(r)}catch(t){n.delete(e)}})}function c(e){let t=`data: ${JSON.stringify({type:"sync-complete",data:e})}

`,r=new TextEncoder().encode(t);n.forEach(e=>{try{e.enqueue(r)}catch(t){n.delete(e)}})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972,27,258,487],()=>r(9762));module.exports=n})();