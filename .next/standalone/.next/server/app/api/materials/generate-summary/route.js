"use strict";(()=>{var e={};e.id=145,e.ids=[145],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},7514:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>$,requestAsyncStorage:()=>N,routeModule:()=>j,serverHooks:()=>S,staticGenerationAsyncStorage:()=>I});var n={};r.r(n),r.d(n,{POST:()=>O});var o=r(9303),a=r(8716),s=r(670),i=r(7070),l=r(9487),c=r(5392),u=r(7408),p=r(2908);let d=`Ты - аналитик новостного контента. Проанализируй статью и предоставь структурированный результат.

ЗАДАЧИ:

1. META_DESCRIPTION (150-160 символов):
   - Краткое описание сути статьи для SEO
   - Нейтральный тон, максимально информативно
   - Для поисковых систем и социальных сетей

2. SUMMARY (3-5 предложений):
   - Выдели основные моменты и ключевые идеи
   - Профессиональный аналитический стиль
   - Полностью нейтральное изложение без эмоциональной окраски
   - Простой человеческий язык для комфортного восприятия
   - ВАЖНО: Перефразируй своими словами, НЕ копируй предложения из оригинала
   - SEO уникальность 90%+

3. SENTIMENT (тональность материала):
   - positive (позитивная)
   - neutral (нейтральная)
   - negative (негативная)

4. CONTENT_TYPE (тип контента):
   - purely_factual (новостная заметка, только факты)
   - mostly_factual (преимущественно факты с элементами анализа)
   - balanced (факты и мнения примерно поровну)
   - mostly_opinion (аналитика с мнениями)
   - purely_opinion (авторская колонка, редакционная статья)

5. TAXONOMY (классификация):
   - Определи страны и города, связанные с материалом

Ответ должен быть на русском языке в формате JSON с полями: meta_description, summary, sentiment, content_type, taxonomy.`,m={country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function y(e,t,r){let n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!n.ok){let e=await n.text();throw Error(`Gemini API error: ${n.status} - ${e}`)}let o=await n.json();return o.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let g=["claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function f(e,t,r,n){let o=new c.ZP({apiKey:e}),a=t||g[0],s=new Set,i=[a,...g].filter(e=>!s.has(e)&&(s.add(e),!0)),u=null;for(let e of i)try{let t=await o.messages.create({model:e,max_tokens:4096,system:r||void 0,messages:[{role:"user",content:n}]}),s=("text"===t.content[0].type?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==a)try{await l.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return s}catch(a){let t=a?.error?.message||a?.message||"Unknown error",r=a?.error?.type||a?.type||"unknown",n=a?.status??a?.response?.status,o="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===n||o.includes("not found")||o.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),u=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(u?.message||"Claude API error: нет доступных моделей для выполнения запроса")}let h=e=>(e??"").normalize("NFKC").trim().toLowerCase(),x=e=>"string"==typeof e?e.trim():"",w=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),n=t.lastIndexOf("}");return -1===r||-1===n||n<=r?null:t.slice(r,n+1)},_=e=>["Страны и города: "+(e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"]).join(" | "),"Если подходящего значения нет, предложи новое аккуратное название."].join("\n");async function O(e){try{let t,r;let{materialId:n}=await e.json();if(!n)return i.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let o=await l.db.getSettings(),a=o.ai_provider||"gemini",s=o.gemini_api_key,c=o.claude_api_key,g=o.gemini_model||"gemini-2.5-flash",O=o.claude_model||"claude-3-haiku-20240307",j=o.analysis_prompt||d,N=o.taxonomy_system_prompt;o.taxonomy_format_prompt;let I={country:o.taxonomy_prompt_country??m.country,city:o.taxonomy_prompt_city??m.city},S="claude"===a?c:s;if(!S)return i.NextResponse.json({success:!1,error:`${"claude"===a?"Claude":"Gemini"} API ключ не настроен. Перейдите в Настройки.`},{status:400});let v=await l.db.getMaterialById(n);if(!v)return i.NextResponse.json({success:!1,error:"Material not found"},{status:404});let $=v.fullContent||v.content;if(!$||0===$.trim().length)return i.NextResponse.json({success:!1,error:"Материал не содержит текста для анализа"},{status:400});$.length>15e3&&(console.log(`Content too long (${$.length}), truncating to 15000`),$=$.substring(0,15e3)+"...");let P=await l.db.getTaxonomy(),b=[j,N||"Ты — редактор аналитического портала. Определи страну и города статьи так, чтобы они помогали редакции быстро рубрицировать материалы.",`Правила для стран: ${I.country}`,`Правила для городов: ${I.city}`,"Вот доступные справочники для ориентира:",_(P.countries)].filter(Boolean).join("\n\n"),C=`Проанализируй статью и предоставь результат.

СТАТЬЯ:
${$}

Верни ответ строго в формате JSON:
{
  "meta_description": "150-160 символов для SEO, без ссылок на статью",
  "summary": "3-5 предложений с ключевыми фактами",
  "sentiment": "positive | neutral | negative",
  "content_type": "purely_factual | mostly_factual | balanced | mostly_opinion | purely_opinion",
  "taxonomy": {
    "country": "Название страны или null",
    "city": "Название города или null"
  }
}

Только чистый JSON без markdown, без дополнительного текста и комментариев.`,E=[b,C].filter(Boolean).join("\n\n");console.log(`Generating analysis for material ${n} using ${a}. Content length: ${$.length}`);try{t="claude"===a?await f(S,O,b,C):await y(S,g,E)}catch(t){console.error(`Error calling ${a} API:`,t);let e=t instanceof Error?t.message:"Unknown error";return i.NextResponse.json({success:!1,error:`Ошибка при обращении к ${"claude"===a?"Claude":"Gemini"} API: ${e}`},{status:500})}console.log(`${a} response (truncated):`,t.slice(0,500)+(t.length>500?"...":""));let T=w(t);if(!T)return console.error(`${a} response is not valid JSON. Full text:`,t),i.NextResponse.json({success:!1,error:`Нейросеть вернула ответ в неожиданном формате. Уточните промпт для JSON.`},{status:500});try{r=JSON.parse(T)}catch(t){let e=null;try{r=u.Z.parse(T)}catch(n){e=n;try{let e=(0,p.K)(T);r=JSON.parse(e)}catch(r){return console.error(`Failed to parse JSON from ${a}:`,r,"JSON5 error:",e,"Original error:",t,"Payload:",T),i.NextResponse.json({success:!1,error:"Не удалось разобрать JSON от нейросети. Проверьте формат ответа."},{status:500})}}}let k=x(r.summary),M=x(r.meta_description),R=r.sentiment,A=r.content_type;if(!k)return console.error("Summary is missing in parsed response:",r),i.NextResponse.json({success:!1,error:"Нейросеть не вернула саммари. Уточните промпт или повторите попытку."},{status:500});let J=r.taxonomy??{},F=Object.prototype.hasOwnProperty.call(J,"country"),q=Object.prototype.hasOwnProperty.call(J,"city"),D=null!==J.country?x(J.country):"",G=null!==J.city?x(J.city):"",U=new Map,B=new Map;P.countries.forEach(e=>{U.set(h(e.name),e),(e.cities??[]).forEach(e=>{let t=h(e.name);B.has(t)||B.set(t,[]),B.get(t)?.push(e)})});let K=async e=>{let t=h(e);if(0===t.length)return null;let r=U.get(t);if(r)return r;let n={...await l.db.createTaxonomyItem("country",e),cities:[]};return U.set(t,n),P.countries.push(n),n},Y=async(e,t)=>{let r=h(e);if(0===r.length)return null;let n=B.get(r)??[];if(n.length>0){let e=n.find(e=>!t||e.countryId===t)??n[0];return t&&e.countryId!==t&&!X.includes(e.countryId)&&(X.push(e.countryId),z=!0),e}if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let o=await l.db.createTaxonomyItem("city",e,{countryId:t});B.has(r)||B.set(r,[]),B.get(r).push(o);let a=P.countries.find(e=>e.id===t);if(a)a.cities=[...a.cities??[],o];else{let e=P.countries.find(e=>e.id===o.countryId);e&&(e.cities=[...e.cities??[],o])}return o},L={},X=[],Z=[],z=F;if(F&&D)try{let e=await K(D);e&&X.push(e.id)}catch(e){console.error("Failed to ensure country:",D,e)}if(q&&G)try{let e=await Y(G,X[0]??null);e&&(Z.includes(e.id)||Z.push(e.id),X.includes(e.countryId)||X.push(e.countryId),z=!0)}catch(e){console.error("Failed to ensure city:",G,e)}if(z&&(L.countryIds=X),q&&(L.cityIds=Z),await l.db.updateMaterialSummary(n,{summary:k,metaDescription:M||void 0,sentiment:R||void 0,contentType:A||void 0,setProcessed:!0}),Object.prototype.hasOwnProperty.call(L,"countryIds")||Object.prototype.hasOwnProperty.call(L,"cityIds"))try{await l.db.updateMaterialTaxonomy(n,L)}catch(e){console.error("Failed to update taxonomy for material:",n,L,e)}let H=await l.db.getMaterialById(n);return i.NextResponse.json({success:!0,data:{summary:k,metaDescription:M||void 0,sentiment:R||void 0,contentType:A||void 0,material:H}})}catch(e){return console.error("Error generating summary and taxonomy:",e),i.NextResponse.json({success:!1,error:"Failed to generate summary"},{status:500})}}let j=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/materials/generate-summary/route",pathname:"/api/materials/generate-summary",filename:"route",bundlePath:"app/api/materials/generate-summary/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/generate-summary/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:N,staticGenerationAsyncStorage:I,serverHooks:S}=j,v="/api/materials/generate-summary/route";function $(){return(0,s.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:I})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972,345,487],()=>r(7514));module.exports=n})();