"use strict";(()=>{var e={};e.id=145,e.ids=[145],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},7514:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>P,requestAsyncStorage:()=>O,routeModule:()=>j,serverHooks:()=>N,staticGenerationAsyncStorage:()=>I});var n={};r.r(n),r.d(n,{POST:()=>_});var o=r(9303),a=r(8716),s=r(670),i=r(7070),l=r(9487),c=r(5392),u=r(7408);let p=`Ты - аналитик новостного контента. Проанализируй статью и предоставь структурированный результат.

ЗАДАЧИ:

1. META_DESCRIPTION (150-160 символов):
   - Краткое описание сути статьи для SEO
   - Нейтральный тон, максимально информативно
   - Для поисковых систем и социальных сетей

2. SUMMARY (3-5 предложений):
   - Выдели основные моменты и ключевые идеи
   - Профессиональный аналитический стиль
   - Полностью нейтральное изложение без эмоциональной окраски
   - Простой человеческий язык для комфортного восприятия
   - ВАЖНО: Перефразируй своими словами, НЕ копируй предложения из оригинала
   - SEO уникальность 90%+

3. SENTIMENT (тональность материала):
   - positive (позитивная)
   - neutral (нейтральная)
   - negative (негативная)

4. CONTENT_TYPE (тип контента):
   - purely_factual (новостная заметка, только факты)
   - mostly_factual (преимущественно факты с элементами анализа)
   - balanced (факты и мнения примерно поровну)
   - mostly_opinion (аналитика с мнениями)
   - purely_opinion (авторская колонка, редакционная статья)

5. TAXONOMY (классификация):
   - Определи страны и города, связанные с материалом

Ответ должен быть на русском языке в формате JSON с полями: meta_description, summary, sentiment, content_type, taxonomy.`,d={country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function m(e,t,r){let n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!n.ok){let e=await n.text();throw Error(`Gemini API error: ${n.status} - ${e}`)}let o=await n.json();return o.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let y=["claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function g(e,t,r){let n=new c.ZP({apiKey:e}),o=t||y[0],a=new Set,s=[o,...y].filter(e=>!a.has(e)&&(a.add(e),!0)),i=null;for(let e of s)try{let t=await n.messages.create({model:e,max_tokens:4096,messages:[{role:"user",content:r}]}),a=("text"===t.content[0].type?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==o)try{await l.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return a}catch(a){let t=a?.error?.message||a?.message||"Unknown error",r=a?.error?.type||a?.type||"unknown",n=a?.status??a?.response?.status,o="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===n||o.includes("not found")||o.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),i=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(i?.message||"Claude API error: нет доступных моделей для выполнения запроса")}let f=e=>(e??"").normalize("NFKC").trim().toLowerCase(),h=e=>"string"==typeof e?e.trim():"",x=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),n=t.lastIndexOf("}");return -1===r||-1===n||n<=r?null:t.slice(r,n+1)},w=e=>["Страны и города: "+(e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"]).join(" | "),"Если подходящего значения нет, предложи новое аккуратное название."].join("\n");async function _(e){try{let t,r;let{materialId:n}=await e.json();if(!n)return i.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let o=await l.db.getSettings(),a=o.ai_provider||"gemini",s=o.gemini_api_key,c=o.claude_api_key,y=o.gemini_model||"gemini-2.5-flash",_=o.claude_model||"claude-3-haiku-20240307",j=o.analysis_prompt||p,O=o.taxonomy_system_prompt;o.taxonomy_format_prompt;let I={country:o.taxonomy_prompt_country??d.country,city:o.taxonomy_prompt_city??d.city},N="claude"===a?c:s;if(!N)return i.NextResponse.json({success:!1,error:`${"claude"===a?"Claude":"Gemini"} API ключ не настроен. Перейдите в Настройки.`},{status:400});let $=await l.db.getMaterialById(n);if(!$)return i.NextResponse.json({success:!1,error:"Material not found"},{status:404});let P=$.fullContent||$.content;if(!P||0===P.trim().length)return i.NextResponse.json({success:!1,error:"Материал не содержит текста для анализа"},{status:400});P.length>15e3&&(console.log(`Content too long (${P.length}), truncating to 15000`),P=P.substring(0,15e3)+"...");let S=await l.db.getTaxonomy(),b=[j,O||"Ты — редактор аналитического портала. Определи страну и города статьи так, чтобы они помогали редакции быстро рубрицировать материалы.",`Правила для стран: ${I.country}`,`Правила для городов: ${I.city}`,"Вот доступные справочники для ориентира:",w(S.countries),"Статья:",P].filter(Boolean).join("\n\n");console.log(`Generating analysis for material ${n} using ${a}. Content length: ${P.length}`);try{t="claude"===a?await g(N,_,b):await m(N,y,b)}catch(t){console.error(`Error calling ${a} API:`,t);let e=t instanceof Error?t.message:"Unknown error";return i.NextResponse.json({success:!1,error:`Ошибка при обращении к ${"claude"===a?"Claude":"Gemini"} API: ${e}`},{status:500})}console.log(`${a} response (truncated):`,t.slice(0,500)+(t.length>500?"...":""));let v=x(t);if(!v)return console.error(`${a} response is not valid JSON. Full text:`,t),i.NextResponse.json({success:!1,error:`Нейросеть вернула ответ в неожиданном формате. Уточните промпт для JSON.`},{status:500});try{r=JSON.parse(v)}catch(e){try{r=u.Z.parse(v)}catch(t){return console.error(`Failed to parse JSON from ${a}:`,t,"Original error:",e,v),i.NextResponse.json({success:!1,error:"Не удалось разобрать JSON от нейросети. Проверьте формат ответа."},{status:500})}}let C=h(r.summary),T=h(r.meta_description),E=r.sentiment,k=r.content_type;if(!C)return console.error("Summary is missing in parsed response:",r),i.NextResponse.json({success:!1,error:"Нейросеть не вернула саммари. Уточните промпт или повторите попытку."},{status:500});let M=r.taxonomy??{},R=Object.prototype.hasOwnProperty.call(M,"country"),A=Object.prototype.hasOwnProperty.call(M,"city"),F=null!==M.country?h(M.country):"",J=null!==M.city?h(M.city):"",q=new Map,D=new Map;S.countries.forEach(e=>{q.set(f(e.name),e),(e.cities??[]).forEach(e=>{let t=f(e.name);D.has(t)||D.set(t,[]),D.get(t)?.push(e)})});let G=async e=>{let t=f(e);if(0===t.length)return null;let r=q.get(t);if(r)return r;let n={...await l.db.createTaxonomyItem("country",e),cities:[]};return q.set(t,n),S.countries.push(n),n},U=async(e,t)=>{let r=f(e);if(0===r.length)return null;let n=D.get(r)??[];if(n.length>0){let e=n.find(e=>!t||e.countryId===t)??n[0];return t&&e.countryId!==t&&!Y.includes(e.countryId)&&(Y.push(e.countryId),L=!0),e}if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let o=await l.db.createTaxonomyItem("city",e,{countryId:t});D.has(r)||D.set(r,[]),D.get(r).push(o);let a=S.countries.find(e=>e.id===t);if(a)a.cities=[...a.cities??[],o];else{let e=S.countries.find(e=>e.id===o.countryId);e&&(e.cities=[...e.cities??[],o])}return o},B={},Y=[],K=[],L=R;if(R&&F)try{let e=await G(F);e&&Y.push(e.id)}catch(e){console.error("Failed to ensure country:",F,e)}if(A&&J)try{let e=await U(J,Y[0]??null);e&&(K.includes(e.id)||K.push(e.id),Y.includes(e.countryId)||Y.push(e.countryId),L=!0)}catch(e){console.error("Failed to ensure city:",J,e)}if(L&&(B.countryIds=Y),A&&(B.cityIds=K),await l.db.updateMaterialSummary(n,{summary:C,metaDescription:T||void 0,sentiment:E||void 0,contentType:k||void 0,setProcessed:!0}),Object.prototype.hasOwnProperty.call(B,"countryIds")||Object.prototype.hasOwnProperty.call(B,"cityIds"))try{await l.db.updateMaterialTaxonomy(n,B)}catch(e){console.error("Failed to update taxonomy for material:",n,B,e)}let X=await l.db.getMaterialById(n);return i.NextResponse.json({success:!0,data:{summary:C,metaDescription:T||void 0,sentiment:E||void 0,contentType:k||void 0,material:X}})}catch(e){return console.error("Error generating summary and taxonomy:",e),i.NextResponse.json({success:!1,error:"Failed to generate summary"},{status:500})}}let j=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/materials/generate-summary/route",pathname:"/api/materials/generate-summary",filename:"route",bundlePath:"app/api/materials/generate-summary/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/generate-summary/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:O,staticGenerationAsyncStorage:I,serverHooks:N}=j,$="/api/materials/generate-summary/route";function P(){return(0,s.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:I})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972,327,487],()=>r(7514));module.exports=n})();