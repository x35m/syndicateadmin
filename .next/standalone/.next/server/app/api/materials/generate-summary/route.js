"use strict";(()=>{var e={};e.id=145,e.ids=[145],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},7514:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>$,requestAsyncStorage:()=>j,routeModule:()=>_,serverHooks:()=>N,staticGenerationAsyncStorage:()=>v});var n={};r.r(n),r.d(n,{POST:()=>x});var a=r(9303),o=r(8716),i=r(670),s=r(7070),c=r(9487),l=r(5506),u=r(1456),p=r(7435);let m=`Ты - аналитик новостного контента. Проанализируй статью и предоставь структурированный результат.

ЗАДАЧИ:

1. META_DESCRIPTION (150-160 символов):
   - Краткое описание сути статьи для SEO
   - Нейтральный тон, максимально информативно
   - Для поисковых систем и социальных сетей

2. SUMMARY (3-5 предложений):
   - Выдели основные моменты и ключевые идеи
   - Профессиональный аналитический стиль
   - Полностью нейтральное изложение без эмоциональной окраски
   - Простой человеческий язык для комфортного восприятия
   - ВАЖНО: Перефразируй своими словами, НЕ копируй предложения из оригинала
   - SEO уникальность 90%+

3. SENTIMENT (тональность материала):
   - positive (позитивная)
   - neutral (нейтральная)
   - negative (негативная)

4. CONTENT_TYPE (тип контента):
   - purely_factual (новостная заметка, только факты)
   - mostly_factual (преимущественно факты с элементами анализа)
   - balanced (факты и мнения примерно поровну)
   - mostly_opinion (аналитика с мнениями)
   - purely_opinion (авторская колонка, редакционная статья)

5. TAXONOMY (классификация):
   - Определи подходящие категории, а также страны и города, связанные с материалом

Ответ должен быть на русском языке в формате JSON с полями: meta_description, summary, sentiment, content_type, taxonomy.`,d={category:"Выбери одну или несколько категорий, которые наилучшим образом описывают материал. Если подходящей категории нет, предложи новую аккуратную формулировку.",country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function y(e,t,r){let n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!n.ok){let e=await n.text();throw Error(`Gemini API error: ${n.status} - ${e}`)}let a=await n.json();return a.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let g=e=>(e??"").normalize("NFKC").trim().toLowerCase(),f=e=>"string"==typeof e?e.trim():"",h=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),n=t.lastIndexOf("}");return -1===r||-1===n||n<=r?null:t.slice(r,n+1)},w=(e,t)=>{let r=e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"],n=t.length>0?t.map(e=>e.name).join(", "):"(пока нет категорий)";return["Страны и города: "+r.join(" | "),"Категории: "+n,"Если подходящего значения нет, предложи новое аккуратное название."].join("\n")};async function x(e){let t;try{let r,n;let{materialId:a}=await e.json();if(t="string"==typeof a?a:void 0,!a)return s.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let o=await c.db.getSettings(),i=o.ai_provider||"gemini",x=o.gemini_api_key,_=o.claude_api_key,j=o.gemini_model||"gemini-2.5-flash",v=o.claude_model||u.y[0],N=o.analysis_prompt||m,S=o.taxonomy_system_prompt,$=o.taxonomy_format_prompt,O={category:o.taxonomy_prompt_category??d.category,country:o.taxonomy_prompt_country??d.country,city:o.taxonomy_prompt_city??d.city},C="claude"===i?_:x;if(!C)return s.NextResponse.json({success:!1,error:`${"claude"===i?"Claude":"Gemini"} API ключ не настроен. Перейдите в Настройки.`},{status:400});let I=await c.db.getMaterialById(a);if(!I)return s.NextResponse.json({success:!1,error:"Material not found"},{status:404});let b=I.fullContent||I.content;if(!b||0===b.trim().length)return s.NextResponse.json({success:!1,error:"Материал не содержит текста для анализа"},{status:400});b.length>15e3&&(console.log(`Content too long (${b.length}), truncating to 15000`),b=b.substring(0,15e3)+"...");let[T,E]=await Promise.all([c.db.getTaxonomy(),c.db.getCategoryExamples(15)]),k=[N,S||"Ты — редактор аналитического портала. Определи подходящие категории, а также страну и города статьи так, чтобы они помогали редакции быстро рубрицировать материалы.",`Правила для категорий: ${O.category}`,`Правила для стран: ${O.country}`,`Правила для городов: ${O.city}`,"Вот доступные справочники для ориентира:",w(T.countries,T.categories)].filter(Boolean).join("\n\n"),A=["Проанализируй статью и предоставь результат.","СТАТЬЯ:",b,"Верни ответ строго в формате JSON:",`{
  "meta_description": "150-160 символов для SEO, без ссылок на статью",
  "summary": "3-5 предложений с ключевыми фактами",
  "sentiment": "positive | neutral | negative",
  "content_type": "purely_factual | mostly_factual | balanced | mostly_opinion | purely_opinion",
  "taxonomy": {
    "categories": ["Название категории"],
    "country": "Название страны или null",
    "city": "Название города или null"
  }
}`];$&&A.push("Дополнительные требования к формату:",$),A.push("Только чистый JSON без markdown, без дополнительного текста и комментариев.");let P=A.join("\n\n"),J=[k,P].filter(Boolean).join("\n\n");console.log(`Generating analysis for material ${a} using ${i}. Content length: ${b.length}`);try{r="claude"===i?await (0,u.A)(C,v,k,P):await y(C,j,J)}catch(t){console.error(`Error calling ${i} API:`,t),await (0,p.r)("api/materials/generate-summary",t,{materialId:a,provider:i,phase:"call-model"});let e=t instanceof Error?t.message:"Unknown error";return s.NextResponse.json({success:!1,error:`Ошибка при обращении к ${"claude"===i?"Claude":"Gemini"} API: ${e}`},{status:500})}console.log(`${i} response (truncated):`,r.slice(0,500)+(r.length>500?"...":""));let M=h(r);if(!M)return console.error(`${i} response is not valid JSON. Full text:`,r),await (0,p.r)("api/materials/generate-summary","Invalid JSON payload",{materialId:a,provider:i,phase:"extract-json",responsePreview:r.slice(0,2e3)}),s.NextResponse.json({success:!1,error:`Нейросеть вернула ответ в неожиданном формате. Уточните промпт для JSON.`},{status:500});try{n=(0,l.Vu)(M)}catch(e){return console.error(`Failed to parse JSON from ${i}:`,e,"Payload:",M),await (0,p.r)("api/materials/generate-summary",e,{materialId:a,provider:i,phase:"parse-json",payloadSnippet:M.slice(0,2e3)}),s.NextResponse.json({success:!1,error:"Не удалось разобрать JSON от нейросети. Проверьте формат ответа."},{status:500})}let R=f(n.summary),F=f(n.meta_description),B=n.sentiment,D=n.content_type;if(!R)return console.error("Summary is missing in parsed response:",n),await (0,p.r)("api/materials/generate-summary","Missing summary in AI response",{materialId:a,provider:i,phase:"validate-json"}),s.NextResponse.json({success:!1,error:"Нейросеть не вернула саммари. Уточните промпт или повторите попытку."},{status:500});let q=await (0,l.D2)({materialId:a,articleText:b,materialTitle:I.title,categories:T.categories,examples:E,claudeApiKey:_,claudeModel:v}),K=n.taxonomy??{},G=Array.isArray(K.categories)?K.categories:[],L=K.country?f(K.country):"",U=K.city?f(K.city):"",z={},Y=[],V=[],X=[],Z=!1,H=new Map;T.categories.forEach(e=>{H.set(g(e.name),e)});let Q=async e=>{let t=g(e);if(0===t.length)return null;let r=H.get(t);if(r)return r;let n=await c.db.createTaxonomyItem("category",e);return H.set(t,n),T.categories.push(n),n},W=new Map,ee=new Map;T.countries.forEach(e=>{W.set(g(e.name),e),(e.cities??[]).forEach(e=>{let t=g(e.name);ee.has(t)||ee.set(t,[]),ee.get(t)?.push(e)})});let et=async e=>{let t=g(e);if(0===t.length)return null;let r=W.get(t);if(r)return r;let n={...await c.db.createTaxonomyItem("country",e),cities:[]};return W.set(t,n),T.countries.push(n),n},er=async(e,t)=>{let r=g(e);if(0===r.length)return null;let n=ee.get(r)??[];if(n.length>0){let e=n.find(e=>!t||e.countryId===t)??n[0];return t&&e.countryId!==t&&!V.includes(e.countryId)&&(V.push(e.countryId),Z=!0),e}if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let a=await c.db.createTaxonomyItem("city",e,{countryId:t});ee.has(r)||ee.set(r,[]),ee.get(r).push(a);let o=T.countries.find(e=>e.id===t);if(o)o.cities=[...o.cities??[],a];else{let e=T.countries.find(e=>e.id===a.countryId);e&&(e.cities=[...e.cities??[],a])}return a},en=[...q?.category?[q.category]:[],...G].map(e=>f(e)).filter(e=>e.length>0);if(en.length>0){for(let e of en)try{let t=await Q(e);t&&!Y.includes(t.id)&&Y.push(t.id)}catch(t){console.error("Failed to ensure category:",e,t)}z.categoryIds=Y}if(L)try{let e=await et(L);e&&(V.push(e.id),Z=!0)}catch(e){console.error("Failed to ensure country:",L,e)}if(U)try{let e=await er(U,V[0]??null);e&&(X.includes(e.id)||X.push(e.id),V.includes(e.countryId)||(V.push(e.countryId),Z=!0))}catch(e){console.error("Failed to ensure city:",U,e)}if(Z&&V.length>0&&(z.countryIds=V),X.length>0&&(z.cityIds=X),await c.db.updateMaterialSummary(a,{summary:R,metaDescription:F||void 0,sentiment:B||void 0,contentType:D||void 0,setProcessed:!0}),Object.keys(z).length>0)try{await c.db.updateMaterialTaxonomy(a,z)}catch(e){console.error("Failed to update taxonomy for material:",a,z,e)}let ea=await c.db.getMaterialById(a);return s.NextResponse.json({success:!0,data:{summary:R,metaDescription:F||void 0,sentiment:B||void 0,contentType:D||void 0,material:ea,classification:q?{category:q.category,confidence:q.confidence,supercategory:q.supercategory??null,reasoning:q.reasoning}:null}})}catch(e){return console.error("Error generating summary and taxonomy:",e),await (0,p.r)("api/materials/generate-summary",e,{materialId:t,phase:"handler"}),s.NextResponse.json({success:!1,error:"Failed to generate summary"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/materials/generate-summary/route",pathname:"/api/materials/generate-summary",filename:"route",bundlePath:"app/api/materials/generate-summary/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/generate-summary/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:j,staticGenerationAsyncStorage:v,serverHooks:N}=_,S="/api/materials/generate-summary/route";function $(){return(0,i.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:v})}},1456:(e,t,r)=>{r.d(t,{A:()=>i,y:()=>o});var n=r(5392),a=r(9487);let o=["claude-sonnet-4-20250514","claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function i(e,t,r,i,s){let c=new n.ZP({apiKey:e}),l=t||o[0],u=new Set,p=[l,...o].filter(e=>!u.has(e)&&(u.add(e),!0)),m=null;for(let e of p)try{let t=await c.messages.create({model:e,max_tokens:s?.maxTokens??4096,temperature:s?.temperature,system:r||void 0,messages:[{role:"user",content:i}]}),n=(t.content[0]?.type==="text"?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==l)try{await a.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return n}catch(o){let t=o?.error?.message||o?.message||"Unknown error",r=o?.error?.type||o?.type||"unknown",n=o?.status??o?.response?.status,a="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===n||a.includes("not found")||a.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),m=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(m?.message||"Claude API error: нет доступных моделей для выполнения запроса")}},5506:(e,t,r)=>{r.d(t,{D2:()=>h,Vu:()=>c});var n=r(9487),a=r(7408),o=r(2908),i=r(1456);let s=["Внутренняя Украина","Международное","Общее"],c=e=>{try{return JSON.parse(e)}catch(r){let t=null;try{return a.Z.parse(e)}catch(n){t=n;try{let t=(0,o.K)(e);return JSON.parse(t)}catch(e){throw Error(`Failed to parse JSON. First error: ${r.message}. JSON5 error: ${t instanceof Error?t.message:t}. Repair error: ${e instanceof Error?e.message:e}`)}}}},l=(e,t=.5)=>{let r="number"==typeof e?e:Number(e);return Number.isFinite(r)?r<0?0:r>1?1:r:t},u=e=>(e??"").normalize("NFKC").trim().toLowerCase(),p=e=>"string"==typeof e?e.trim():"",m=e=>0===e.length?"Нет сохранённых категорий. Если создаёшь новую категорию, убедись, что она отличается от существующих и не дублирует темы других рубрик.":e.slice(0,12).map(e=>`Категория "${e.name}":
✅ ОТНОСИТСЯ: Материал, где эта тема является основной, и большинство ключевых фактов напрямую описывают именно её.
❌ НЕ ОТНОСИТСЯ: Если категория упомянута лишь вскользь или как фон, а основная тема относится к другой рубрике.
❌ НЕ ОТНОСИТСЯ: Если материал относится к другой специализации (например, военные действия, экономика, культура).`).join("\n\n"),d=e=>0===e.length?"Нет сохранённых примеров. Используй здравый смысл и чётко сопоставляй содержание статье с определённой категорией.":e.map(e=>{let t=p(e.summary)||p(e.content)?.slice(0,220)||"нет краткого описания";return`Заголовок: ${e.title}
Категория: ${e.category}
Краткое описание: ${t}`}).join("\n\n"),y=async e=>{let{apiKey:t,model:r,articleText:n,materialTitle:a}=e,o=[a?`Заголовок: ${a}`:null,"Текст статьи:",n,"Определи надкатегорию (только из списка).","Верни JSON формата:",`{
  "supercategory": "Внутренняя Украина | Международное | Общее",
  "reasoning": "почему выбран этот вариант",
  "confidence": 0.82
}`,"Только чистый JSON."].filter(Boolean).join("\n\n"),m=c((await (0,i.A)(t,r,'Ты — аналитик новостного портала. Твоя задача — определить надкатегорию материала для дальнейшей точной классификации.\nВозможные надкатегории:\n- "Внутренняя Украина" — события внутри страны, управление, экономика, общество.\n- "Международное" — внешняя политика, международные отношения, глобальные события, влияющие на Украину.\n- "Общее" — материалы общего характера, которые не попадают в первые два типа (например, технологии, культура глобально).\nВсегда возвращай JSON с ключами: supercategory, reasoning, confidence (0..1).',o,{maxTokens:512,temperature:.2})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim()),d=p(m.supercategory);return{supercategory:s.find(e=>u(e)===u(d))??null,reasoning:p(m.reasoning),confidence:l(m.confidence,.6)}},g=async e=>{let{apiKey:t,model:r,articleText:n,categories:a,examples:o,supercategory:s,materialTitle:u}=e,y=m(a),g=d(o),f=["Ты — опытный редактор по классификации материалов.","Список доступных категорий (используй точное написание):",(a.length>0?a.map(e=>e.name).sort((e,t)=>e.localeCompare(t,"ru")):["(Категории не заданы — при необходимости предложи новую формулировку)"]).map(e=>`- ${e}`).join("\n"),"Как отличать категории: ",y,"Примеры из архива (ориентируйся на стиль и тематику):",g,"Если нет точного соответствия, предложи новую категорию, но поясни, чем она отличается."].filter(Boolean).join("\n\n"),h=[u?`Заголовок: ${u}`:null,s?`Определённая надкатегория: ${s}. Убедись, что финальная категория совместима с этой надкатегорией.`:"Надкатегорию определить не удалось — выбери наиболее подходящую категорию.","Проанализируй статью и определи категорию. Используй пошаговый анализ.","СТАТЬЯ:",n,"ПОШАГОВЫЙ АНАЛИЗ:","Шаг 1: О чем статья одним предложением?","Шаг 2: Есть ли украинский контекст? (да/нет и почему)","Шаг 3: Какие ключевые слова присутствуют?","Шаг 4: К какой категории относится?","Шаг 5: Почему именно эта категория, а не другие похожие?","Верни JSON:",`{
  "step1_summary": "...",
  "step2_ukrainian_context": "да/нет, потому что...",
  "step3_keywords": ["слово1", "слово2"],
  "step4_category": "Название категории",
  "step5_reasoning": "Объяснение выбора и почему не другие категории",
  "confidence": 0.95
}`,"Только чистый JSON без markdown."].filter(Boolean).join("\n\n"),w=c((await (0,i.A)(t,r,f,h,{maxTokens:1024,temperature:.3})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim());return{category:p(w.step4_category)||null,confidence:l(w.confidence,.6),reasoning:w}},f=async e=>{let{apiKey:t,model:r,articleText:n,proposedCategory:a,supercategory:o,materialTitle:s}=e,u=[s?`Заголовок: ${s}`:null,`Предложенная категория: ${a||"не указана"}`,o?`Надкатегория: ${o}`:null,"ПРОЧИТАЙ СТАТЬЮ:",n,"Верни JSON:",`{
  "category": "Название категории или предыдущая, если согласен",
  "confidence": 0.8,
  "comment": "пояснение оценки"
}`,"Только чистый JSON."].filter(Boolean).join("\n\n"),m=c((await (0,i.A)(t,r,"Ты — редактор, который перепроверяет корректность выбранной категории.\nЕсли категория не подходит, предложи альтернативу и объясни расхождение.",u,{maxTokens:512,temperature:.2})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim());return{category:p(m.category)||a||null,confidence:l(m.confidence,.5),comment:p(m.comment)}},h=async e=>{let{materialId:t,articleText:r,materialTitle:a,categories:o,examples:i,claudeApiKey:s,claudeModel:c}=e;if(!s)return null;try{let e,l;let p=await y({apiKey:s,model:c,articleText:r,materialTitle:a}),m=await g({apiKey:s,model:c,articleText:r,categories:o,examples:i,supercategory:p.supercategory,materialTitle:a}),d=m.category,h=m.confidence,w=null;if(m.confidence<.75){let t=await f({apiKey:s,model:c,articleText:r,proposedCategory:d,supercategory:p.supercategory,materialTitle:a});w=t.category,e=t.confidence,l=t.comment,t.category&&u(t.category)!==u(d||"")?(d=t.category,h=Math.max(t.confidence,.9*h)):t.confidence>h&&(h=t.confidence)}return await n.db.createCategorizationLog({materialId:t,supercategory:p.supercategory??void 0,predictedCategory:m.category??void 0,validationCategory:w??void 0,confidence:m.confidence,validationConfidence:e,reasoning:{supercategory_reasoning:p.reasoning,classification:m.reasoning,validation_comment:l},metadata:{final_category:d,final_confidence:h}}),{category:d,confidence:h,reasoning:m.reasoning,supercategory:p.supercategory??null,validationCategory:w,validationConfidence:e,validationComment:l}}catch(e){return console.error("Advanced category classification failed:",e),await n.db.createCategorizationLog({materialId:t,predictedCategory:void 0,confidence:0,reasoning:{error:e instanceof Error?e.message:String(e)}}),null}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972,345,435],()=>r(7514));module.exports=n})();