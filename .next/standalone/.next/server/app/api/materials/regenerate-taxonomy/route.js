"use strict";(()=>{var e={};e.id=730,e.ids=[730],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},768:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>P,patchFetch:()=>S,requestAsyncStorage:()=>b,routeModule:()=>I,serverHooks:()=>k,staticGenerationAsyncStorage:()=>_});var o={};r.r(o),r.d(o,{POST:()=>O});var n=r(9303),a=r(8716),i=r(670),s=r(7070),l=r(9487),c=r(5392),u=r(7408),p=r(2908);async function d(e,t,r){let o=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!o.ok){let e=await o.text();throw Error(`Gemini API error: ${o.status} - ${e}`)}let n=await o.json();return n.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let y=["claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function m(e,t,r,o){let n=new c.ZP({apiKey:e}),a=t||y[0],i=new Set,s=[a,...y].filter(e=>!i.has(e)&&(i.add(e),!0)),u=null;for(let e of s)try{let t=await n.messages.create({model:e,max_tokens:4096,system:r||void 0,messages:[{role:"user",content:o}]}),i=("text"===t.content[0].type?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==a)try{await l.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return i}catch(a){let t=a?.error?.message||a?.message||"Unknown error",r=a?.error?.type||a?.type||"unknown",o=a?.status??a?.response?.status,n="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===o||n.includes("not found")||n.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),u=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(u?.message||"Claude API error: нет доступных моделей для выполнения запроса")}let f=e=>(e??"").normalize("NFKC").trim().toLowerCase(),g=e=>"string"==typeof e?e.trim():"",h=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),o=t.lastIndexOf("}");return -1===r||-1===o||o<=r?null:t.slice(r,o+1)},x=e=>["Страны и города: "+(e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"]).join(" | "),"Если подходящего значения нет, предложи новое аккуратное название."].join("\n"),w=`Верни только JSON объект со следующей структурой:
{
  "country": "название страны" или null,
  "city": "название города" или null
}`,j={country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function O(e){try{let t;let{materialId:r}=await e.json();if(!r)return s.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let o=await l.db.getMaterialById(r);if(!o)return s.NextResponse.json({success:!1,error:"Material not found"},{status:404});let n=await l.db.getSettings(),a=n.ai_provider||"gemini",i=n.gemini_api_key,c=n.claude_api_key,y=n.gemini_model||"gemini-2.5-flash",O=n.claude_model||"claude-3-haiku-20240307",I="claude"===a?c:i;if(!I)return s.NextResponse.json({success:!1,error:`API key for ${a} is not configured`},{status:400});let b=await l.db.getTaxonomy(),_=x(b.countries),k=n.taxonomy_system_prompt||"Ты — редактор аналитического портала. Определи страну и города статьи так, чтобы они помогали редакции быстро рубрицировать материалы.",P=n.taxonomy_prompt_country||j.country,S=n.taxonomy_prompt_city||j.city,N=n.taxonomy_format_prompt||w,$=o.fullContent||o.content||"",C=$.length>15e3?$.slice(0,15e3)+"...":$,v=[k,`ПРАВИЛА ДЛЯ КАЖДОГО ТИПА:`,`Страна: ${P}`,`Город: ${S}`,"КОНТЕКСТ ДОСТУПНЫХ ЗНАЧЕНИЙ:",_].filter(Boolean).join("\n\n"),A=["Определи страну и города, связанные со статьёй.","","СТАТЬЯ:",`Заголовок: ${o.title}`,`Содержание: ${C}`,"","ФОРМАТ ОТВЕТА:",N,"","Только чистый JSON без markdown и дополнительного текста."].join("\n"),F=[v,A].filter(Boolean).join("\n\n"),M=await ("claude"===a?m(I,O,v,A):d(I,y,F)),J=h(M);if(!J)throw Error("Failed to extract JSON from AI response");try{t=JSON.parse(J)}catch(r){let e=null;try{t=u.Z.parse(J)}catch(o){e=o;try{let e=(0,p.K)(J);t=JSON.parse(e)}catch(t){throw console.error("Failed to parse taxonomy JSON:",t,"JSON5 error:",e,"Original error:",r,"Payload:",J),Error("Failed to parse taxonomy JSON from AI response")}}}let R=g(t.country),T=g(t.city),E=Object.prototype.hasOwnProperty.call(t,"country"),q=Object.prototype.hasOwnProperty.call(t,"city"),B={},K=new Map;for(let e of b.countries)K.set(f(e.name),{...e,cities:e.cities??[]});let U=[],D=[],G=E,L=async e=>{let t=f(e);if(0===t.length)return null;let r=K.get(t);if(r)return r;try{let r=await l.db.createTaxonomyItem("country",e);if(r){let e={...r,cities:[]};return K.set(t,e),b.countries.push(e),e}}catch(t){console.error("Failed to create country:",e,t)}return null},Z=new Map;for(let e of b.countries)for(let t of e.cities??[]){let e=f(t.name);Z.has(e)||Z.set(e,[]),Z.get(e).push(t)}let z=async(e,t)=>{let r=f(e);if(0===r.length)return null;let o=Z.get(r)??[];if(o.length>0){let e=o.find(e=>!t||e.countryId===t)??o[0];return t&&e.countryId!==t&&!U.includes(e.countryId)&&(U.push(e.countryId),G=!0),e}if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let n=await l.db.createTaxonomyItem("city",e,{countryId:t});Z.has(r)||Z.set(r,[]),Z.get(r).push(n);let a=b.countries.find(e=>e.id===t);return a&&(a.cities=[...a.cities??[],n]),n};if(E&&R){let e=await L(R);e&&U.push(e.id)}if(q&&T){let e=null;if(R){let t=U[0]??null;e=await z(T,t)}else{let t=f(T);for(let r of b.countries){let o=(r.cities??[]).find(e=>f(e.name)===t);if(o){e=o,U.includes(r.id)||U.push(r.id);break}}e||console.warn(`City "${T}" cannot be resolved without country reference. Skipping.`)}e&&(D.includes(e.id)||D.push(e.id),U.includes(e.countryId)||U.push(e.countryId),G=!0)}if(G&&(B.countryIds=U),q&&(B.cityIds=D),Object.prototype.hasOwnProperty.call(B,"countryIds")||Object.prototype.hasOwnProperty.call(B,"cityIds"))try{await l.db.updateMaterialTaxonomy(r,B)}catch(e){return console.error("Failed to update taxonomy for material:",r,B,e),s.NextResponse.json({success:!1,error:"Failed to update taxonomy"},{status:500})}let H=await l.db.getMaterialById(r);return s.NextResponse.json({success:!0,data:{material:H,taxonomy:B}})}catch(e){return console.error("Error regenerating taxonomy:",e),s.NextResponse.json({success:!1,error:"Failed to regenerate taxonomy"},{status:500})}}let I=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/materials/regenerate-taxonomy/route",pathname:"/api/materials/regenerate-taxonomy",filename:"route",bundlePath:"app/api/materials/regenerate-taxonomy/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/regenerate-taxonomy/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:b,staticGenerationAsyncStorage:_,serverHooks:k}=I,P="/api/materials/regenerate-taxonomy/route";function S(){return(0,i.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:_})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[948,972,345,487],()=>r(768));module.exports=o})();