"use strict";(()=>{var e={};e.id=730,e.ids=[730],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},768:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>N,patchFetch:()=>S,requestAsyncStorage:()=>j,routeModule:()=>w,serverHooks:()=>$,staticGenerationAsyncStorage:()=>_});var n={};r.r(n),r.d(n,{POST:()=>x});var a=r(9303),o=r(8716),i=r(670),s=r(7070),c=r(9487),l=r(5506),u=r(1456);async function g(e,t,r){let n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!n.ok){let e=await n.text();throw Error(`Gemini API error: ${n.status} - ${e}`)}let a=await n.json();return a.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let d=e=>(e??"").normalize("NFKC").trim().toLowerCase(),p=e=>"string"==typeof e?e.trim():"",y=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),n=t.lastIndexOf("}");return -1===r||-1===n||n<=r?null:t.slice(r,n+1)},m=(e,t)=>{let r=e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"],n=t.length>0?t.map(e=>e.name).join(", "):"(пока нет категорий)";return["Страны и города: "+r.join(" | "),"Категории: "+n,"Если подходящего значения нет, предложи новое аккуратное название."].join("\n")},f=`Верни только JSON объект со следующей структурой:
{
  "categories": ["название категории"],
  "country": "название страны" или null,
  "city": "название города" или null
}`,h={category:"Выбери одну или несколько категорий, которые наилучшим образом описывают материал. Если подходящей категории нет, предложи новую аккуратную формулировку.",country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function x(e){try{let t;let{materialId:r}=await e.json();if(!r)return s.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let n=await c.db.getMaterialById(r);if(!n)return s.NextResponse.json({success:!1,error:"Material not found"},{status:404});let a=await c.db.getSettings(),o=a.ai_provider||"gemini",i=a.gemini_api_key,x=a.claude_api_key,w=a.gemini_model||"gemini-2.5-flash",j=a.claude_model||u.y[0],_="claude"===o?x:i;if(!_)return s.NextResponse.json({success:!1,error:`${"claude"===o?"Claude":"Gemini"} API ключ не настроен. Перейдите в Настройки.`},{status:400});let $=await c.db.getTaxonomy(),N=m($.countries,$.categories),S=a.taxonomy_system_prompt||"Ты — редактор аналитического портала. Определи подходящие категории, а также страну и города, чтобы редакция могла быстро рубрицировать материалы.",C=a.taxonomy_prompt_category||h.category,O=a.taxonomy_prompt_country||h.country,k=a.taxonomy_prompt_city||h.city,b=a.taxonomy_format_prompt||f,v=n.fullContent||n.content||"",I=v.length>15e3?v.slice(0,15e3)+"...":v,A=[S,"ПРАВИЛА ДЛЯ КАЖДОГО ТИПА:",`Категория: ${C}`,`Страна: ${O}`,`Город: ${k}`,"КОНТЕКСТ ДОСТУПНЫХ ЗНАЧЕНИЙ:",N].filter(Boolean).join("\n\n"),E=["Определи категории, страну и города, связанные со статьёй.","","СТАТЬЯ:",`Заголовок: ${n.title}`,`Содержание: ${I}`,"","ФОРМАТ ОТВЕТА:",b,"","Только чистый JSON без markdown и дополнительного текста."].join("\n"),J=[A,E].filter(Boolean).join("\n\n"),T=await ("claude"===o?(0,u.A)(_,j,A,E):g(_,w,J)),F=y(T);if(!F)throw Error("Failed to extract JSON from AI response");try{t=(0,l.Vu)(F)}catch(e){throw console.error("Failed to parse taxonomy JSON:",e,"Payload:",F),Error("Failed to parse taxonomy JSON from AI response")}let P=Array.isArray(t.categories)?t.categories:[],M=t.country?p(t.country):"",R=t.city?p(t.city):"",B=I||n.content||"",q=await c.db.getCategoryExamples(15),K=await (0,l.D2)({materialId:r,articleText:B,materialTitle:n.title,categories:$.categories,examples:q,claudeApiKey:x,claudeModel:j}),L=[...K?.category?[K.category]:[],...P].map(e=>p(e)).filter(e=>e.length>0),z={},D=[],G=[],U=[],V=new Map;$.categories.forEach(e=>{V.set(d(e.name),e)});let Z=async e=>{let t=d(e);if(0===t.length)return null;let r=V.get(t);if(r)return r;try{let r=await c.db.createTaxonomyItem("category",e);return V.set(t,r),$.categories.push(r),r}catch(t){return console.error("Failed to create category:",e,t),null}},H=new Map;$.countries.forEach(e=>{H.set(d(e.name),{...e,cities:e.cities??[]})});let X=new Map;$.countries.forEach(e=>{(e.cities??[]).forEach(e=>{let t=d(e.name);X.has(t)||X.set(t,[]),X.get(t).push(e)})});let Q=async e=>{let t=d(e);if(0===t.length)return null;let r=H.get(t);if(r)return r;let n={...await c.db.createTaxonomyItem("country",e),cities:[]};return H.set(t,n),$.countries.push(n),n},W=async(e,t)=>{let r=d(e);if(0===r.length)return null;let n=X.get(r)??[];if(n.length>0)return n.find(e=>!t||e.countryId===t)??n[0];if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let a=await c.db.createTaxonomyItem("city",e,{countryId:t});X.has(r)||X.set(r,[]),X.get(r).push(a);let o=$.countries.find(e=>e.id===t);return o&&(o.cities=[...o.cities??[],a]),a};if(L.length>0){for(let e of L)try{let t=await Z(e);t&&!D.includes(t.id)&&D.push(t.id)}catch(t){console.error("Failed to ensure category:",e,t)}z.categoryIds=D}if(M)try{let e=await Q(M);e&&!G.includes(e.id)&&G.push(e.id)}catch(e){console.error("Failed to ensure country:",M,e)}if(R)try{let e=G[0]??null,t=await W(R,e);t&&(U.includes(t.id)||U.push(t.id),G.includes(t.countryId)||G.push(t.countryId))}catch(e){console.error("Failed to ensure city:",R,e)}if(G.length>0&&(z.countryIds=G),U.length>0&&(z.cityIds=U),0===Object.keys(z).length)return s.NextResponse.json({success:!0,data:{material:n,classification:K?{category:K.category,confidence:K.confidence,supercategory:K.supercategory??null,reasoning:K.reasoning}:null}});await c.db.updateMaterialTaxonomy(r,z);let Y=await c.db.getMaterialById(r);return s.NextResponse.json({success:!0,data:{material:Y,classification:K?{category:K.category,confidence:K.confidence,supercategory:K.supercategory??null,reasoning:K.reasoning}:null}})}catch(e){return console.error("Error regenerating taxonomy:",e),s.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to regenerate taxonomy"},{status:500})}}let w=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/materials/regenerate-taxonomy/route",pathname:"/api/materials/regenerate-taxonomy",filename:"route",bundlePath:"app/api/materials/regenerate-taxonomy/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/regenerate-taxonomy/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:j,staticGenerationAsyncStorage:_,serverHooks:$}=w,N="/api/materials/regenerate-taxonomy/route";function S(){return(0,i.patchFetch)({serverHooks:$,staticGenerationAsyncStorage:_})}},1456:(e,t,r)=>{r.d(t,{A:()=>i,y:()=>o});var n=r(5392),a=r(9487);let o=["claude-sonnet-4-20250514","claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function i(e,t,r,i,s){let c=new n.ZP({apiKey:e}),l=t||o[0],u=new Set,g=[l,...o].filter(e=>!u.has(e)&&(u.add(e),!0)),d=null;for(let e of g)try{let t=await c.messages.create({model:e,max_tokens:s?.maxTokens??4096,temperature:s?.temperature,system:r||void 0,messages:[{role:"user",content:i}]}),n=(t.content[0]?.type==="text"?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==l)try{await a.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return n}catch(o){let t=o?.error?.message||o?.message||"Unknown error",r=o?.error?.type||o?.type||"unknown",n=o?.status??o?.response?.status,a="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===n||a.includes("not found")||a.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),d=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(d?.message||"Claude API error: нет доступных моделей для выполнения запроса")}},5506:(e,t,r)=>{r.d(t,{D2:()=>h,Vu:()=>c});var n=r(9487),a=r(7408),o=r(2908),i=r(1456);let s=["Внутренняя Украина","Международное","Общее"],c=e=>{try{return JSON.parse(e)}catch(r){let t=null;try{return a.Z.parse(e)}catch(n){t=n;try{let t=(0,o.K)(e);return JSON.parse(t)}catch(e){throw Error(`Failed to parse JSON. First error: ${r.message}. JSON5 error: ${t instanceof Error?t.message:t}. Repair error: ${e instanceof Error?e.message:e}`)}}}},l=(e,t=.5)=>{let r="number"==typeof e?e:Number(e);return Number.isFinite(r)?r<0?0:r>1?1:r:t},u=e=>(e??"").normalize("NFKC").trim().toLowerCase(),g=e=>"string"==typeof e?e.trim():"",d=e=>0===e.length?"Нет сохранённых категорий. Если создаёшь новую категорию, убедись, что она отличается от существующих и не дублирует темы других рубрик.":e.slice(0,12).map(e=>`Категория "${e.name}":
✅ ОТНОСИТСЯ: Материал, где эта тема является основной, и большинство ключевых фактов напрямую описывают именно её.
❌ НЕ ОТНОСИТСЯ: Если категория упомянута лишь вскользь или как фон, а основная тема относится к другой рубрике.
❌ НЕ ОТНОСИТСЯ: Если материал относится к другой специализации (например, военные действия, экономика, культура).`).join("\n\n"),p=e=>0===e.length?"Нет сохранённых примеров. Используй здравый смысл и чётко сопоставляй содержание статье с определённой категорией.":e.map(e=>{let t=g(e.summary)||g(e.content)?.slice(0,220)||"нет краткого описания";return`Заголовок: ${e.title}
Категория: ${e.category}
Краткое описание: ${t}`}).join("\n\n"),y=async e=>{let{apiKey:t,model:r,articleText:n,materialTitle:a}=e,o=[a?`Заголовок: ${a}`:null,"Текст статьи:",n,"Определи надкатегорию (только из списка).","Верни JSON формата:",`{
  "supercategory": "Внутренняя Украина | Международное | Общее",
  "reasoning": "почему выбран этот вариант",
  "confidence": 0.82
}`,"Только чистый JSON."].filter(Boolean).join("\n\n"),d=c((await (0,i.A)(t,r,'Ты — аналитик новостного портала. Твоя задача — определить надкатегорию материала для дальнейшей точной классификации.\nВозможные надкатегории:\n- "Внутренняя Украина" — события внутри страны, управление, экономика, общество.\n- "Международное" — внешняя политика, международные отношения, глобальные события, влияющие на Украину.\n- "Общее" — материалы общего характера, которые не попадают в первые два типа (например, технологии, культура глобально).\nВсегда возвращай JSON с ключами: supercategory, reasoning, confidence (0..1).',o,{maxTokens:512,temperature:.2})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim()),p=g(d.supercategory);return{supercategory:s.find(e=>u(e)===u(p))??null,reasoning:g(d.reasoning),confidence:l(d.confidence,.6)}},m=async e=>{let{apiKey:t,model:r,articleText:n,categories:a,examples:o,supercategory:s,materialTitle:u}=e,y=d(a),m=p(o),f=["Ты — опытный редактор по классификации материалов.","Список доступных категорий (используй точное написание):",(a.length>0?a.map(e=>e.name).sort((e,t)=>e.localeCompare(t,"ru")):["(Категории не заданы — при необходимости предложи новую формулировку)"]).map(e=>`- ${e}`).join("\n"),"Как отличать категории: ",y,"Примеры из архива (ориентируйся на стиль и тематику):",m,"Если нет точного соответствия, предложи новую категорию, но поясни, чем она отличается."].filter(Boolean).join("\n\n"),h=[u?`Заголовок: ${u}`:null,s?`Определённая надкатегория: ${s}. Убедись, что финальная категория совместима с этой надкатегорией.`:"Надкатегорию определить не удалось — выбери наиболее подходящую категорию.","Проанализируй статью и определи категорию. Используй пошаговый анализ.","СТАТЬЯ:",n,"ПОШАГОВЫЙ АНАЛИЗ:","Шаг 1: О чем статья одним предложением?","Шаг 2: Есть ли украинский контекст? (да/нет и почему)","Шаг 3: Какие ключевые слова присутствуют?","Шаг 4: К какой категории относится?","Шаг 5: Почему именно эта категория, а не другие похожие?","Верни JSON:",`{
  "step1_summary": "...",
  "step2_ukrainian_context": "да/нет, потому что...",
  "step3_keywords": ["слово1", "слово2"],
  "step4_category": "Название категории",
  "step5_reasoning": "Объяснение выбора и почему не другие категории",
  "confidence": 0.95
}`,"Только чистый JSON без markdown."].filter(Boolean).join("\n\n"),x=c((await (0,i.A)(t,r,f,h,{maxTokens:1024,temperature:.3})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim());return{category:g(x.step4_category)||null,confidence:l(x.confidence,.6),reasoning:x}},f=async e=>{let{apiKey:t,model:r,articleText:n,proposedCategory:a,supercategory:o,materialTitle:s}=e,u=[s?`Заголовок: ${s}`:null,`Предложенная категория: ${a||"не указана"}`,o?`Надкатегория: ${o}`:null,"ПРОЧИТАЙ СТАТЬЮ:",n,"Верни JSON:",`{
  "category": "Название категории или предыдущая, если согласен",
  "confidence": 0.8,
  "comment": "пояснение оценки"
}`,"Только чистый JSON."].filter(Boolean).join("\n\n"),d=c((await (0,i.A)(t,r,"Ты — редактор, который перепроверяет корректность выбранной категории.\nЕсли категория не подходит, предложи альтернативу и объясни расхождение.",u,{maxTokens:512,temperature:.2})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim());return{category:g(d.category)||a||null,confidence:l(d.confidence,.5),comment:g(d.comment)}},h=async e=>{let{materialId:t,articleText:r,materialTitle:a,categories:o,examples:i,claudeApiKey:s,claudeModel:c}=e;if(!s)return null;try{let e,l;let g=await y({apiKey:s,model:c,articleText:r,materialTitle:a}),d=await m({apiKey:s,model:c,articleText:r,categories:o,examples:i,supercategory:g.supercategory,materialTitle:a}),p=d.category,h=d.confidence,x=null;if(d.confidence<.75){let t=await f({apiKey:s,model:c,articleText:r,proposedCategory:p,supercategory:g.supercategory,materialTitle:a});x=t.category,e=t.confidence,l=t.comment,t.category&&u(t.category)!==u(p||"")?(p=t.category,h=Math.max(t.confidence,.9*h)):t.confidence>h&&(h=t.confidence)}return await n.db.createCategorizationLog({materialId:t,supercategory:g.supercategory??void 0,predictedCategory:d.category??void 0,validationCategory:x??void 0,confidence:d.confidence,validationConfidence:e,reasoning:{supercategory_reasoning:g.reasoning,classification:d.reasoning,validation_comment:l},metadata:{final_category:p,final_confidence:h}}),{category:p,confidence:h,reasoning:d.reasoning,supercategory:g.supercategory??null,validationCategory:x,validationConfidence:e,validationComment:l}}catch(e){return console.error("Advanced category classification failed:",e),await n.db.createCategorizationLog({materialId:t,predictedCategory:void 0,confidence:0,reasoning:{error:e instanceof Error?e.message:String(e)}}),null}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972,345,487],()=>r(768));module.exports=n})();