"use strict";(()=>{var e={};e.id=730,e.ids=[730],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},768:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>S,requestAsyncStorage:()=>$,routeModule:()=>j,serverHooks:()=>N,staticGenerationAsyncStorage:()=>_});var n={};r.r(n),r.d(n,{POST:()=>w});var a=r(9303),o=r(8716),i=r(670),s=r(7070),c=r(9487),l=r(5506),u=r(1456),g=r(7435);async function p(e,t,r){let n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent`,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{temperature:.4,responseMimeType:"application/json"}})});if(!n.ok){let e=await n.text();throw Error(`Gemini API error: ${n.status} - ${e}`)}let a=await n.json();return a.candidates?.[0]?.content?.parts?.map(e=>e.text??"").join("").trim()??""}let d=e=>(e??"").normalize("NFKC").trim().toLowerCase(),m=e=>"string"==typeof e?e.trim():"",y=e=>{if(!e)return null;let t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),r=t.indexOf("{"),n=t.lastIndexOf("}");return -1===r||-1===n||n<=r?null:t.slice(r,n+1)},f=(e,t)=>{let r=e.length>0?e.map(e=>{let t=(e.cities??[]).map(e=>e.name);return t.length>0?`${e.name}: ${t.join(", ")}`:e.name}):["(пока нет сохранённых стран)"],n=t.length>0?t.map(e=>e.name).join(", "):"(пока нет категорий)";return["Страны и города: "+r.join(" | "),"Категории: "+n,"Если подходящего значения нет, предложи новое аккуратное название."].join("\n")},h=`Верни только JSON объект со следующей структурой:
{
  "categories": ["название категории"],
  "country": "название страны" или null,
  "city": "название города" или null
}`,x={category:"Выбери одну или несколько категорий, которые наилучшим образом описывают материал. Если подходящей категории нет, предложи новую аккуратную формулировку.",country:"Выбери страну, если материал ясно связан с конкретным государством.",city:"Укажи город, если он явно присутствует в материале и важен для контекста."};async function w(e){let t;try{let r,n;let{materialId:a}=await e.json();if(t="string"==typeof a?a:void 0,!a)return s.NextResponse.json({success:!1,error:"Material ID is required"},{status:400});let o=await c.db.getMaterialById(a);if(!o)return s.NextResponse.json({success:!1,error:"Material not found"},{status:404});let i=await c.db.getSettings(),w=i.ai_provider||"gemini",j=i.gemini_api_key,$=i.claude_api_key,_=i.gemini_model||"gemini-2.5-flash",N=i.claude_model||u.y[0],v="claude"===w?$:j;if(!v)return s.NextResponse.json({success:!1,error:`${"claude"===w?"Claude":"Gemini"} API ключ не настроен. Перейдите в Настройки.`},{status:400});let S=await c.db.getTaxonomy(),C=f(S.countries,S.categories),I=i.taxonomy_system_prompt||"Ты — редактор аналитического портала. Определи подходящие категории, а также страну и города, чтобы редакция могла быстро рубрицировать материалы.",O=i.taxonomy_prompt_category||x.category,k=i.taxonomy_prompt_country||x.country,b=i.taxonomy_prompt_city||x.city,A=i.taxonomy_format_prompt||h,E=o.fullContent||o.content||"",J=E.length>15e3?E.slice(0,15e3)+"...":E,P=[I,"ПРАВИЛА ДЛЯ КАЖДОГО ТИПА:",`Категория: ${O}`,`Страна: ${k}`,`Город: ${b}`,"КОНТЕКСТ ДОСТУПНЫХ ЗНАЧЕНИЙ:",C].filter(Boolean).join("\n\n"),T=["Определи категории, страну и города, связанные со статьёй.","","СТАТЬЯ:",`Заголовок: ${o.title}`,`Содержание: ${J}`,"","ФОРМАТ ОТВЕТА:",A,"","Только чистый JSON без markdown и дополнительного текста."].join("\n"),F=[P,T].filter(Boolean).join("\n\n");try{r=await ("claude"===w?(0,u.A)(v,N,P,T):p(v,_,F))}catch(t){console.error(`Error calling ${w} API:`,t),await (0,g.r)("api/materials/regenerate-taxonomy",t,{materialId:a,provider:w,phase:"call-model"});let e=t instanceof Error?t.message:"Не удалось обратиться к AI";return s.NextResponse.json({success:!1,error:`Ошибка при обращении к ${"claude"===w?"Claude":"Gemini"} API: ${e}`},{status:500})}let R=y(r);if(!R)return await (0,g.r)("api/materials/regenerate-taxonomy","Invalid AI response format",{materialId:a,provider:w,phase:"extract-json",responsePreview:r.slice(0,2e3)}),s.NextResponse.json({success:!1,error:"AI не вернул корректный JSON ответ"},{status:500});try{n=(0,l.Vu)(R)}catch(e){return console.error("Failed to parse taxonomy JSON:",e,"Payload:",R),await (0,g.r)("api/materials/regenerate-taxonomy",e,{materialId:a,provider:w,phase:"parse-json",payloadSnippet:R.slice(0,2e3)}),s.NextResponse.json({success:!1,error:"Не удалось разобрать JSON от нейросети"},{status:500})}let M=Array.isArray(n.categories)?n.categories:[],B=n.country?m(n.country):"",q=n.city?m(n.city):"",K=J||o.content||"",L=await c.db.getCategoryExamples(15),z=await (0,l.D2)({materialId:a,articleText:K,materialTitle:o.title,categories:S.categories,examples:L,claudeApiKey:$,claudeModel:N}),D=[...z?.category?[z.category]:[],...M].map(e=>m(e)).filter(e=>e.length>0),G={},U=[],V=[],Z=[],H=new Map;S.categories.forEach(e=>{H.set(d(e.name),e)});let X=async e=>{let t=d(e);if(0===t.length)return null;let r=H.get(t);if(r)return r;try{let r=await c.db.createTaxonomyItem("category",e);return H.set(t,r),S.categories.push(r),r}catch(t){return console.error("Failed to create category:",e,t),null}},Q=new Map;S.countries.forEach(e=>{Q.set(d(e.name),{...e,cities:e.cities??[]})});let W=new Map;S.countries.forEach(e=>{(e.cities??[]).forEach(e=>{let t=d(e.name);W.has(t)||W.set(t,[]),W.get(t).push(e)})});let Y=async e=>{let t=d(e);if(0===t.length)return null;let r=Q.get(t);if(r)return r;let n={...await c.db.createTaxonomyItem("country",e),cities:[]};return Q.set(t,n),S.countries.push(n),n},ee=async(e,t)=>{let r=d(e);if(0===r.length)return null;let n=W.get(r)??[];if(n.length>0)return n.find(e=>!t||e.countryId===t)??n[0];if(!t)return console.warn(`City "${e}" cannot be created without a country reference. Skipping.`),null;let a=await c.db.createTaxonomyItem("city",e,{countryId:t});W.has(r)||W.set(r,[]),W.get(r).push(a);let o=S.countries.find(e=>e.id===t);return o&&(o.cities=[...o.cities??[],a]),a};if(D.length>0){for(let e of D)try{let t=await X(e);t&&!U.includes(t.id)&&U.push(t.id)}catch(t){console.error("Failed to ensure category:",e,t)}G.categoryIds=U}if(B)try{let e=await Y(B);e&&!V.includes(e.id)&&V.push(e.id)}catch(e){console.error("Failed to ensure country:",B,e)}if(q)try{let e=V[0]??null,t=await ee(q,e);t&&(Z.includes(t.id)||Z.push(t.id),V.includes(t.countryId)||V.push(t.countryId))}catch(e){console.error("Failed to ensure city:",q,e)}if(V.length>0&&(G.countryIds=V),Z.length>0&&(G.cityIds=Z),0===Object.keys(G).length)return s.NextResponse.json({success:!0,data:{material:o,classification:z?{category:z.category,confidence:z.confidence,supercategory:z.supercategory??null,reasoning:z.reasoning}:null}});await c.db.updateMaterialTaxonomy(a,G);let et=await c.db.getMaterialById(a);return s.NextResponse.json({success:!0,data:{material:et,classification:z?{category:z.category,confidence:z.confidence,supercategory:z.supercategory??null,reasoning:z.reasoning}:null}})}catch(e){return console.error("Error regenerating taxonomy:",e),await (0,g.r)("api/materials/regenerate-taxonomy",e,{materialId:t}),s.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to regenerate taxonomy"},{status:500})}}let j=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/materials/regenerate-taxonomy/route",pathname:"/api/materials/regenerate-taxonomy",filename:"route",bundlePath:"app/api/materials/regenerate-taxonomy/route"},resolvedPagePath:"/Users/macbookpro/Desktop/syndicateadmin/app/api/materials/regenerate-taxonomy/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:$,staticGenerationAsyncStorage:_,serverHooks:N}=j,v="/api/materials/regenerate-taxonomy/route";function S(){return(0,i.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:_})}},1456:(e,t,r)=>{r.d(t,{A:()=>i,y:()=>o});var n=r(5392),a=r(9487);let o=["claude-sonnet-4-20250514","claude-3-5-sonnet-20240620","claude-3-haiku-20240307"];async function i(e,t,r,i,s){let c=new n.ZP({apiKey:e}),l=t||o[0],u=new Set,g=[l,...o].filter(e=>!u.has(e)&&(u.add(e),!0)),p=null;for(let e of g)try{let t=await c.messages.create({model:e,max_tokens:s?.maxTokens??4096,temperature:s?.temperature,system:r||void 0,messages:[{role:"user",content:i}]}),n=(t.content[0]?.type==="text"?t.content[0].text:"").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();if(e!==l)try{await a.db.setSetting("claude_model",e)}catch(e){console.warn("Не удалось сохранить новую модель Claude:",e)}return n}catch(o){let t=o?.error?.message||o?.message||"Unknown error",r=o?.error?.type||o?.type||"unknown",n=o?.status??o?.response?.status,a="string"==typeof t?t.toLowerCase():"";if("not_found_error"===r||404===n||a.includes("not found")||a.includes("model:")){console.warn(`Claude model "${e}" недоступна. Пробуем альтернативу.`),p=Error(`Модель ${e} недоступна`);continue}throw Error(`Claude API error: ${r} - ${t}`)}throw Error(p?.message||"Claude API error: нет доступных моделей для выполнения запроса")}},5506:(e,t,r)=>{r.d(t,{D2:()=>h,Vu:()=>c});var n=r(9487),a=r(7408),o=r(2908),i=r(1456);let s=["Внутренняя Украина","Международное","Общее"],c=e=>{try{return JSON.parse(e)}catch(r){let t=null;try{return a.Z.parse(e)}catch(n){t=n;try{let t=(0,o.K)(e);return JSON.parse(t)}catch(e){throw Error(`Failed to parse JSON. First error: ${r.message}. JSON5 error: ${t instanceof Error?t.message:t}. Repair error: ${e instanceof Error?e.message:e}`)}}}},l=(e,t=.5)=>{let r="number"==typeof e?e:Number(e);return Number.isFinite(r)?r<0?0:r>1?1:r:t},u=e=>(e??"").normalize("NFKC").trim().toLowerCase(),g=e=>"string"==typeof e?e.trim():"",p=e=>0===e.length?"Нет сохранённых категорий. Если создаёшь новую категорию, убедись, что она отличается от существующих и не дублирует темы других рубрик.":e.slice(0,12).map(e=>`Категория "${e.name}":
✅ ОТНОСИТСЯ: Материал, где эта тема является основной, и большинство ключевых фактов напрямую описывают именно её.
❌ НЕ ОТНОСИТСЯ: Если категория упомянута лишь вскользь или как фон, а основная тема относится к другой рубрике.
❌ НЕ ОТНОСИТСЯ: Если материал относится к другой специализации (например, военные действия, экономика, культура).`).join("\n\n"),d=e=>0===e.length?"Нет сохранённых примеров. Используй здравый смысл и чётко сопоставляй содержание статье с определённой категорией.":e.map(e=>{let t=g(e.summary)||g(e.content)?.slice(0,220)||"нет краткого описания";return`Заголовок: ${e.title}
Категория: ${e.category}
Краткое описание: ${t}`}).join("\n\n"),m=async e=>{let{apiKey:t,model:r,articleText:n,materialTitle:a}=e,o=[a?`Заголовок: ${a}`:null,"Текст статьи:",n,"Определи надкатегорию (только из списка).","Верни JSON формата:",`{
  "supercategory": "Внутренняя Украина | Международное | Общее",
  "reasoning": "почему выбран этот вариант",
  "confidence": 0.82
}`,"Только чистый JSON."].filter(Boolean).join("\n\n"),p=c((await (0,i.A)(t,r,'Ты — аналитик новостного портала. Твоя задача — определить надкатегорию материала для дальнейшей точной классификации.\nВозможные надкатегории:\n- "Внутренняя Украина" — события внутри страны, управление, экономика, общество.\n- "Международное" — внешняя политика, международные отношения, глобальные события, влияющие на Украину.\n- "Общее" — материалы общего характера, которые не попадают в первые два типа (например, технологии, культура глобально).\nВсегда возвращай JSON с ключами: supercategory, reasoning, confidence (0..1).',o,{maxTokens:512,temperature:.2})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim()),d=g(p.supercategory);return{supercategory:s.find(e=>u(e)===u(d))??null,reasoning:g(p.reasoning),confidence:l(p.confidence,.6)}},y=async e=>{let{apiKey:t,model:r,articleText:n,categories:a,examples:o,supercategory:s,materialTitle:u}=e,m=p(a),y=d(o),f=["Ты — опытный редактор по классификации материалов.","Список доступных категорий (используй точное написание):",(a.length>0?a.map(e=>e.name).sort((e,t)=>e.localeCompare(t,"ru")):["(Категории не заданы — при необходимости предложи новую формулировку)"]).map(e=>`- ${e}`).join("\n"),"Как отличать категории: ",m,"Примеры из архива (ориентируйся на стиль и тематику):",y,"Если нет точного соответствия, предложи новую категорию, но поясни, чем она отличается."].filter(Boolean).join("\n\n"),h=[u?`Заголовок: ${u}`:null,s?`Определённая надкатегория: ${s}. Убедись, что финальная категория совместима с этой надкатегорией.`:"Надкатегорию определить не удалось — выбери наиболее подходящую категорию.","Проанализируй статью и определи категорию. Используй пошаговый анализ.","СТАТЬЯ:",n,"ПОШАГОВЫЙ АНАЛИЗ:","Шаг 1: О чем статья одним предложением?","Шаг 2: Есть ли украинский контекст? (да/нет и почему)","Шаг 3: Какие ключевые слова присутствуют?","Шаг 4: К какой категории относится?","Шаг 5: Почему именно эта категория, а не другие похожие?","Верни JSON:",`{
  "step1_summary": "...",
  "step2_ukrainian_context": "да/нет, потому что...",
  "step3_keywords": ["слово1", "слово2"],
  "step4_category": "Название категории",
  "step5_reasoning": "Объяснение выбора и почему не другие категории",
  "confidence": 0.95
}`,"Только чистый JSON без markdown."].filter(Boolean).join("\n\n"),x=c((await (0,i.A)(t,r,f,h,{maxTokens:1024,temperature:.3})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim());return{category:g(x.step4_category)||null,confidence:l(x.confidence,.6),reasoning:x}},f=async e=>{let{apiKey:t,model:r,articleText:n,proposedCategory:a,supercategory:o,materialTitle:s}=e,u=[s?`Заголовок: ${s}`:null,`Предложенная категория: ${a||"не указана"}`,o?`Надкатегория: ${o}`:null,"ПРОЧИТАЙ СТАТЬЮ:",n,"Верни JSON:",`{
  "category": "Название категории или предыдущая, если согласен",
  "confidence": 0.8,
  "comment": "пояснение оценки"
}`,"Только чистый JSON."].filter(Boolean).join("\n\n"),p=c((await (0,i.A)(t,r,"Ты — редактор, который перепроверяет корректность выбранной категории.\nЕсли категория не подходит, предложи альтернативу и объясни расхождение.",u,{maxTokens:512,temperature:.2})).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim());return{category:g(p.category)||a||null,confidence:l(p.confidence,.5),comment:g(p.comment)}},h=async e=>{let{materialId:t,articleText:r,materialTitle:a,categories:o,examples:i,claudeApiKey:s,claudeModel:c}=e;if(!s)return null;try{let e,l;let g=await m({apiKey:s,model:c,articleText:r,materialTitle:a}),p=await y({apiKey:s,model:c,articleText:r,categories:o,examples:i,supercategory:g.supercategory,materialTitle:a}),d=p.category,h=p.confidence,x=null;if(p.confidence<.75){let t=await f({apiKey:s,model:c,articleText:r,proposedCategory:d,supercategory:g.supercategory,materialTitle:a});x=t.category,e=t.confidence,l=t.comment,t.category&&u(t.category)!==u(d||"")?(d=t.category,h=Math.max(t.confidence,.9*h)):t.confidence>h&&(h=t.confidence)}return await n.db.createCategorizationLog({materialId:t,supercategory:g.supercategory??void 0,predictedCategory:p.category??void 0,validationCategory:x??void 0,confidence:p.confidence,validationConfidence:e,reasoning:{supercategory_reasoning:g.reasoning,classification:p.reasoning,validation_comment:l},metadata:{final_category:d,final_confidence:h}}),{category:d,confidence:h,reasoning:p.reasoning,supercategory:g.supercategory??null,validationCategory:x,validationConfidence:e,validationComment:l}}catch(e){return console.error("Advanced category classification failed:",e),await n.db.createCategorizationLog({materialId:t,predictedCategory:void 0,confidence:0,reasoning:{error:e instanceof Error?e.message:String(e)}}),null}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972,345,435],()=>r(768));module.exports=n})();